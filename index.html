<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SLBDMIS | Team Portal</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* === THEME & LAYOUT === */
        :root { 
            --bg-body: #0d1117; 
            --bg-card: #161b22; 
            --bg-subtle: #21262d;
            --border: #30363d;
            --primary: #2f81f7; 
            --text-main: #f0f6fc;
            --text-sub: #8b949e;
            --sidebar-w: 260px;
            --nav-h: 70px;
        }

        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
            padding-bottom: 100px; /* Mobile safe area */
        }

        /* UTILITIES */
        .glass { background: rgba(22, 27, 34, 0.95); backdrop-filter: blur(10px); }
        .card-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
        }
        .text-xs { font-size: 0.75rem; }
        .fw-bold { font-weight: 600 !important; }
        .cursor-pointer { cursor: pointer; }
        
        /* STATUS BADGES */
        .badge-st { padding: 4px 8px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .st-done { background: rgba(35, 134, 54, 0.2); color: #3fb950; }
        .st-wait { background: rgba(210, 153, 34, 0.2); color: #d29922; }
        .st-rev { background: rgba(56, 139, 253, 0.2); color: #58a6ff; }
        .st-fut { background: rgba(139, 148, 158, 0.2); color: #8b949e; }

        /* === LAYOUT ELEMENTS === */
        /* 1. Login Overlay (Forces top layer) */
        #view-auth {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: var(--bg-body);
            z-index: 99999;
            display: flex; align-items: center; justify-content: center;
            padding: 20px;
        }
        .force-hide { display: none !important; }

        /* 2. Sidebar (Desktop) */
        .sidebar {
            position: fixed; top: 0; left: 0; bottom: 0;
            width: var(--sidebar-w);
            background: #010409;
            border-right: 1px solid var(--border);
            padding: 24px;
            display: none; flex-direction: column;
            z-index: 1000;
        }

        /* 3. Mobile Nav (Bottom) */
        .mobile-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: var(--nav-h);
            background: #010409;
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* 4. Content Area */
        .main-wrapper { padding: 20px; max-width: 100%; }

        /* Responsive Switching */
        @media (min-width: 992px) {
            .sidebar { display: flex; }
            .mobile-nav { display: none !important; }
            .mobile-header { display: none !important; }
            body { padding-bottom: 0; }
            .main-wrapper { margin-left: var(--sidebar-w); padding: 40px; }
        }

        /* Nav Items */
        .nav-item-d {
            display: flex; align-items: center; gap: 12px; padding: 12px;
            border-radius: 6px; color: var(--text-sub); text-decoration: none;
            margin-bottom: 2px;
        }
        .nav-item-d.active { background: var(--bg-subtle); color: white; border-left: 3px solid var(--primary); }
        .nav-item-m {
            display: flex; flex-direction: column; align-items: center;
            color: var(--text-sub); font-size: 10px; text-decoration: none; width: 100%;
        }
        .nav-item-m.active { color: var(--primary); }
        
        .avatar {
            width: 40px; height: 40px; border-radius: 50%;
            background: var(--bg-subtle); display: grid; place-items: center; font-size: 18px;
        }
    </style>
</head>
<body>

    <div id="view-auth">
        <div class="card-box p-4 w-100" style="max-width: 400px; box-shadow: 0 0 50px rgba(0,0,0,0.5);">
            <div class="text-center mb-4">
                <h3 class="fw-bold text-white">SLBDMIS Portal</h3>
                <p class="text-sub small">Select your profile</p>
            </div>
            
            <div id="auth-step-1" class="row g-2"></div>
            
            <div id="auth-step-2" class="d-none">
                <div class="d-flex align-items-center gap-3 p-3 rounded bg-dark border border-secondary border-opacity-25 mb-4">
                    <div id="auth-av" class="avatar fs-4"></div>
                    <div>
                        <div id="auth-name" class="fw-bold text-white"></div>
                        <div class="text-sub text-xs">Enter PIN Code</div>
                    </div>
                </div>
                <input type="password" id="inp-pin" class="form-control form-control-lg bg-black text-white text-center border-secondary mb-3" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="11" inputmode="numeric">
                <button onclick="tryLogin()" class="btn btn-primary w-100 py-3 rounded-pill fw-bold">Login</button>
                <button onclick="authReset()" class="btn btn-link text-secondary w-100 mt-2">Go Back</button>
            </div>
        </div>
    </div>

    <div id="view-app" class="d-none">
        
        <div class="mobile-header fixed-top glass border-bottom border-secondary border-opacity-25 px-3 py-3 d-flex justify-content-between align-items-center" style="z-index: 900;">
            <div class="d-flex align-items-center gap-2">
                <div id="mob-u-av" class="avatar"></div>
                <span id="mob-pg-title" class="fw-bold">Dashboard</span>
            </div>
            <div class="d-flex gap-2">
                <button onclick="openCreate()" class="btn btn-primary btn-sm shadow"><i data-lucide="plus" size="18"></i></button>
            </div>
        </div>

        <nav class="sidebar">
            <div class="mb-5 px-2 text-white fw-bold fs-5">SLBDMIS</div>
            <div id="nav-d-links" class="flex-grow-1"></div>
            <div class="mt-auto border-top border-secondary border-opacity-25 pt-3">
                <div class="d-flex align-items-center gap-3 px-2 mb-3">
                    <div id="desk-u-av" class="avatar"></div>
                    <div id="desk-u-name" class="fw-bold text-white small"></div>
                </div>
                <button onclick="doLogout()" class="btn btn-outline-danger btn-sm w-100">Sign Out</button>
            </div>
        </nav>

        <main class="main-wrapper" style="padding-top: 80px;">
            <div class="d-none d-lg-flex justify-content-between align-items-center mb-4 mt-n4">
                <h3 id="desk-pg-title" class="fw-bold m-0">Dashboard</h3>
                <button onclick="openCreate()" class="btn btn-primary px-4 fw-bold shadow"><i data-lucide="plus" size="18" class="me-2"></i>New Item</button>
            </div>
            <div id="content-box"></div>
        </main>

        <nav class="mobile-nav" id="nav-m-links"></nav>
    </div>

    <div class="modal fade" id="modCreate" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content card-box border-0">
                <div class="modal-header border-bottom border-secondary border-opacity-25">
                    <h5 class="modal-title fw-bold">Create New</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="d-flex bg-dark p-1 rounded mb-3 border border-secondary border-opacity-25">
                        <button onclick="setMode('task')" id="bm-task" class="btn btn-sm flex-fill text-white bg-secondary bg-opacity-25">Task</button>
                        <button onclick="setMode('future')" id="bm-future" class="btn btn-sm flex-fill text-secondary">Not Yet</button>
                        <button onclick="setMode('dec')" id="bm-dec" class="btn btn-sm flex-fill text-secondary">Decision</button>
                    </div>
                    
                    <input type="text" id="inp-t" class="form-control form-control-lg bg-black text-white border-secondary mb-3" placeholder="Title">
                    <textarea id="inp-d" class="form-control bg-black text-white border-secondary mb-3" rows="3" placeholder="Details..."></textarea>
                    
                    <div id="sec-task-opt">
                        <label class="text-sub text-xs fw-bold mb-2">DUE DATE</label>
                        <input type="date" id="inp-date" class="form-control bg-black text-white border-secondary mb-3">
                        <label class="text-sub text-xs fw-bold mb-2">ASSIGN TO</label>
                        <div id="div-mems" class="d-flex flex-column gap-2 mb-4"></div>
                    </div>
                    
                    <button onclick="saveItem()" class="btn btn-primary w-100 py-3 rounded-pill fw-bold">Save Record</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modProof" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content card-box border-0">
                <div class="modal-header border-bottom border-secondary border-opacity-25">
                    <h5 class="modal-title fw-bold">Complete Task</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="d-grid gap-2 mb-4">
                        <a href="https://drive.google.com/drive/folders/1VskzY_IgfF6lagiEdaF5-yy6Te_u-MMG?usp=sharing" target="_blank" class="btn btn-dark text-start p-3 border border-secondary border-opacity-25">üìÇ Admin & Finance</a>
                        <a href="https://drive.google.com/drive/folders/1FivXbl7Qo5qnKV2Kn6DXxdtVUS4nB5CF?usp=sharing" target="_blank" class="btn btn-dark text-start p-3 border border-secondary border-opacity-25">‚öôÔ∏è Machine Unit</a>
                    </div>
                    <div class="form-check bg-black p-3 rounded border border-secondary border-opacity-25">
                        <input class="form-check-input" type="checkbox" id="chk-done" onchange="toggleFin()">
                        <label class="form-check-label text-white small">I have uploaded the files.</label>
                    </div>
                    <button id="btn-fin" onclick="finishTask()" class="btn btn-success w-100 mt-3 py-3 rounded-pill fw-bold disabled">Mark Complete</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1100;">
        <div id="sysToast" class="toast align-items-center text-bg-dark border-0 shadow-lg">
            <div class="d-flex">
                <div class="toast-body d-flex gap-3 align-items-center">
                    <i id="t-ico" data-lucide="check"></i>
                    <div><strong id="t-tit" class="d-block"></strong><small id="t-msg" class="text-secondary"></small></div>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <script>
        // 1. CONFIGURATION (FIXED)
        const SB_URL = 'https://bzrkbjjgymdbbwpatfct.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6cmtiampneW1kYmJ3cGF0ZmN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTcyNjcsImV4cCI6MjA4NTg3MzI2N30.Icv1daEp7NophE_ktPl2G1EgDP6awo0tyV14yh3Q4Sw';
        
        // ** CRITICAL FIX: Renamed variable to 'sbClient' **
        const sbClient = window.supabase.createClient(SB_URL, SB_KEY);

        const TEAM = [
            { id: 1, name: "Pema Ugyen", av: "üë®‚Äçüíº", pin: "11107008201", role: "LEADER" },
            { id: 2, name: "Jamphel",    av: "üë®‚Äçüíª", pin: "11302003634", role: "MEMBER" },
            { id: 3, name: "Laxmi",      av: "üë®‚Äçüî¨", pin: "11103002151", role: "MEMBER" },
            { id: 4, name: "Ngawang",    av: "üë®",   pin: "10801003243", role: "MEMBER" }
        ];

        let STATE = { user: null, page: 'home', mode: 'task', tempId: null };
        const MODALS = {};

        // 2. INITIALIZATION
        window.onload = () => {
            lucide.createIcons();
            MODALS.create = new bootstrap.Modal('#modCreate');
            MODALS.proof = new bootstrap.Modal('#modProof');

            // Auto-login
            const uid = localStorage.getItem('slbd_uid');
            if(uid) {
                const u = TEAM.find(x => x.id == uid);
                if(u) login(u);
                else initAuth();
            } else {
                initAuth();
            }
        };

        // 3. AUTHENTICATION
        function initAuth() {
            document.getElementById('auth-step-1').innerHTML = TEAM.map(u => `
                <div class="col-6"><div onclick="preLogin(${u.id})" class="card-box p-3 text-center cursor-pointer">
                    <div class="fs-1 mb-2">${u.av}</div><div class="fw-bold text-white small">${u.name.split(' ')[0]}</div>
                </div></div>`).join('');
        }
        function preLogin(id) {
            STATE.sel = TEAM.find(u=>u.id===id);
            document.getElementById('auth-step-1').classList.add('d-none');
            document.getElementById('auth-step-2').classList.remove('d-none');
            document.getElementById('auth-av').innerText = STATE.sel.av;
            document.getElementById('auth-name').innerText = STATE.sel.name;
        }
        function authReset() {
            document.getElementById('auth-step-2').classList.add('d-none');
            document.getElementById('auth-step-1').classList.remove('d-none');
            document.getElementById('inp-pin').value = '';
        }
        function tryLogin() {
            if(document.getElementById('inp-pin').value === STATE.sel.pin) {
                localStorage.setItem('slbd_uid', STATE.sel.id);
                login(STATE.sel);
            } else {
                toast('Error','Wrong PIN','alert-triangle','text-danger');
            }
        }
        function login(u) {
            STATE.user = u;
            document.getElementById('view-auth').classList.add('force-hide'); // Hide Auth
            document.getElementById('view-app').classList.remove('d-none');   // Show App
            
            // Set Headers
            document.getElementById('mob-u-av').innerText = u.av;
            document.getElementById('desk-u-av').innerText = u.av;
            document.getElementById('desk-u-name').innerText = u.name;
            
            setupNav();
            nav('home');
        }
        function doLogout() { localStorage.removeItem('slbd_uid'); location.reload(); }

        // 4. NAVIGATION
        function setupNav() {
            const pages = [
                {id:'home', t:'Dashboard', i:'layout-grid'},
                {id:'task', t:'Tasks', i:'layers'},
                {id:'future', t:'Not Yet', i:'hourglass'},
                {id:'dec', t:'Decisions', i:'scroll-text'}
            ];
            document.getElementById('nav-d-links').innerHTML = pages.map(p => `<a href="#" onclick="nav('${p.id}')" id="nd-${p.id}" class="nav-item-d"><i data-lucide="${p.i}" size="18"></i> ${p.t}</a>`).join('');
            document.getElementById('nav-m-links').innerHTML = pages.map(p => `<a href="#" onclick="nav('${p.id}')" id="nm-${p.id}" class="nav-item-m"><i data-lucide="${p.i}" size="22"></i> <span>${p.t}</span></a>`).join('');
        }
        function nav(p) {
            STATE.page = p;
            document.querySelectorAll('.nav-item-d').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.nav-item-m').forEach(e=>e.classList.remove('active'));
            document.getElementById(`nd-${p}`).classList.add('active');
            document.getElementById(`nm-${p}`).classList.add('active');
            
            const titles = {home:'My Workspace', task:'All Tasks', future:'Future Ideas', dec:'Decisions'};
            document.getElementById('mob-pg-title').innerText = titles[p];
            document.getElementById('desk-pg-title').innerText = titles[p];
            render();
        }

        // 5. RENDERING & DATA
        async function render() {
            const c = document.getElementById('content-box');
            c.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
            
            try {
                if(STATE.page === 'home') {
                    // Fetch tasks where current user is tagged
                    const {data} = await sbClient.from('tasks').select('*').neq('status','Done').neq('status','Future');
                    const myT = data.filter(x => (x.tagged_members||[]).includes(STATE.user.id));
                    
                    c.innerHTML = `
                        <div class="row g-3">
                            <div class="col-12 col-md-4">
                                <div class="card-box p-4 text-center">
                                    <h2 class="fw-bold text-white">${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</h2>
                                    <div class="text-secondary small mb-3">${new Date().toDateString()}</div>
                                    <button class="btn btn-primary w-100 rounded-pill shadow" onclick="toast('OK','Checked In','check','text-success')">Check In</button>
                                </div>
                            </div>
                            <div class="col-12 col-md-8">
                                <div class="card-box p-3">
                                    <h6 class="text-secondary small fw-bold mb-3">MY TASKS</h6>
                                    ${myT.length ? myT.map(x => `<div class="p-3 border border-secondary border-opacity-25 rounded mb-2 bg-dark"><div class="d-flex justify-content-between"><span class="badge-st st-wait">${x.status}</span><small class="text-secondary">${x.due_date||''}</small></div><div class="fw-bold text-white">${x.task_title}</div></div>`).join('') : '<div class="text-center text-muted py-3">No active tasks.</div>'}
                                </div>
                            </div>
                        </div>`;
                }
                
                if(STATE.page === 'task') {
                    const {data} = await sbClient.from('tasks').select('*').neq('status','Future').order('created_at',{ascending:false});
                    c.innerHTML = `<div class="row g-3">${data.map(t => `
                        <div class="col-12 col-lg-6"><div class="card-box p-3 h-100 border-start border-4 ${t.status==='Done'?'border-success':t.status==='Review'?'border-info':'border-warning'}">
                            <div class="d-flex justify-content-between mb-2"><span class="badge-st ${t.status==='Done'?'st-done':t.status==='Review'?'st-rev':'st-wait'}">${t.status}</span><small class="text-secondary">${t.created_at.slice(0,10)}</small></div>
                            <h5 class="fw-bold text-white">${t.task_title}</h5><p class="small text-secondary text-truncate">${t.description||''}</p>
                            ${t.status!=='Done' && t.status!=='Future' ? `<button onclick="initDone(${t.id})" class="btn btn-sm btn-outline-primary w-100 mt-2">Mark Done</button>` : ''}
                        </div></div>`).join('')}</div>`;
                }
                
                if(STATE.page === 'future') {
                    const {data} = await sbClient.from('tasks').select('*').eq('status','Future');
                    c.innerHTML = `<div class="row g-3">${data.map(t => `<div class="col-12 col-lg-6"><div class="card-box p-3 opacity-75"><h5 class="fw-bold text-white">${t.task_title}</h5><p class="small text-secondary">${t.description}</p><span class="badge-st st-fut">Not Yet</span></div></div>`).join('')}</div>`;
                }

                if(STATE.page === 'dec') {
                    const {data} = await sbClient.from('decisions').select('*').order('created_at',{ascending:false});
                    c.innerHTML = data.map(d => `<div class="card-box p-3 mb-2"><div class="fw-bold text-white">${d.subject}</div><div class="small text-secondary">${d.details}</div></div>`).join('');
                }
            } catch(e) {
                console.error(e);
                c.innerHTML = `<div class="text-danger p-3">Error loading data. Check internet.</div>`;
            }
            lucide.createIcons();
        }

        // 6. ACTIONS (SAVE & COMPLETE)
        function setMode(m) {
            STATE.mode = m;
            ['task','future','dec'].forEach(x => {
                const b = document.getElementById(`bm-${x}`);
                if(x===m) { b.classList.add('bg-secondary','bg-opacity-25','text-white'); b.classList.remove('text-secondary'); }
                else { b.classList.remove('bg-secondary','bg-opacity-25','text-white'); b.classList.add('text-secondary'); }
            });
            const isT = m!=='dec';
            document.getElementById('sec-task-opt').classList.toggle('d-none', !isT);
            document.getElementById('inp-t').placeholder = m==='dec'?'Subject':'Title';
            
            if(isT) {
                document.getElementById('div-mems').innerHTML = TEAM.map(u=>`<label class="d-flex align-items-center p-2 rounded bg-black border border-secondary border-opacity-25"><input type="checkbox" class="chk-mem form-check-input me-3" value="${u.id}"> ${u.av} ${u.name}</label>`).join('');
            }
        }

        function openCreate() {
            setMode('task');
            document.getElementById('inp-t').value=''; 
            document.getElementById('inp-d').value='';
            MODALS.create.show();
        }

        async function saveItem() {
            const t = document.getElementById('inp-t').value;
            const d = document.getElementById('inp-d').value;
            
            if(!t) return toast('Error','Title is required','alert-circle','text-danger');

            try {
                if(STATE.mode === 'dec') {
                    await sbClient.from('decisions').insert({subject:t, details:d});
                } else {
                    // Collect Checked Members
                    const tags = [];
                    document.querySelectorAll('.chk-mem:checked').forEach(el => tags.push(parseInt(el.value)));
                    
                    const st = STATE.mode === 'future' ? 'Future' : 'Pending';
                    const date = document.getElementById('inp-date').value || null;

                    const { error } = await sbClient.from('tasks').insert({
                        task_title: t,
                        description: d,
                        due_date: date,
                        creator_id: STATE.user.id,
                        tagged_members: tags,
                        status: st
                    });
                    if(error) throw error;
                }
                MODALS.create.hide();
                toast('Success','Saved successfully','check-circle','text-success');
                render();
            } catch(err) {
                console.error(err);
                toast('Error','Could not save data','x','text-danger');
            }
        }

        // COMPLETE TASK LOGIC
        function initDone(id) {
            STATE.tempId = id; // Store ID
            document.getElementById('chk-done').checked = false;
            toggleFin();
            MODALS.proof.show();
        }

        function toggleFin() {
            const chk = document.getElementById('chk-done').checked;
            const btn = document.getElementById('btn-fin');
            if(chk) btn.classList.remove('disabled');
            else btn.classList.add('disabled');
        }

        async function finishTask() {
            if(!STATE.tempId) return;
            try {
                await sbClient.from('tasks').update({ status: 'Done' }).eq('id', STATE.tempId);
                MODALS.proof.hide();
                toast('Nice Work!','Task Completed','trophy','text-warning');
                render();
            } catch(e) {
                toast('Error','Connection Failed','wifi-off','text-danger');
            }
        }

        function toast(t, m, i, c) {
            document.getElementById('t-tit').innerText = t;
            document.getElementById('t-msg').innerText = m;
            const ico = document.getElementById('t-ico');
            ico.setAttribute('data-lucide', i);
            ico.className = c;
            lucide.createIcons();
            bootstrap.Toast.getOrCreateInstance(document.getElementById('sysToast')).show();
        }
    </script>
</body>
</html>
