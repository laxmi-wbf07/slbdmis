<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>COMMAND OS | PRO v4</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        /* --- PROFESSIONAL DARK THEME --- */
        :root { 
            --primary: #3b82f6; /* Professional Blue */
            --primary-dim: rgba(59, 130, 246, 0.15);
            --accent: #10b981;  /* Success Green */
            --bg: #0f172a;      /* Slate 900 */
            --panel: #1e293b;   /* Slate 800 */
            --border: #334155;  /* Slate 700 */
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --font-ui: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        body { background-color: var(--bg); color: var(--text-main); font-family: var(--font-ui); overflow-x: hidden; }
        
        /* SUBTLE GRADIENT BG */
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 0%, rgba(59, 130, 246, 0.08) 0%, transparent 50%);
            z-index: -1; pointer-events: none;
        }

        /* --- COMPONENTS --- */
        .glass-panel { 
            background: var(--panel); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .mono-label { font-family: var(--font-mono); font-size: 0.75rem; letter-spacing: 0.5px; text-transform: uppercase; color: var(--text-muted); }

        /* BUTTONS */
        .btn { border-radius: 8px; font-weight: 500; transition: 0.2s; border: none; }
        .btn:active { transform: translateY(1px); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-outline-secondary { border: 1px solid var(--border); color: var(--text-muted); }
        .btn-outline-secondary:hover { background: var(--border); color: white; }
        
        /* FORMS & SLIDERS */
        .form-control, .form-select {
            background: #020617 !important; border: 1px solid var(--border) !important;
            color: white !important; border-radius: 8px; padding: 10px;
        }
        .form-control:focus { border-color: var(--primary) !important; box-shadow: 0 0 0 2px var(--primary-dim); }

        /* Range Slider Styling */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: var(--primary); margin-top: -6px; cursor: pointer; border: 2px solid #fff;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: var(--border); border-radius: 2px;
        }

        /* --- CALENDAR --- */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border); border-radius: 8px; overflow: hidden; border: 1px solid var(--border); }
        .cal-day { background: var(--panel); min-height: 100px; padding: 8px; cursor: pointer; transition: 0.2s; }
        .cal-day:hover { background: #2a3855; }
        .cal-today { background: rgba(59, 130, 246, 0.1); }
        .cal-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); display: inline-block; margin-right: 4px; }
        .cal-task-item { font-size: 0.7rem; color: #cbd5e1; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- GRAPH --- */
        .bar-container { display: flex; align-items: flex-end; height: 120px; gap: 12px; padding-top: 20px; }
        .bar-group { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .bar-track { width: 100%; height: 100%; background: rgba(255,255,255,0.05); border-radius: 6px; position: relative; overflow: hidden; }
        .bar-fill { position: absolute; bottom: 0; left: 0; width: 100%; background: var(--primary); transition: height 0.8s ease; }
        
        /* --- LAYOUTS --- */
        .nav-link-custom { 
            display: flex; align-items: center; gap: 12px; padding: 12px; 
            color: var(--text-muted); border-radius: 8px; text-decoration: none; transition: 0.2s; 
        }
        .nav-link-custom:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-link-custom.active { background: var(--primary); color: white; }
        
        .nav-mobile-item { color: #666; padding: 10px; position: relative; }
        .nav-mobile-item.active { color: var(--primary); }

        .chat-bubble { background: #2a3855; border-radius: 12px; padding: 12px; margin-bottom: 12px; border-left: 4px solid var(--border); }
        .chat-bubble.leader { border-left-color: var(--primary); }
    </style>
</head>
<body>

    <div id="view-auth" class="d-none fixed-top w-100 h-100 bg-black d-flex flex-column justify-content-center align-items-center" style="z-index: 2000;">
        <div class="text-center mb-4">
            <div class="bg-primary rounded-3 d-inline-flex align-items-center justify-content-center mb-3" style="width: 64px; height: 64px;">
                <i data-lucide="command" class="text-white" size="32"></i>
            </div>
            <h2 class="fw-bold text-white tracking-tight">COMMAND OS</h2>
            <p class="text-muted small">SECURE WORKSPACE</p>
        </div>
        <div id="auth-list" class="row g-3" style="max-width: 400px; width: 100%;"></div>
        
        <div id="auth-pin" class="d-none text-center" style="max-width: 300px;">
            <div id="l-av" class="display-4 mb-3"></div>
            <h4 id="l-name" class="text-white mb-4"></h4>
            <input type="password" id="inp-pin" class="form-control text-center fs-4 mb-3" maxlength="11" placeholder="Enter PIN">
            <button onclick="tryLogin()" class="btn btn-primary w-100 py-3 fw-bold">UNLOCK</button>
            <button onclick="resetAuth()" class="btn btn-link text-secondary mt-2 text-decoration-none">Back</button>
        </div>
    </div>

    <div id="view-app" class="d-none">
        
        <div class="d-none d-md-flex flex-column fixed-top h-100 p-3 border-end border-secondary border-opacity-25" style="width: 260px; background: var(--bg); z-index: 1000;">
            <div class="d-flex align-items-center gap-2 px-2 mb-5 mt-2">
                <div class="bg-primary rounded p-1"><i data-lucide="command" class="text-white" size="20"></i></div>
                <span class="fw-bold text-white tracking-tight">COMMAND OS</span>
            </div>
            
            <nav class="flex-grow-1 d-flex flex-column gap-1">
                <a onclick="nav('home')" id="nd-home" class="nav-link-custom cursor-pointer"><i data-lucide="layout-dashboard" size="18"></i> Dashboard</a>
                <a onclick="nav('cal')" id="nd-cal" class="nav-link-custom cursor-pointer"><i data-lucide="calendar" size="18"></i> Calendar</a>
                <a onclick="nav('task')" id="nd-task" class="nav-link-custom cursor-pointer"><i data-lucide="check-square" size="18"></i> Tasks</a>
                <a onclick="nav('idea')" id="nd-idea" class="nav-link-custom cursor-pointer"><i data-lucide="lightbulb" size="18"></i> Ideas</a>
                <a onclick="nav('feed')" id="nd-feed" class="nav-link-custom cursor-pointer"><i data-lucide="message-square" size="18"></i> Team Feed</a>
                <a onclick="nav('drive')" id="nd-drive" class="nav-link-custom cursor-pointer"><i data-lucide="hard-drive" size="18"></i> Drive</a>
            </nav>

            <div class="mt-auto border-top border-secondary border-opacity-25 pt-3 px-2">
                <div class="d-flex align-items-center gap-3">
                    <div id="d-av" class="rounded-circle bg-secondary d-flex justify-content-center align-items-center text-white" style="width: 36px; height: 36px;"></div>
                    <div class="overflow-hidden">
                        <div id="d-name" class="text-white fw-bold small text-truncate"></div>
                        <div id="d-role" class="text-muted text-xs small"></div>
                    </div>
                    <button onclick="doLogout()" class="btn btn-icon ms-auto text-secondary"><i data-lucide="log-out" size="16"></i></button>
                </div>
            </div>
        </div>

        <div class="d-md-none fixed-top glass-panel m-2 d-flex align-items-center justify-content-between px-3" style="height: 60px; z-index: 1001;">
            <div class="fw-bold text-white">COMMAND OS</div>
            <div class="d-flex align-items-center gap-2">
                <div id="m-av" class="small"></div>
                <button onclick="doLogout()" class="btn btn-sm text-secondary"><i data-lucide="log-out"></i></button>
            </div>
        </div>

        <div class="main-content" style="padding-top: 80px; padding-bottom: 100px;">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-9 offset-md-3 col-lg-10 offset-lg-2 p-3 p-md-5">
                        
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 id="page-title" class="fw-bold text-white m-0">Dashboard</h2>
                            <button onclick="openCreate()" class="btn btn-primary d-flex align-items-center gap-2 shadow-sm">
                                <i data-lucide="plus" size="18"></i> <span class="d-none d-sm-inline">New Item</span>
                            </button>
                        </div>

                        <div id="app-content"></div>

                    </div>
                </div>
            </div>
        </div>

        <div class="d-md-none fixed-bottom m-3 p-2 glass-panel d-flex justify-content-between" style="z-index: 1001;">
            <div onclick="nav('home')" id="nm-home" class="nav-mobile-item"><i data-lucide="layout-dashboard"></i></div>
            <div onclick="nav('cal')" id="nm-cal" class="nav-mobile-item"><i data-lucide="calendar"></i></div>
            <div onclick="nav('task')" id="nm-task" class="nav-mobile-item"><i data-lucide="check-square"></i></div>
            <div onclick="nav('idea')" id="nm-idea" class="nav-mobile-item"><i data-lucide="lightbulb"></i></div>
            <div onclick="nav('feed')" id="nm-feed" class="nav-mobile-item"><i data-lucide="message-square"></i></div>
        </div>

    </div>

    <div class="modal fade" id="modCreate" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass-panel border-0">
                <div class="modal-body p-4">
                    <h5 class="fw-bold text-white mb-3">Create New</h5>
                    
                    <div class="btn-group w-100 mb-3" role="group">
                        <input type="radio" class="btn-check" name="ctype" id="ct-task" value="task" checked onchange="toggleForm('task')">
                        <label class="btn btn-outline-secondary" for="ct-task">Task</label>

                        <input type="radio" class="btn-check" name="ctype" id="ct-idea" value="idea" onchange="toggleForm('idea')">
                        <label class="btn btn-outline-secondary" for="ct-idea">Idea</label>
                        
                        <input type="radio" class="btn-check" name="ctype" id="ct-msg" value="feed" onchange="toggleForm('feed')">
                        <label class="btn btn-outline-secondary" for="ct-msg">Post</label>
                    </div>

                    <input type="text" id="inp-title" class="form-control mb-3 fw-bold" placeholder="Title / Subject">
                    <textarea id="inp-desc" class="form-control mb-3" rows="3" placeholder="Description..."></textarea>
                    
                    <div id="form-task-opts">
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="mono-label mb-1">Due Date</label>
                                <input type="date" id="inp-date" class="form-control">
                            </div>
                            <div class="col-6">
                                <label class="mono-label mb-1">Priority</label>
                                <select id="inp-prio" class="form-select">
                                    <option value="Normal">Normal</option>
                                    <option value="High">High</option>
                                </select>
                            </div>
                        </div>
                        <label class="mono-label mb-2 d-block">Assign To</label>
                        <div id="div-mems" class="d-flex flex-wrap gap-2 mb-3"></div>
                    </div>

                    <button onclick="saveItem()" class="btn btn-primary w-100 py-3">Create</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modSubmit" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass-panel border-0">
                <div class="modal-body p-4 text-center">
                    <h5 class="fw-bold text-white mb-2">Upload File</h5>
                    <p class="text-muted small mb-4">Select the drive folder</p>
                    <div class="row g-3 mb-3">
                        <div class="col-6"><button onclick="openDriveLink('Admin')" class="btn btn-outline-secondary w-100 p-3"><i data-lucide="shield" class="mb-2"></i><br>Admin</button></div>
                        <div class="col-6"><button onclick="openDriveLink('Machine')" class="btn btn-outline-secondary w-100 p-3"><i data-lucide="cpu" class="mb-2"></i><br>Machine</button></div>
                        <div class="col-6"><button onclick="openDriveLink('Pics')" class="btn btn-outline-secondary w-100 p-3"><i data-lucide="image" class="mb-2"></i><br>Media</button></div>
                        <div class="col-6"><button onclick="openDriveLink('PPT')" class="btn btn-outline-secondary w-100 p-3"><i data-lucide="presentation" class="mb-2"></i><br>Decks</button></div>
                    </div>
                    <textarea id="sub-note" class="form-control mb-3" placeholder="Add a note..."></textarea>
                    <button onclick="confirmSubmit()" class="btn btn-success w-100">Confirm Upload</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 3000">
        <div id="sysToast" class="toast align-items-center text-white bg-primary border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body fw-bold" id="toast-msg">Action Successful</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const SB_URL = 'https://bzrkbjjgymdbbwpatfct.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6cmtiampneW1kYmJ3cGF0ZmN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTcyNjcsImV4cCI6MjA4NTg3MzI2N30.Icv1daEp7NophE_ktPl2G1EgDP6awo0tyV14yh3Q4Sw';
        const sbClient = window.supabase.createClient(SB_URL, SB_KEY);
        
        const TEAM = [
            { id: 1, name: "Pema Ugyen", av: "ðŸ‘¨â€ðŸ’¼", pin: "11107008201", role: "LEADER" },
            { id: 2, name: "Jamphel",    av: "ðŸ‘¨â€ðŸ’»", pin: "11302003634", role: "MEMBER" },
            { id: 3, name: "Laxmi",      av: "ðŸ‘¨â€ðŸ”¬", pin: "11103002151", role: "MEMBER" },
            { id: 4, name: "Ngawang",    av: "ðŸ‘¨",   pin: "10801003243", role: "MEMBER" }
        ];

        const DRIVE_LINKS = {
            'Admin': 'https://drive.google.com/drive/folders/1VskzY_IgfF6lagiEdaF5-yy6Te_u-MMG?usp=sharing',
            'Machine': 'https://drive.google.com/drive/folders/1FivXbl7Qo5qnKV2Kn6DXxdtVUS4nB5CF?usp=sharing',
            'Pics': 'https://drive.google.com/drive/folders/11Q6gWSLqU4H88DrmWA_Fmbkx8dsNs0Ka?usp=sharing',
            'PPT': 'https://drive.google.com/drive/folders/1IBpIa7nH43g1UVMYkFOwLA6iEFVvuv7y?usp=sharing'
        };

        let STATE = { user: null, page: 'home', createMode: 'task', activeTaskForSub: null };
        const MODAL_CREATE = new bootstrap.Modal(document.getElementById('modCreate'));
        const MODAL_SUBMIT = new bootstrap.Modal(document.getElementById('modSubmit'));

        // --- INIT ---
        window.onload = function() {
            lucide.createIcons();
            const storedUid = localStorage.getItem('cmd_uid');
            if(storedUid) {
                const u = TEAM.find(x => x.id == storedUid);
                if(u) login(u); else initAuth();
            } else {
                initAuth();
            }
        };

        // --- AUTH ---
        function initAuth() {
            document.getElementById('view-auth').classList.remove('d-none');
            const list = document.getElementById('auth-list');
            list.innerHTML = TEAM.map(u => `
                <div class="col-6">
                    <div onclick="preLogin(${u.id})" class="glass-panel p-4 text-center cursor-pointer h-100 hover-panel">
                        <div class="fs-1 mb-2">${u.av}</div>
                        <div class="fw-bold text-white">${u.name.split(' ')[0]}</div>
                    </div>
                </div>
            `).join('');
        }

        function preLogin(id) {
            STATE.selUser = TEAM.find(u => u.id === id);
            document.getElementById('auth-list').classList.add('d-none');
            document.getElementById('auth-pin').classList.remove('d-none');
            document.getElementById('l-av').innerText = STATE.selUser.av;
            document.getElementById('l-name').innerText = STATE.selUser.name;
        }

        function resetAuth() {
            document.getElementById('auth-pin').classList.add('d-none');
            document.getElementById('auth-list').classList.remove('d-none');
            document.getElementById('inp-pin').value = '';
        }

        function tryLogin() {
            if(document.getElementById('inp-pin').value === STATE.selUser.pin) {
                localStorage.setItem('cmd_uid', STATE.selUser.id);
                document.getElementById('view-auth').classList.add('d-none');
                login(STATE.selUser);
            } else {
                alert('Invalid PIN');
            }
        }

        function login(u) {
            STATE.user = u;
            document.getElementById('view-app').classList.remove('d-none');
            document.getElementById('d-name').innerText = u.name;
            document.getElementById('d-role').innerText = u.role;
            document.getElementById('d-av').innerText = u.av;
            document.getElementById('m-av').innerText = u.av;
            
            nav('home');
        }

        function doLogout() {
            localStorage.removeItem('cmd_uid');
            location.reload();
        }

        // --- NAVIGATION ---
        function nav(page) {
            STATE.page = page;
            
            // Desktop Active State
            document.querySelectorAll('.nav-link-custom').forEach(el => el.classList.remove('active'));
            const nd = document.getElementById('nd-' + page);
            if(nd) nd.classList.add('active');

            // Mobile Active State
            document.querySelectorAll('.nav-mobile-item').forEach(el => el.classList.remove('active'));
            const nm = document.getElementById('nm-' + page);
            if(nm) nm.classList.add('active');

            // Titles
            const titles = {
                'home': 'Dashboard',
                'cal': 'Calendar',
                'task': 'Tasks',
                'idea': 'Ideas',
                'feed': 'Team Feed',
                'drive': 'Drive'
            };
            document.getElementById('page-title').innerText = titles[page];
            
            render();
        }

        // --- RENDER ENGINE ---
        async function render() {
            const container = document.getElementById('app-content');
            container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';

            try {
                // Fetch data
                const { data: tasks } = await sbClient.from('tasks').select('*').order('created_at', {ascending: false});
                const { data: feed } = await sbClient.from('decisions').select('*').order('created_at', {ascending: false});
                
                let html = '';

                // 1. DASHBOARD
                if(STATE.page === 'home') {
                    // Momentum Graph Logic (Avg Completion %)
                    let graphHtml = '';
                    TEAM.forEach(member => {
                        const memberTasks = tasks.filter(t => (t.tagged_members||[]).includes(member.id) && t.status !== 'Idea');
                        let totalProg = 0;
                        if(memberTasks.length > 0) {
                            totalProg = memberTasks.reduce((acc, curr) => acc + (curr.progress || 0), 0) / memberTasks.length;
                        }
                        graphHtml += `
                            <div class="bar-group">
                                <div class="bar-track">
                                    <div class="bar-fill" style="height: ${Math.round(totalProg)}%"></div>
                                </div>
                                <div class="mono-label" style="font-size:0.6rem">${member.name.split(' ')[0]}</div>
                                <div class="fw-bold small">${Math.round(totalProg)}%</div>
                            </div>
                        `;
                    });

                    // Pending Tasks List
                    const myTasks = tasks.filter(t => t.status !== 'Done' && t.status !== 'Idea' && (t.tagged_members||[]).includes(STATE.user.id)).slice(0, 5);

                    html = `
                        <div class="row g-4">
                            <div class="col-12 col-lg-6">
                                <div class="glass-panel p-4 h-100">
                                    <h6 class="mono-label mb-3">Team Momentum (Avg. Completion)</h6>
                                    <div class="bar-container">${graphHtml}</div>
                                </div>
                            </div>
                            <div class="col-12 col-lg-6">
                                <div class="glass-panel p-4 h-100">
                                    <h6 class="mono-label mb-3">Your Priority Queue</h6>
                                    ${myTasks.length === 0 ? '<div class="text-muted fst-italic">No pending tasks. Good job!</div>' : 
                                      myTasks.map(t => `
                                        <div class="d-flex align-items-center justify-content-between p-3 mb-2 rounded bg-dark border border-secondary border-opacity-25">
                                            <div class="text-truncate me-2">
                                                <div class="fw-bold text-white small">${t.task_title}</div>
                                                <div class="text-muted text-xs">${t.status}</div>
                                            </div>
                                            <div class="text-primary fw-bold small">${t.progress}%</div>
                                        </div>
                                      `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }

                // 2. CALENDAR
                if(STATE.page === 'cal') {
                    const now = new Date();
                    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
                    
                    let days = '';
                    for(let i=0; i<firstDay; i++) days += `<div class="cal-day bg-transparent"></div>`;
                    
                    for(let d=1; d<=daysInMonth; d++) {
                        const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                        const dayTasks = tasks.filter(t => t.due_date === dateStr && t.status !== 'Idea');
                        const isToday = d === now.getDate();
                        
                        days += `
                            <div class="cal-day ${isToday ? 'cal-today' : ''}" onclick="openCreateWithDate('${dateStr}')">
                                <div class="d-flex justify-content-between">
                                    <span class="small fw-bold ${isToday ? 'text-primary' : 'text-secondary'}">${d}</span>
                                </div>
                                <div class="mt-1">
                                    ${dayTasks.map(t => `<div class="cal-task-item"><span class="cal-dot"></span>${t.task_title}</div>`).join('')}
                                </div>
                            </div>
                        `;
                    }

                    html = `
                        <div class="glass-panel p-1">
                            <div class="p-3 text-center fw-bold text-white">${now.toLocaleString('default',{month:'long'})} ${now.getFullYear()}</div>
                            <div class="cal-grid">
                                ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(h => `<div class="p-2 text-center mono-label bg-dark">${h}</div>`).join('')}
                                ${days}
                            </div>
                        </div>
                    `;
                }

                // 3. TASKS
                if(STATE.page === 'task') {
                    // Filter out Ideas
                    const activeTasks = tasks.filter(t => t.status !== 'Idea' && t.status !== 'Done');
                    
                    html = `<div class="row g-3">
                        ${activeTasks.length === 0 ? '<div class="col-12 text-center text-muted">All clear.</div>' : ''}
                        ${activeTasks.map(t => {
                            const isMyTask = (t.tagged_members||[]).includes(STATE.user.id);
                            
                            // Determine buttons based on role/status
                            let actionBtns = '';
                            if(STATE.user.role === 'LEADER' && t.status === 'ApprovalReq') {
                                actionBtns = `<button onclick="updateStatus(${t.id}, 'Pending')" class="btn btn-primary btn-sm w-100 mt-2">Approve</button>`;
                            } else if (t.status === 'Review') {
                                actionBtns = STATE.user.role === 'LEADER' 
                                    ? `<div class="d-flex gap-2 mt-2"><button onclick="updateStatus(${t.id}, 'Done')" class="btn btn-success btn-sm flex-fill">Accept</button><button onclick="updateStatus(${t.id}, 'Pending')" class="btn btn-outline-danger btn-sm flex-fill">Reject</button></div>`
                                    : `<div class="alert alert-info py-1 px-2 mt-2 small mb-0 text-center">Under Review</div>`;
                            } else {
                                actionBtns = `<button onclick="openSubmit(${t.id}, '${t.task_title}')" class="btn btn-outline-secondary btn-sm w-100 mt-2">Submit File</button>`;
                            }

                            // Slider Input
                            const slider = isMyTask ? `
                                <div class="mt-3 pt-3 border-top border-secondary border-opacity-25">
                                    <div class="d-flex justify-content-between mb-1">
                                        <label class="mono-label">My Progress</label>
                                        <span class="small fw-bold text-primary" id="prog-txt-${t.id}">${t.progress}%</span>
                                    </div>
                                    <input type="range" min="0" max="100" value="${t.progress}" 
                                        oninput="document.getElementById('prog-txt-${t.id}').innerText = this.value + '%'"
                                        onchange="updateProgress(${t.id}, this.value)">
                                </div>
                            ` : `<div class="mt-3 pt-3 border-top border-secondary border-opacity-25"><div class="d-flex justify-content-between"><span class="mono-label">Progress</span><span class="small fw-bold text-white">${t.progress}%</span></div><div class="progress h-1 mt-1 bg-dark"><div class="progress-bar" style="width:${t.progress}%"></div></div></div>`;

                            return `
                                <div class="col-12 col-md-6 col-xl-4">
                                    <div class="glass-panel p-3 h-100 d-flex flex-column">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <span class="badge bg-secondary text-white">${t.status}</span>
                                            ${t.priority === 'High' ? '<span class="text-danger small fw-bold">HIGH</span>' : ''}
                                        </div>
                                        <h5 class="fw-bold mb-1">${t.task_title}</h5>
                                        <p class="text-muted small mb-auto">${t.description}</p>
                                        ${slider}
                                        ${actionBtns}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>`;
                }

                // 4. IDEAS (NOT YET) TAB
                if(STATE.page === 'idea') {
                    const ideas = tasks.filter(t => t.status === 'Idea');
                    
                    html = `
                        <div class="text-center mb-4">
                            <button onclick="openCreate('idea')" class="btn btn-outline-secondary dashed-border py-3 px-5">
                                <i data-lucide="plus-circle" class="me-2"></i> Add New Idea
                            </button>
                        </div>
                        <div class="row g-3">
                            ${ideas.map(t => `
                                <div class="col-12 col-md-6">
                                    <div class="glass-panel p-3 border-start border-4 border-info">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h5 class="fw-bold mb-1">${t.task_title}</h5>
                                                <p class="text-muted small mb-2">${t.description}</p>
                                            </div>
                                            <button onclick="updateStatus(${t.id}, 'Pending')" class="btn btn-sm btn-primary ms-2" title="Move to Tasks"><i data-lucide="arrow-up-right" size="16"></i> Active</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                            ${ideas.length === 0 ? '<p class="text-center text-muted">No ideas in the backlog.</p>' : ''}
                        </div>
                    `;
                }

                // 5. TEAM FEED
                if(STATE.page === 'feed') {
                    html = `
                        <div class="glass-panel p-3 mb-3" style="max-height:70vh; overflow-y:auto">
                            ${feed.map(f => `
                                <div class="chat-bubble ${f.subject.includes('LEADER') ? 'leader' : ''}">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="fw-bold text-white small">${f.subject}</span>
                                        <span class="text-muted text-xs">${new Date(f.created_at).toLocaleString()}</span>
                                    </div>
                                    <div class="text-light small">${f.details}</div>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="openCreate('feed')" class="btn btn-primary w-100">Post Message</button>
                    `;
                }

                // 6. DRIVE
                if(STATE.page === 'drive') {
                    const { data: doneTasks } = await sbClient.from('tasks').select('*').eq('status', 'Done').order('updated_at', {ascending:false});
                    
                    const driveCards = Object.keys(DRIVE_LINKS).map(k => `
                        <div class="col-6 col-md-3">
                            <a href="${DRIVE_LINKS[k]}" target="_blank" class="text-decoration-none">
                                <div class="glass-panel p-4 text-center h-100 hover-panel">
                                    <i data-lucide="folder" class="text-primary mb-2" size="32"></i>
                                    <div class="text-white fw-bold">${k}</div>
                                </div>
                            </a>
                        </div>
                    `).join('');

                    html = `
                        <div class="row g-3 mb-5">${driveCards}</div>
                        <h6 class="mono-label mb-3">Completed Archive</h6>
                        <div class="glass-panel overflow-hidden">
                            <table class="table table-dark table-hover mb-0 small">
                                <thead><tr><th>Task</th><th class="text-end">Date</th></tr></thead>
                                <tbody>
                                    ${doneTasks.map(t => `<tr><td class="p-3">${t.task_title}</td><td class="p-3 text-end text-muted">${new Date(t.updated_at).toLocaleDateString()}</td></tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                container.innerHTML = html;
                lucide.createIcons();
            } catch (e) {
                container.innerHTML = `<div class="alert alert-danger">Error loading data: ${e.message}</div>`;
            }
        }

        // --- ACTIONS & LOGIC ---
        function openCreate(type) {
            if(type) {
                document.getElementById('ct-'+ (type==='feed'?'msg':type)).checked = true;
                toggleForm(type === 'feed' ? 'feed' : type);
            }
            // Populate Members
            const memDiv = document.getElementById('div-mems');
            memDiv.innerHTML = TEAM.map(u => `
                <input type="checkbox" class="btn-check" id="chk-${u.id}" value="${u.id}">
                <label class="btn btn-outline-secondary btn-sm" for="chk-${u.id}">${u.name.split(' ')[0]}</label>
            `).join('');
            
            MODAL_CREATE.show();
        }

        function openCreateWithDate(date) {
            openCreate('task');
            document.getElementById('inp-date').value = date;
        }

        function toggleForm(type) {
            STATE.createMode = type;
            const taskOpts = document.getElementById('form-task-opts');
            if (type === 'task') taskOpts.classList.remove('d-none');
            else taskOpts.classList.add('d-none');
        }

        async function saveItem() {
            const title = document.getElementById('inp-title').value;
            const desc = document.getElementById('inp-desc').value;
            
            if(!title) return alert('Title required');

            if(STATE.createMode === 'feed') {
                await sbClient.from('decisions').insert({
                    subject: `${STATE.user.name} [${STATE.user.role}]`,
                    details: `${title} - ${desc}`
                });
            } else {
                const status = STATE.createMode === 'idea' ? 'Idea' : (STATE.user.role === 'LEADER' ? 'Pending' : 'ApprovalReq');
                const mems = [...document.querySelectorAll('#div-mems input:checked')].map(c => parseInt(c.value));
                
                await sbClient.from('tasks').insert({
                    task_title: title,
                    description: desc,
                    status: status,
                    creator_id: STATE.user.id,
                    tagged_members: mems,
                    due_date: document.getElementById('inp-date').value || null,
                    priority: document.getElementById('inp-prio').value,
                    progress: 0
                });
            }
            
            MODAL_CREATE.hide();
            // Clear inputs
            document.getElementById('inp-title').value = '';
            document.getElementById('inp-desc').value = '';
            showToast('Item created successfully');
            render();
        }

        async function updateProgress(id, val) {
            // Optimistic UI update already happened via oninput, now save to DB
            await sbClient.from('tasks').update({ progress: parseInt(val), updated_at: new Date() }).eq('id', id);
            // No full re-render needed for performance, but good to refresh eventually
        }

        async function updateStatus(id, status) {
            await sbClient.from('tasks').update({ status: status, updated_at: new Date() }).eq('id', id);
            showToast(`Status updated to ${status}`);
            render();
        }

        // --- SUBMISSION LOGIC ---
        function openSubmit(id, title) {
            STATE.activeTaskForSub = { id, title };
            MODAL_SUBMIT.show();
        }

        function openDriveLink(type) {
            STATE.selectedDrive = type;
            window.open(DRIVE_LINKS[type], '_blank');
        }

        async function confirmSubmit() {
            if(!STATE.selectedDrive) return alert('Please click a drive folder first');
            
            const note = document.getElementById('sub-note').value;
            await sbClient.from('tasks').update({ status: 'Review', updated_at: new Date() }).eq('id', STATE.activeTaskForSub.id);
            await sbClient.from('decisions').insert({
                subject: `FILE SUBMISSION: ${STATE.activeTaskForSub.title}`,
                details: `Uploaded to ${STATE.selectedDrive}. Note: ${note}`
            });

            MODAL_SUBMIT.hide();
            showToast('Submitted for Review');
            render();
        }

        function showToast(msg) {
            document.getElementById('toast-msg').innerText = msg;
            const toast = new bootstrap.Toast(document.getElementById('sysToast'));
            toast.show();
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
