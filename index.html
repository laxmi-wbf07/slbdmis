<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLBDMIS - Management System</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- THEME CONFIGURATION --- */
        :root {
            --bg-dark: #0F172A;
            --bg-card: #1E293B;
            --bg-hover: #334155;
            --primary: #3B82F6;
            --primary-hover: #2563EB;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --text-main: #F8FAFC;
            --text-muted: #94A3B8;
        }

        /* --- GLOBAL STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', system-ui, sans-serif; }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* --- UTILITY CLASSES --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .grid { display: grid; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }
        .text-sm { font-size: 0.875rem; }
        .text-muted { color: var(--text-muted); }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        
        /* Glassmorphism Card Style */
        .card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        /* --- BUTTONS & INPUTS --- */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn-success { background: var(--success); color: white; }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--bg-hover); }
        .btn-ghost:hover { background: var(--bg-hover); color: white; }

        input, select, textarea {
            background: var(--bg-hover);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            width: 100%;
            outline: none;
            margin-bottom: 1rem;
        }
        input:focus { border-color: var(--primary); }

        /* --- BADGES --- */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
        .badge-Urgent { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .badge-High { background: rgba(245, 158, 11, 0.2); color: #F59E0B; }
        .badge-Normal { background: rgba(59, 130, 246, 0.2); color: #3B82F6; }
        .badge-Low { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .badge-Waiting { background: rgba(148, 163, 184, 0.2); color: #94A3B8; }
        .badge-Ongoing { background: rgba(59, 130, 246, 0.2); color: #3B82F6; }
        .badge-Done { background: rgba(16, 185, 129, 0.2); color: #10B981; }

        /* --- LOGIN PAGE --- */
        #login-view {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at top, #1E293B 0%, #0F172A 100%);
            padding: 20px;
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .avatar-card {
            background: var(--bg-card);
            padding: 1.5rem 0.5rem;
            border-radius: 1rem;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .avatar-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .avatar-card.selected { border-color: var(--primary); background: rgba(59, 130, 246, 0.1); }
        .avatar-emoji { font-size: 3rem; margin-bottom: 0.5rem; display: block; }

        /* --- DASHBOARD LAYOUT --- */
        #dashboard-view { display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar (Desktop) */
        .sidebar {
            width: 260px;
            background: var(--bg-card);
            border-right: 1px solid rgba(255,255,255,0.05);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }

        .nav-item {
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 500;
        }
        .nav-item:hover, .nav-item.active { background: var(--bg-hover); color: white; }
        .nav-item.active { background: var(--primary); }

        /* Main Content Area */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            position: relative;
        }

        /* Mobile Bottom Nav */
        .mobile-nav {
            display: none;
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--bg-card);
            padding: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
            justify-content: space-around;
            z-index: 50;
        }

        /* --- RESPONSIVE ADJUSTMENTS --- */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .mobile-nav { display: flex; }
            .main-content { padding: 1rem; padding-bottom: 80px; }
            .avatar-grid { grid-template-columns: repeat(2, 1fr); }
            /* Center the last item if odd number */
            .avatar-grid > *:last-child:nth-child(odd) { grid-column: span 2; } 
        }

        /* --- LOADING SPINNER --- */
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 24px; height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="login-view">
        <div class="card" style="width: 100%; max-width: 800px; padding: 2rem;">
            <div class="text-center">
                <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem; font-weight: 800;">SLBDMIS</h1>
                <p class="text-muted">Lead-Filter Pro Tracking System</p>
            </div>

            <div id="avatar-container" class="avatar-grid"></div>

            <div id="login-form" class="hidden text-center" style="animation: fadeIn 0.3s ease-in;">
                <input type="password" id="cid-input" placeholder="Enter CID to Verify" 
                       style="max-width: 300px; text-align: center; font-size: 1.1rem; letter-spacing: 2px;">
                <p id="login-error" class="text-center" style="color: var(--danger); height: 20px; font-size: 0.9rem; margin-bottom: 10px;"></p>
                <button onclick="handleLogin()" class="btn btn-primary" style="width: 100%; max-width: 300px;">
                    Access Dashboard
                </button>
            </div>
        </div>
    </div>

    <div id="dashboard-view" class="hidden">
        
        <nav class="sidebar">
            <div class="flex" style="align-items: center; gap: 10px; margin-bottom: 3rem;">
                <div style="background: var(--primary); padding: 8px; border-radius: 8px;">
                    <i data-lucide="layout-grid" color="white"></i>
                </div>
                <div>
                    <div class="font-bold">SLBDMIS</div>
                    <div class="text-sm text-muted">System v2.0</div>
                </div>
            </div>
            
            <div id="desktop-nav-links">
                </div>

            <div style="margin-top: auto;">
                <div class="nav-item" onclick="location.reload()">
                    <i data-lucide="log-out"></i> Logout
                </div>
            </div>
        </nav>

        <main class="main-content">
            <header class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h2 id="page-title" class="font-bold" style="font-size: 1.5rem;">Overview</h2>
                    <p class="text-muted text-sm">Welcome back, <span id="user-name">User</span></p>
                </div>
                <div class="flex" style="gap: 10px;">
                    <button onclick="showModal('task-modal')" class="btn btn-primary">
                        <i data-lucide="plus"></i> <span style="display: none; @media(min-width: 600px){ display: inline; }">New Task</span>
                    </button>
                    <button onclick="navigate(APP_STATE.currentPage)" class="btn btn-ghost">
                        <i data-lucide="refresh-cw"></i>
                    </button>
                </div>
            </header>

            <div id="content-area">
                </div>
        </main>

        <nav id="mobile-nav-links" class="mobile-nav"></nav>
    </div>

    <div id="task-modal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: flex; align-items: center; justify-content: center;">
        <div class="card" style="width: 90%; max-width: 500px; padding: 2rem;">
            <h3 class="font-bold" style="font-size: 1.25rem; margin-bottom: 1.5rem;">Create New Task</h3>
            
            <label class="text-sm text-muted">Task Title</label>
            <input id="new-task-title" placeholder="e.g. Update Homepage">
            
            <label class="text-sm text-muted">Description</label>
            <textarea id="new-task-desc" rows="3" placeholder="Details..."></textarea>
            
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <label class="text-sm text-muted">Project</label>
                    <select id="new-task-project">
                        <option value="General">General</option>
                        <option value="Website">Website</option>
                        <option value="Finance">Finance</option>
                        <option value="HR">HR</option>
                    </select>
                </div>
                <div>
                    <label class="text-sm text-muted">Priority</label>
                    <select id="new-task-priority">
                        <option value="Normal">Normal</option>
                        <option value="High">High</option>
                        <option value="Urgent">Urgent</option>
                    </select>
                </div>
            </div>

            <label class="text-sm text-muted">Due Date</label>
            <input type="date" id="new-task-date">

            <div class="flex" style="gap: 10px; margin-top: 1rem;">
                <button onclick="submitTask()" class="btn btn-primary w-full">Submit Suggestion</button>
                <button onclick="closeModal('task-modal')" class="btn btn-ghost w-full">Cancel</button>
            </div>
        </div>
    </div>

    <div id="approval-modal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: flex; align-items: center; justify-content: center;">
        <div class="card" style="width: 90%; max-width: 500px; padding: 2rem;">
            <h3 class="font-bold" style="font-size: 1.25rem; margin-bottom: 1.5rem;">Approve & Assign</h3>
            <input type="hidden" id="approve-task-id">
            
            <label class="text-sm text-muted">Assign To Member</label>
            <select id="assignee-select"></select>

            <div class="flex" style="gap: 10px; margin-top: 2rem;">
                <button onclick="confirmApproval()" class="btn btn-success w-full">Approve Task</button>
                <button onclick="closeModal('approval-modal')" class="btn btn-ghost w-full">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const SUPABASE_URL = 'https://bzrkbjjgymdbbwpatfct.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6cmtiampneW1kYmJ3cGF0ZmN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTcyNjcsImV4cCI6MjA4NTg3MzI2N30.Icv1daEp7NophE_ktPl2G1EgDP6awo0tyV14yh3Q4Sw';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 2. APP STATE ---
        const APP_STATE = {
            currentUser: null,
            currentPage: 'overview',
            selectedAvatarId: null
        };

        const TEAM = [
            { id: 1, name: "Pema Ugyen Namdrol Jamtsho", avatar: "ðŸ‘¨â€ðŸ’¼", cid: "11107008201", role: "LEADER", color: "#FF6B6B" },
            { id: 2, name: "Jamphel Kuendhen", avatar: "ðŸ‘¨â€ðŸ’»", cid: "11302003634", role: "MEMBER", color: "#4ECDC4" },
            { id: 3, name: "Kuenley Thujee Yangchen", avatar: "ðŸ‘©â€ðŸ’»", cid: "11006001849", role: "MEMBER", color: "#45B7D1" },
            { id: 4, name: "Laxmi Prasad Dhakal", avatar: "ðŸ‘¨â€ðŸ”§", cid: "11103002151", role: "MEMBER", color: "#FFA07A" },
            { id: 5, name: "Ngawang Jigme Dorji", avatar: "ðŸ‘¨â€ðŸŽ“", cid: "10801003243", role: "MEMBER", color: "#98D8C8" }
        ];

        // --- 3. INIT ---
        window.onload = () => {
            renderLoginScreen();
            lucide.createIcons();
        };

        // --- 4. AUTHENTICATION ---
        function renderLoginScreen() {
            const container = document.getElementById('avatar-container');
            container.innerHTML = TEAM.map(u => `
                <div class="avatar-card" onclick="selectAvatar(${u.id}, this)">
                    <span class="avatar-emoji">${u.avatar}</span>
                    <div style="font-weight: 700; font-size: 0.9rem;">${u.name.split(' ')[0]}</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">${u.role}</div>
                </div>
            `).join('');
        }

        function selectAvatar(id, element) {
            document.querySelectorAll('.avatar-card').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            APP_STATE.selectedAvatarId = id;
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('cid-input').value = '';
            document.getElementById('cid-input').focus();
        }

        function handleLogin() {
            const inputCid = document.getElementById('cid-input').value.trim();
            const user = TEAM.find(u => u.id === APP_STATE.selectedAvatarId);
            
            if (user && user.cid === inputCid) {
                APP_STATE.currentUser = user;
                initDashboard();
            } else {
                const err = document.getElementById('login-error');
                err.innerText = "âŒ Incorrect CID. Try again.";
                setTimeout(() => err.innerText = '', 2000);
            }
        }

        // --- 5. DASHBOARD NAVIGATION ---
        function initDashboard() {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
            document.getElementById('user-name').innerText = APP_STATE.currentUser.name.split(' ')[0];
            
            const isLeader = APP_STATE.currentUser.role === 'LEADER';
            
            // Define Pages
            const pages = [
                { id: 'overview', icon: 'layout-dashboard', label: 'Overview' },
                { id: 'tasks', icon: 'check-square', label: 'Tasks' },
                { id: 'attendance', icon: 'calendar', label: 'Attendance' },
                { id: 'decisions', icon: 'file-text', label: 'Decisions' },
                { id: 'opportunities', icon: 'zap', label: 'Opportunities' }
            ];

            if (isLeader) {
                pages.splice(2, 0, { id: 'approvals', icon: 'inbox', label: 'Approvals' });
            }

            // Render Nav
            const navHTML = pages.map(p => `
                <div class="nav-item" id="nav-${p.id}" onclick="navigate('${p.id}')">
                    <i data-lucide="${p.icon}" size="20"></i> ${p.label}
                </div>
            `).join('');
            document.getElementById('desktop-nav-links').innerHTML = navHTML;

            const mobileHTML = pages.map(p => `
                <div class="text-center p-2" style="color: var(--text-muted);" onclick="navigate('${p.id}')">
                    <i data-lucide="${p.icon}" size="20"></i>
                    <div style="font-size: 0.65rem; margin-top: 4px;">${p.label}</div>
                </div>
            `).join('');
            document.getElementById('mobile-nav-links').innerHTML = mobileHTML;

            navigate('overview');
        }

        async function navigate(pageId) {
            APP_STATE.currentPage = pageId;
            
            // Update Active State
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(document.getElementById(`nav-${pageId}`)) document.getElementById(`nav-${pageId}`).classList.add('active');
            
            document.getElementById('page-title').innerText = pageId.charAt(0).toUpperCase() + pageId.slice(1);
            
            const content = document.getElementById('content-area');
            content.innerHTML = '<div class="loader" style="margin-top: 50px;"></div>';

            try {
                if (pageId === 'overview') await renderOverview(content);
                else if (pageId === 'tasks') await renderTasks(content);
                else if (pageId === 'approvals') await renderApprovals(content);
                else if (pageId === 'attendance') await renderAttendance(content);
                else if (pageId === 'decisions') await renderDecisions(content);
                else if (pageId === 'opportunities') await renderOpportunities(content);
                lucide.createIcons();
            } catch (err) {
                content.innerHTML = `<div class="text-center text-muted">Error: ${err.message}</div>`;
            }
        }

        // --- 6. PAGE RENDERERS ---

        async function renderOverview(container) {
            // Fetch Data
            const { data: tasks } = await supabase.from('tasks').select('*');
            const { data: attendance } = await supabase.from('attendance').select('*').eq('date', new Date().toISOString().split('T')[0]);
            
            const myTasks = APP_STATE.currentUser.role === 'MEMBER' 
                ? tasks.filter(t => t.assignee_id === APP_STATE.currentUser.id)
                : tasks;

            const waiting = tasks.filter(t => t.status === 'Waiting').length;
            const active = myTasks.filter(t => t.status === 'Ongoing').length;
            const done = myTasks.filter(t => t.status === 'Done').length;
            const teamAtt = attendance ? Math.round((attendance.length / 5) * 100) : 0;

            container.innerHTML = `
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div class="card p-6">
                        <div class="text-muted text-sm">Active Tasks</div>
                        <div class="font-bold" style="font-size: 2rem; color: var(--primary);">${active}</div>
                    </div>
                    <div class="card p-6">
                        <div class="text-muted text-sm">Completed</div>
                        <div class="font-bold" style="font-size: 2rem; color: var(--success);">${done}</div>
                    </div>
                    <div class="card p-6">
                        <div class="text-muted text-sm">Waiting Approval</div>
                        <div class="font-bold" style="font-size: 2rem; color: var(--warning);">${waiting}</div>
                    </div>
                    <div class="card p-6">
                        <div class="text-muted text-sm">Today's Attendance</div>
                        <div class="font-bold" style="font-size: 2rem;">${teamAtt}%</div>
                    </div>
                </div>

                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    <div class="card p-6" style="height: 350px; position: relative;">
                        <h3 class="font-bold mb-4">Task Status</h3>
                        <canvas id="statusChart"></canvas>
                    </div>
                    <div class="card p-6" style="height: 350px; position: relative;">
                        <h3 class="font-bold mb-4">Priority Breakdown</h3>
                        <canvas id="priorityChart"></canvas>
                    </div>
                </div>
            `;

            // Charts
            new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Done', 'Ongoing', 'Waiting'],
                    datasets: [{
                        data: [done, tasks.filter(t=>t.status==='Ongoing').length, waiting],
                        backgroundColor: ['#10B981', '#3B82F6', '#94A3B8'],
                        borderWidth: 0
                    }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#94A3B8' } } } }
            });

            new Chart(document.getElementById('priorityChart'), {
                type: 'bar',
                data: {
                    labels: ['Urgent', 'High', 'Normal'],
                    datasets: [{
                        label: 'Tasks',
                        data: [
                            tasks.filter(t=>t.priority==='Urgent').length,
                            tasks.filter(t=>t.priority==='High').length,
                            tasks.filter(t=>t.priority==='Normal').length
                        ],
                        backgroundColor: ['#EF4444', '#F59E0B', '#3B82F6']
                    }]
                },
                options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94A3B8' } }, x: { grid: { display: false }, ticks: { color: '#94A3B8' } } }, plugins: { legend: { display: false } } }
            });
        }

        async function renderTasks(container) {
            let query = supabase.from('tasks').select('*, users!assignee_id(name)').order('created_at', { ascending: false });
            
            if (APP_STATE.currentUser.role === 'MEMBER') {
                query = query.or(`assignee_id.eq.${APP_STATE.currentUser.id},creator_id.eq.${APP_STATE.currentUser.id}`);
            }
            
            const { data: tasks } = await query;

            if (!tasks || tasks.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-6">No tasks found. Create one!</div>';
                return;
            }

            container.innerHTML = tasks.map(t => `
                <div class="card p-4 mb-4 flex" style="justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <div class="flex" style="gap: 8px; margin-bottom: 8px;">
                            <span class="badge badge-${t.priority}">${t.priority}</span>
                            <span class="badge badge-${t.status}">${t.status}</span>
                        </div>
                        <h3 class="font-bold">${t.task_title}</h3>
                        <p class="text-sm text-muted mt-1">${t.description || 'No description'}</p>
                        <div class="text-sm text-muted mt-2">
                            <i data-lucide="calendar" size="12"></i> Due: ${t.due_date || 'N/A'} â€¢ 
                            <i data-lucide="user" size="12"></i> ${t.users ? t.users.name.split(' ')[0] : 'Unassigned'}
                        </div>
                    </div>
                    ${t.status === 'Ongoing' && (APP_STATE.currentUser.role === 'LEADER' || t.assignee_id === APP_STATE.currentUser.id) ? 
                        `<button onclick="updateTaskStatus('${t.id}', 'Done')" class="btn btn-success btn-sm">
                            <i data-lucide="check"></i> Mark Done
                        </button>` : ''}
                </div>
            `).join('');
        }

        async function renderApprovals(container) {
            const { data: tasks } = await supabase.from('tasks').select('*, users!creator_id(name)').eq('status', 'Waiting');

            if (!tasks || tasks.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-6">No tasks waiting for approval.</div>';
                return;
            }

            container.innerHTML = tasks.map(t => `
                <div class="card p-4 mb-4" style="border-left: 4px solid var(--warning);">
                    <div class="flex" style="justify-content: space-between; align-items: center;">
                        <div>
                            <h3 class="font-bold">${t.task_title}</h3>
                            <p class="text-sm text-muted">Proposed by ${t.users.name}</p>
                        </div>
                        <button onclick="openApprovalModal('${t.id}')" class="btn btn-primary">Review</button>
                    </div>
                </div>
            `).join('');
        }

        async function renderAttendance(container) {
            const today = new Date().toISOString().split('T')[0];
            const { data: myAtt } = await supabase.from('attendance').select('*').eq('user_id', APP_STATE.currentUser.id).eq('date', today).single();
            const { data: history } = await supabase.from('attendance').select('*, users(name, avatar)').order('date', {ascending: false}).limit(10);

            container.innerHTML = `
                <div class="card p-6 mb-6 flex" style="justify-content: space-between; align-items: center; background: linear-gradient(to right, rgba(59, 130, 246, 0.1), transparent);">
                    <div>
                        <h3 class="font-bold text-lg">Today's Attendance</h3>
                        <div class="text-muted text-sm">${new Date().toDateString()}</div>
                    </div>
                    ${myAtt 
                        ? `<span class="badge badge-Done" style="font-size: 1rem; padding: 10px 20px;">âœ… ${myAtt.status}</span>` 
                        : `<button onclick="markAttendance()" class="btn btn-primary">ðŸ‘‹ Mark Present</button>`}
                </div>

                <h3 class="font-bold mb-4">Recent Activity</h3>
                <div class="card p-0" style="overflow: hidden;">
                    ${history.map(h => `
                        <div class="p-4 flex" style="justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <div class="flex" style="gap: 10px; align-items: center;">
                                <span style="font-size: 1.2rem;">${h.users.avatar}</span>
                                <div>
                                    <div class="font-bold text-sm">${h.users.name.split(' ')[0]}</div>
                                    <div class="text-muted" style="font-size: 0.7rem;">${h.date}</div>
                                </div>
                            </div>
                            <span class="badge badge-Done">${h.status}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function renderDecisions(container) {
            const { data: decisions } = await supabase.from('decisions').select('*, users!proposed_by(name)').order('created_at', { ascending: false });

            container.innerHTML = `
                <div class="mb-4">
                     <button class="btn btn-primary w-full" onclick="alert('Feature coming in update')">Propose New Decision</button>
                </div>
                ${decisions.map(d => `
                    <div class="card p-4 mb-4">
                        <div class="flex" style="justify-content: space-between;">
                            <h4 class="font-bold">${d.subject}</h4>
                            ${d.is_verified ? '<span class="badge badge-Done">Verified</span>' : '<span class="badge badge-Waiting">Pending</span>'}
                        </div>
                        <p class="text-sm text-muted mt-2">${d.details || ''}</p>
                        <div class="text-xs text-muted mt-2">Proposed by: ${d.users.name}</div>
                        ${!d.is_verified && APP_STATE.currentUser.role === 'LEADER' ? 
                            `<button onclick="verifyDecision('${d.id}')" class="btn btn-success btn-sm mt-3">Verify Decision</button>` : ''}
                    </div>
                `).join('')}
            `;
        }

        async function renderOpportunities(container) {
            const { data: opps } = await supabase.from('opportunities').select('*');
            container.innerHTML = `
                <div class="card p-6 text-center text-muted">
                    <i data-lucide="construction" size="40" style="margin-bottom: 10px;"></i>
                    <p>Opportunities Board coming soon.</p>
                </div>
            `;
        }

        // --- 7. ACTIONS ---

        async function submitTask() {
            const title = document.getElementById('new-task-title').value;
            const desc = document.getElementById('new-task-desc').value;
            const project = document.getElementById('new-task-project').value;
            const priority = document.getElementById('new-task-priority').value;
            const date = document.getElementById('new-task-date').value;

            if(!title) return alert('Title is required');

            const { error } = await supabase.from('tasks').insert({
                task_title: title,
                description: desc,
                project_name: project,
                priority: priority,
                due_date: date,
                creator_id: APP_STATE.currentUser.id,
                status: 'Waiting'
            });

            if(error) alert('Error: ' + error.message);
            else {
                closeModal('task-modal');
                navigate('overview');
            }
        }

        function openApprovalModal(taskId) {
            document.getElementById('approve-task-id').value = taskId;
            const select = document.getElementById('assignee-select');
            select.innerHTML = TEAM.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
            showModal('approval-modal');
        }

        async function confirmApproval() {
            const taskId = document.getElementById('approve-task-id').value;
            const assigneeId = document.getElementById('assignee-select').value;
            
            await supabase.from('tasks').update({
                status: 'Ongoing',
                assignee_id: assigneeId
            }).eq('id', taskId);

            closeModal('approval-modal');
            navigate('approvals');
        }

        async function updateTaskStatus(id, status) {
            if(!confirm('Mark this task as done?')) return;
            await supabase.from('tasks').update({ status: status, completed_at: new Date().toISOString() }).eq('id', id);
            navigate('tasks');
        }

        async function markAttendance() {
            const { error } = await supabase.from('attendance').insert({
                user_id: APP_STATE.currentUser.id,
                date: new Date().toISOString().split('T')[0],
                status: 'Present'
            });
            if(error) alert('Already marked for today!');
            else navigate('attendance');
        }

        async function verifyDecision(id) {
            await supabase.from('decisions').update({ is_verified: true, verified_by: APP_STATE.currentUser.id }).eq('id', id);
            navigate('decisions');
        }

        function showModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

    </script>
</body>
</html>
