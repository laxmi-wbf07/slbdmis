<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SLBDMIS | Pro</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- PREMIUM OVERRIDES --- */
        :root {
            --bs-body-bg: #0F172A; /* Slate 900 */
            --bs-body-color: #F8FAFC;
            --bs-primary: #3B82F6;
            --bs-primary-rgb: 59, 130, 246;
            --glass-bg: rgba(30, 41, 59, 0.65);
            --glass-border: rgba(255, 255, 255, 0.08);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; -webkit-font-smoothing: antialiased; padding-bottom: calc(70px + var(--safe-bottom)); }
        
        /* Glass Cards */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .form-control, .form-select {
            background-color: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--glass-border);
            color: #fff;
            padding: 0.8rem;
            border-radius: 0.6rem;
        }
        .form-control:focus, .form-select:focus {
            background-color: rgba(15, 23, 42, 0.8);
            border-color: var(--bs-primary);
            box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25);
            color: #fff;
        }

        /* Sidebar (Desktop) */
        .sidebar {
            width: 260px;
            height: 100vh;
            position: fixed;
            top: 0; left: 0;
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            z-index: 1030;
            display: none; /* Hidden on mobile */
        }
        
        /* Mobile Nav */
        .mobile-nav {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--glass-border);
            padding-bottom: var(--safe-bottom);
            z-index: 1040;
        }
        .nav-link-mobile {
            color: #64748B;
            font-size: 0.7rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px 0;
            transition: 0.3s;
        }
        .nav-link-mobile.active { color: var(--bs-primary); }
        .nav-link-mobile.active svg { stroke-width: 2.5px; }

        /* Main Layout */
        .main-content { margin-left: 0; padding: 1.5rem; transition: 0.3s; }
        @media (min-width: 768px) {
            .sidebar { display: flex; flex-direction: column; }
            .main-content { margin-left: 260px; padding: 2.5rem; }
            .mobile-nav { display: none; }
            body { padding-bottom: 0; }
        }

        /* Utilities */
        .avatar-lg { width: 64px; height: 64px; font-size: 2.5rem; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.05); border-radius: 50%; }
        .avatar-md { width: 48px; height: 48px; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.05); border-radius: 50%; }
        
        .cursor-pointer { cursor: pointer; }
        .hover-scale { transition: transform 0.2s; }
        .hover-scale:active { transform: scale(0.97); }

        .badge-soft-primary { background: rgba(59, 130, 246, 0.15); color: #60A5FA; border: 1px solid rgba(59, 130, 246, 0.2); }
        .badge-soft-success { background: rgba(16, 185, 129, 0.15); color: #34D399; border: 1px solid rgba(16, 185, 129, 0.2); }
        .badge-soft-warning { background: rgba(245, 158, 11, 0.15); color: #FCD34D; border: 1px solid rgba(245, 158, 11, 0.2); }
        .badge-soft-danger { background: rgba(239, 68, 68, 0.15); color: #F87171; border: 1px solid rgba(239, 68, 68, 0.2); }

        /* Loading Spinner */
        #loader { position: fixed; inset: 0; background: var(--bs-body-bg); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        
        /* Sidebar Links */
        .nav-link-desktop {
            color: #94A3B8;
            padding: 0.8rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.25rem;
            display: flex; align-items: center; gap: 12px;
            font-weight: 500;
            transition: 0.2s;
            text-decoration: none;
        }
        .nav-link-desktop:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-link-desktop.active { background: var(--bs-primary); color: #fff; }

        /* Avatar Selection Grid */
        .avatar-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        @media (min-width: 500px) { .avatar-grid { grid-template-columns: repeat(3, 1fr); } }

        /* Hide scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 3000;">
        <div id="liveToast" class="toast align-items-center text-bg-success border-0 rounded-pill px-2" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body fw-bold" id="toast-msg">Action Successful</div>
            </div>
        </div>
    </div>

    <div id="login-view" class="d-none min-vh-100 d-flex align-items-center justify-content-center p-3">
        <div class="card p-4 p-md-5 w-100" style="max-width: 480px;">
            <div class="text-center mb-5">
                <h1 class="fw-bold mb-1">SLBDMIS</h1>
                <p class="text-secondary small">Secure Team Portal</p>
            </div>
            
            <div id="avatar-container" class="avatar-grid mb-4">
                </div>

            <div id="auth-box" class="d-none text-center fade-in">
                <div class="mb-3">
                    <input type="password" id="cid-input" class="form-control text-center fs-4 fw-bold letter-spacing-2" placeholder="Enter CID">
                    <div id="login-err" class="text-danger small mt-2 min-h-20"></div>
                </div>
                <button onclick="login()" class="btn btn-primary w-100 py-2 fw-bold">Authenticate</button>
            </div>
        </div>
    </div>

    <div id="dashboard-view" class="d-none">
        
        <nav class="sidebar p-4">
            <div class="d-flex align-items-center gap-3 mb-5">
                <div class="bg-primary rounded p-2 text-white lh-1">
                    <i data-lucide="layout-grid"></i>
                </div>
                <div>
                    <div class="fw-bold">SLBDMIS</div>
                    <div class="text-secondary" style="font-size: 0.7rem;">PRO EDITION</div>
                </div>
            </div>
            <div id="sidebar-links" class="flex-grow-1"></div>
            <button onclick="handleLogout()" class="btn btn-outline-danger w-100 d-flex align-items-center justify-content-center gap-2">
                <i data-lucide="log-out" size="16"></i> Logout
            </button>
        </nav>

        <main class="main-content">
            <header class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 id="page-title" class="fw-bold mb-0">Overview</h2>
                    <p class="text-secondary small mb-0">Hello, <span id="user-display" class="text-white fw-bold">User</span></p>
                </div>
                <div class="d-flex gap-2">
                     <button onclick="openCreateModal()" class="btn btn-primary d-flex align-items-center gap-2 rounded-pill px-3">
                        <i data-lucide="plus" size="18"></i> <span class="d-none d-sm-inline">Create</span>
                    </button>
                    <button onclick="handleLogout()" class="btn btn-danger d-md-none rounded-circle p-2" style="width:42px; height:42px;">
                        <i data-lucide="log-out" size="18"></i>
                    </button>
                </div>
            </header>

            <div id="content-area"></div>
        </main>

        <nav class="mobile-nav fixed-bottom d-md-none">
            <div class="container-fluid">
                <div class="row text-center" id="mobile-nav-links">
                    </div>
            </div>
        </nav>
    </div>

    <div class="modal fade" id="createModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content card border-0">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">New Item</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="btn-group w-100 mb-3" role="group">
                        <input type="radio" class="btn-check" name="createType" id="typeTask" value="task" checked onchange="setCreateMode('task')">
                        <label class="btn btn-outline-primary btn-sm" for="typeTask">Task</label>

                        <input type="radio" class="btn-check" name="createType" id="typeDec" value="decision" onchange="setCreateMode('decision')">
                        <label class="btn btn-outline-primary btn-sm" for="typeDec">Decision</label>

                        <input type="radio" class="btn-check" name="createType" id="typeOpp" value="opp" onchange="setCreateMode('opp')">
                        <label class="btn btn-outline-primary btn-sm" for="typeOpp">Not Yet</label>
                    </div>

                    <input type="text" id="create-title" class="form-control mb-3 fw-bold" placeholder="Subject / Title">
                    <textarea id="create-desc" class="form-control mb-3" rows="3" placeholder="Description..."></textarea>

                    <div id="task-fields">
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="small text-secondary mb-1">Priority</label>
                                <select id="create-priority" class="form-select form-select-sm">
                                    <option value="Normal">Normal</option>
                                    <option value="High">High</option>
                                    <option value="Urgent">Urgent</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="small text-secondary mb-1">Due Date</label>
                                <input type="date" id="create-date" class="form-control form-control-sm text-uppercase">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="small text-secondary fw-bold mb-2" id="tag-label">ASSIGN / TAG TEAM:</label>
                        <div id="tag-list" class="d-flex flex-wrap gap-2"></div>
                    </div>

                    <button onclick="submitCreate()" class="btn btn-success w-100 py-2 fw-bold">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="approveModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content card border-0">
                <div class="modal-body text-center p-4">
                    <h5 class="fw-bold mb-3">Assign Task</h5>
                    <input type="hidden" id="approve-id">
                    <select id="assign-select" class="form-select mb-3"></select>
                    <button onclick="confirmAssign()" class="btn btn-success w-100 mb-2">Confirm</button>
                    <button class="btn btn-link text-secondary text-decoration-none" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- CONFIG ---
        const SB_URL = 'https://bzrkbjjgymdbbwpatfct.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6cmtiampneW1kYmJ3cGF0ZmN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTcyNjcsImV4cCI6MjA4NTg3MzI2N30.Icv1daEp7NophE_ktPl2G1EgDP6awo0tyV14yh3Q4Sw';
        const sbClient = window.supabase.createClient(SB_URL, SB_KEY);

        const TEAM = [
            { id: 1, name: "Pema Ugyen", avatar: "üë®‚Äçüíº", cid: "11107008201", role: "LEADER" },
            { id: 2, name: "Jamphel", avatar: "üë®‚Äçüíª", cid: "11302003634", role: "MEMBER" },
            { id: 3, name: "Kuenley", avatar: "üë©‚Äçüíª", cid: "11006001849", role: "MEMBER" },
            { id: 4, name: "Laxmi", avatar: "üë®‚Äçüî¨", cid: "11103002151", role: "MEMBER" },
            { id: 5, name: "Ngawang", avatar: "üë©", cid: "10801003243", role: "MEMBER" }
        ];

        const STATE = { user: null, page: 'overview', createMode: 'task', selectedAvatar: null };
        let refreshInterval;
        let createModalInstance;
        let approveModalInstance;

        // --- INIT ---
        window.onload = () => {
            lucide.createIcons();
            createModalInstance = new bootstrap.Modal(document.getElementById('createModal'));
            approveModalInstance = new bootstrap.Modal(document.getElementById('approveModal'));
            
            const savedId = localStorage.getItem('slbd_uid');
            if (savedId) {
                const user = TEAM.find(u => u.id === parseInt(savedId));
                if (user) { STATE.user = user; initApp(); return; }
            }
            renderLoginView();
        };

        // --- AUTH ---
        function renderLoginView() {
            document.getElementById('loader').classList.add('d-none');
            document.getElementById('login-view').classList.remove('d-none');
            document.getElementById('avatar-container').innerHTML = TEAM.map(u => `
                <div class="card p-3 d-flex flex-column align-items-center hover-scale cursor-pointer" onclick="selectAvatar(${u.id}, this)">
                    <div style="font-size: 2.5rem;">${u.avatar}</div>
                    <div class="fw-bold mt-2 small text-nowrap">${u.name.split(' ')[0]}</div>
                </div>
            `).join('');
        }

        function selectAvatar(id, el) {
            document.querySelectorAll('.avatar-grid .card').forEach(e => {
                e.style.borderColor = 'var(--glass-border)';
                e.style.background = 'var(--glass-bg)';
            });
            el.style.borderColor = 'var(--bs-primary)';
            el.style.background = 'rgba(59, 130, 246, 0.1)';
            
            STATE.selectedAvatar = TEAM.find(u => u.id === id);
            document.getElementById('auth-box').classList.remove('d-none');
            document.getElementById('cid-input').value = '';
            document.getElementById('cid-input').focus();
        }

        function login() {
            if (document.getElementById('cid-input').value === STATE.selectedAvatar.cid) {
                STATE.user = STATE.selectedAvatar;
                localStorage.setItem('slbd_uid', STATE.user.id);
                initApp();
            } else {
                document.getElementById('login-err').innerText = "‚ùå Invalid CID";
            }
        }

        function handleLogout() {
            if(confirm('Secure Logout?')) {
                localStorage.removeItem('slbd_uid');
                location.reload();
            }
        }

        // --- APP SHELL ---
        function initApp() {
            document.getElementById('loader').classList.add('d-none');
            document.getElementById('login-view').classList.add('d-none');
            document.getElementById('dashboard-view').classList.remove('d-none');
            document.getElementById('user-display').innerText = STATE.user.name.split(' ')[0];

            const links = [
                { id: 'overview', icon: 'layout-dashboard', label: 'Home' },
                { id: 'tasks', icon: 'check-square', label: 'Tasks' },
                { id: 'attendance', icon: 'calendar', label: 'Check-in' },
                { id: 'decisions', icon: 'file-text', label: 'Votes' },
                { id: 'collab', icon: 'lightbulb', label: 'Not Yet' }
            ];
            if(STATE.user.role === 'LEADER') links.push({ id: 'team', icon: 'crown', label: 'Team' });

            // Render Navs
            const sbContainer = document.getElementById('sidebar-links');
            const mbContainer = document.getElementById('mobile-nav-links');
            
            sbContainer.innerHTML = links.map(l => `
                <a href="#" class="nav-link-desktop" id="nav-${l.id}" onclick="setPage('${l.id}')">
                    <i data-lucide="${l.icon}" size="18"></i> ${l.label}
                </a>
            `).join('');

            mbContainer.innerHTML = links.map(l => `
                <div class="col" onclick="setPage('${l.id}')">
                    <div class="nav-link-mobile" id="m-nav-${l.id}">
                        <i data-lucide="${l.icon}" size="20"></i>
                        <span>${l.label}</span>
                    </div>
                </div>
            `).join('');

            setPage('overview');
            refreshInterval = setInterval(() => renderPage(STATE.page, true), 8000);
        }

        function setPage(page) {
            STATE.page = page;
            // Update Active States
            document.querySelectorAll('.nav-link-desktop').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.nav-link-mobile').forEach(e => e.classList.remove('active'));
            
            const dLink = document.getElementById(`nav-${page}`);
            if(dLink) dLink.classList.add('active');
            
            const mLink = document.getElementById(`m-nav-${page}`);
            if(mLink) mLink.classList.add('active');

            const titles = {overview: 'Overview', tasks: 'Tasks Board', attendance: 'Attendance', decisions: 'Decision Log', collab: 'Idea Pool (Not Yet)', team: 'Team View'};
            document.getElementById('page-title').innerText = titles[page];
            
            renderPage(page, false);
        }

        // --- RENDERERS ---
        async function renderPage(page, silent) {
            const content = document.getElementById('content-area');
            if(!silent) content.innerHTML = '<div class="text-center py-5 text-secondary"><div class="spinner-border spinner-border-sm mb-2"></div><br>Syncing Data...</div>';

            try {
                if(page === 'overview') await renderOverview(content);
                else if(page === 'tasks') await renderTasks(content);
                else if(page === 'attendance') await renderAttendance(content);
                else if(page === 'decisions') await renderDecisions(content);
                else if(page === 'collab') await renderCollab(content);
                else if(page === 'team') await renderTeam(content);
                if(!silent) lucide.createIcons();
            } catch(e) {
                console.error(e);
                if(!silent) content.innerHTML = `<div class="alert alert-danger">Error loading data.</div>`;
            }
        }

        // 1. OVERVIEW
        async function renderOverview(c) {
            const startOfWeek = new Date(); startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
            const { data: tasks } = await sbClient.from('tasks').select('*');
            
            // Stats
            const weekTasks = tasks.filter(t => new Date(t.created_at) >= startOfWeek);
            const myFocus = tasks.filter(t => t.status === 'Ongoing' && (t.assignee_id === STATE.user.id || STATE.user.role === 'LEADER'));

            c.innerHTML = `
                <div class="card p-3 mb-4" style="height: 300px;">
                    <canvas id="chartOv"></canvas>
                </div>
                <h5 class="fw-bold mb-3">üî• Today's Focus</h5>
                <div class="row g-3">
                    ${myFocus.length ? myFocus.map(t => `
                        <div class="col-12 col-md-6">
                            <div class="card p-3 border-start border-3 border-primary h-100">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="badge badge-soft-${t.priority === 'Urgent' ? 'danger' : 'primary'}">${t.priority}</span>
                                    <small class="text-secondary">${t.due_date || ''}</small>
                                </div>
                                <div class="fw-bold text-truncate">${t.task_title}</div>
                            </div>
                        </div>
                    `).join('') : '<div class="col-12 text-secondary small text-center">No active focus tasks found.</div>'}
                </div>
            `;

            // Chart
            const dataDone = TEAM.map(u => weekTasks.filter(t => t.assignee_id === u.id && t.status === 'Done').length);
            const dataOn = TEAM.map(u => weekTasks.filter(t => t.assignee_id === u.id && t.status === 'Ongoing').length);
            
            new Chart(document.getElementById('chartOv'), {
                type: 'bar',
                data: {
                    labels: TEAM.map(u => u.name.split(' ')[0]),
                    datasets: [
                        { label: 'Done', data: dataDone, backgroundColor: '#10B981', borderRadius: 4 },
                        { label: 'Active', data: dataOn, backgroundColor: '#3B82F6', borderRadius: 4 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: {display:false} }, y: { grid: {color:'rgba(255,255,255,0.05)'} } }, plugins: { legend: { labels: { color: '#94a3b8' } } } }
            });
        }

        // 2. TASKS
        async function renderTasks(c) {
            let q = sbClient.from('tasks').select('*, users!assignee_id(name)').order('created_at', {ascending: false});
            if(STATE.user.role === 'MEMBER') q = q.or(`assignee_id.eq.${STATE.user.id},creator_id.eq.${STATE.user.id}`);
            const { data: tasks } = await q;

            const today = new Date().toISOString().split('T')[0];
            const active = tasks.filter(t => t.due_date === today || t.status === 'Ongoing');
            const backlog = tasks.filter(t => !active.includes(t));

            const card = (t) => `
                <div class="card p-3 mb-3 hover-scale">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="fw-bold mb-0 text-truncate" style="max-width: 70%;">${t.task_title}</h6>
                        <span class="badge badge-soft-${t.priority === 'Urgent' ? 'danger' : (t.priority === 'High' ? 'warning' : 'primary')}">${t.status}</span>
                    </div>
                    <p class="small text-secondary mb-2 text-truncate">${t.description || ''}</p>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <div class="d-flex gap-1">${renderTags(t.tagged_members)}</div>
                        <div class="d-flex gap-2">
                            ${t.status === 'Ongoing' ? `<button onclick="actionTask('${t.id}', 'Done')" class="btn btn-sm btn-success"><i data-lucide="check" size="14"></i></button>` : ''}
                            ${t.status === 'Waiting' && STATE.user.role === 'LEADER' ? `<button onclick="openApprove('${t.id}')" class="btn btn-sm btn-primary">Assign</button>` : ''}
                            ${STATE.user.role === 'LEADER' ? `<button onclick="deleteItem('tasks', '${t.id}')" class="btn btn-sm btn-outline-danger border-0"><i data-lucide="trash-2" size="14"></i></button>` : ''}
                        </div>
                    </div>
                </div>
            `;

            c.innerHTML = `
                <input type="text" class="form-control mb-4" placeholder="üîç Search tasks..." onkeyup="filterList(this)">
                <h6 class="text-primary fw-bold mb-3">üî• Active Focus</h6>
                ${active.length ? active.map(card).join('') : '<div class="text-secondary small mb-3">No active tasks.</div>'}
                
                <button class="btn btn-outline-secondary w-100 mt-2 btn-sm border-0 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#backlogCol">
                    üìÇ View Backlog / Future (${backlog.length}) ‚ñº
                </button>
                <div class="collapse mt-3" id="backlogCol">
                    ${backlog.map(card).join('')}
                </div>
            `;
        }

        // 3. TEAM VIEW (GOD MODE - CLEAN)
        async function renderTeam(c) {
            const { data: users } = await sbClient.from('users').select('*').neq('role', 'LEADER');
            const { data: tasks } = await sbClient.from('tasks').select('*');

            c.innerHTML = `<div class="row g-4">
                ${users.map(u => {
                    const myTasks = tasks.filter(t => t.assignee_id === u.id);
                    return `
                        <div class="col-12 col-xl-6">
                            <div class="card h-100">
                                <div class="card-body p-4">
                                    <div class="d-flex align-items-center gap-3 mb-4">
                                        <div class="avatar-lg fs-1">${u.avatar}</div>
                                        <div>
                                            <h5 class="fw-bold mb-0">${u.name}</h5>
                                            <small class="text-secondary badge badge-soft-primary">${u.role}</small>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex flex-col gap-2">
                                        ${myTasks.length ? myTasks.map(t => `
                                            <div class="p-2 rounded border border-secondary border-opacity-25 bg-black bg-opacity-25 d-flex justify-content-between align-items-center">
                                                <div class="small fw-bold text-truncate w-75">${t.task_title}</div>
                                                <span class="badge badge-soft-${t.status === 'Ongoing' ? 'warning' : 'secondary'} rounded-pill" style="font-size: 0.6rem;">${t.status}</span>
                                            </div>
                                        `).join('') : '<div class="text-center p-3 border border-dashed border-secondary border-opacity-25 rounded small text-secondary">No Active Tasks</div>'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>`;
        }

        // 4. ATTENDANCE, DECISIONS, COLLAB (Standardized)
        async function renderAttendance(c) {
            const today = new Date().toISOString().split('T')[0];
            const { data: att } = await sbClient.from('attendance').select('*').eq('user_id', STATE.user.id).eq('date', today).single();
            const { data: hist } = await sbClient.from('attendance').select('*, users(name, avatar)').order('date', {ascending:false}).limit(20);

            c.innerHTML = `
                <div class="card p-4 mb-4 d-flex flex-row justify-content-between align-items-center">
                    <div><div class="fw-bold text-white">Today</div><div class="small text-secondary">${today}</div></div>
                    ${att ? '<span class="badge bg-success fs-6">‚úÖ Checked In</span>' : '<button onclick="markPresent()" class="btn btn-primary fw-bold">Check In</button>'}
                </div>
                <div class="card overflow-hidden">
                    <ul class="list-group list-group-flush bg-transparent">
                        ${hist.map(h => `
                            <li class="list-group-item bg-transparent text-white border-secondary border-opacity-25 d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center gap-2">
                                    <span>${h.users.avatar}</span>
                                    <div class="lh-1"><div class="small fw-bold">${h.users.name.split(' ')[0]}</div><small class="text-secondary" style="font-size:0.7rem;">${h.date}</small></div>
                                </div>
                                <span class="badge badge-soft-success">Present</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }

        async function renderDecisions(c) {
            const { data: list } = await sbClient.from('decisions').select('*, users!proposed_by(name)').order('created_at', {ascending: false});
            c.innerHTML = list.map(d => `
                <div class="card p-3 mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <h6 class="fw-bold">${d.subject}</h6>
                        ${d.is_verified ? '‚úÖ' : '‚è≥'}
                    </div>
                    <p class="small text-secondary mb-2">${d.details}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted" style="font-size:0.7rem;">By ${d.users.name}</small>
                        <div class="d-flex gap-2">
                            ${!d.is_verified && STATE.user.role === 'LEADER' ? `<button onclick="verifyItem('decisions','${d.id}')" class="btn btn-sm btn-success py-0">Verify</button>` : ''}
                            ${STATE.user.role === 'LEADER' ? `<button onclick="deleteItem('decisions','${d.id}')" class="btn btn-sm text-danger p-0"><i data-lucide="trash-2" size="14"></i></button>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function renderCollab(c) {
            const { data: list } = await sbClient.from('opportunities').select('*, users!posted_by(name)').order('created_at', {ascending: false});
            c.innerHTML = list.map(o => `
                <div class="card p-3 mb-3">
                    <h6 class="fw-bold">${o.title}</h6>
                    <p class="small text-secondary">${o.description}</p>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                         <small class="text-muted" style="font-size:0.7rem;">By ${o.users.name}</small>
                        ${STATE.user.role === 'LEADER' ? `<button onclick="deleteItem('opportunities','${o.id}')" class="btn btn-sm text-danger p-0"><i data-lucide="trash-2" size="14"></i></button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // --- ACTIONS ---
        function toast(msg) {
            document.getElementById('toast-msg').innerText = msg;
            const t = new bootstrap.Toast(document.getElementById('liveToast'));
            t.show();
        }

        function setCreateMode(mode) {
            STATE.createMode = mode;
            document.getElementById('task-fields').classList.toggle('d-none', mode !== 'task');
            document.getElementById('tag-label').innerText = mode === 'task' ? 'ASSIGN TO (First selected)' : 'TAG MEMBERS';
            
            document.getElementById('tag-list').innerHTML = TEAM.filter(u => u.id !== STATE.user.id).map(u => `
                <input type="checkbox" class="btn-check tag-check" id="tag-${u.id}" value="${u.id}" autocomplete="off">
                <label class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-1" for="tag-${u.id}">${u.avatar} ${u.name.split(' ')[0]}</label>
            `).join('');
        }

        function openCreateModal() {
            document.getElementById('create-title').value = '';
            document.getElementById('create-desc').value = '';
            document.getElementById('typeTask').click(); // Default
            createModalInstance.show();
        }

        async function submitCreate() {
            const title = document.getElementById('create-title').value;
            const desc = document.getElementById('create-desc').value;
            const tags = Array.from(document.querySelectorAll('.tag-check:checked')).map(c => parseInt(c.value));
            
            if(!title) return toast('‚ùå Title required');

            let err;
            if(STATE.createMode === 'task') {
                const assignee = tags[0] || null;
                const status = (STATE.user.role === 'LEADER' && assignee) ? 'Ongoing' : 'Waiting';
                const { error } = await sbClient.from('tasks').insert({
                    task_title: title, description: desc, priority: document.getElementById('create-priority').value,
                    due_date: document.getElementById('create-date').value, creator_id: STATE.user.id,
                    assignee_id: assignee, tagged_members: tags, status: status
                });
                err = error;
            } else if(STATE.createMode === 'decision') {
                const { error } = await sbClient.from('decisions').insert({
                    subject: title, details: desc, proposed_by: STATE.user.id, tagged_members: tags,
                    is_verified: STATE.user.role === 'LEADER', verified_by: STATE.user.role === 'LEADER' ? STATE.user.id : null
                });
                err = error;
            } else {
                const { error } = await sbClient.from('opportunities').insert({
                    title: title, description: desc, posted_by: STATE.user.id, tagged_members: tags
                });
                err = error;
            }

            if(err) toast('Error: ' + err.message);
            else { createModalInstance.hide(); renderPage(STATE.page, true); toast('‚úÖ Created'); }
        }

        function openApprove(id) {
            document.getElementById('approve-id').value = id;
            document.getElementById('assign-select').innerHTML = TEAM.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
            approveModalInstance.show();
        }

        async function confirmAssign() {
            await sbClient.from('tasks').update({ status: 'Ongoing', assignee_id: document.getElementById('assign-select').value }).eq('id', document.getElementById('approve-id').value);
            approveModalInstance.hide(); renderPage('tasks', true); toast('‚úÖ Assigned');
        }

        async function actionTask(id, status) {
            await sbClient.from('tasks').update({ status: status }).eq('id', id);
            renderPage('tasks', true); toast('‚úÖ Updated');
        }

        async function verifyItem(tbl, id) {
            await sbClient.from(tbl).update({ is_verified: true, verified_by: STATE.user.id }).eq('id', id);
            renderPage(STATE.page, true); toast('‚úÖ Verified');
        }

        async function deleteItem(tbl, id) {
            if(confirm('Delete this item?')) {
                await sbClient.from(tbl).delete().eq('id', id);
                renderPage(STATE.page, true); toast('üóëÔ∏è Deleted');
            }
        }

        async function markPresent() {
            await sbClient.from('attendance').insert({ user_id: STATE.user.id });
            renderPage('attendance', true); toast('‚úÖ Checked In');
        }

        function filterList(inp) {
            const term = inp.value.toLowerCase();
            document.querySelectorAll('.card').forEach(c => {
                c.style.display = c.innerText.toLowerCase().includes(term) ? '' : 'none';
            });
        }

        function renderTags(ids) {
            if(!ids || !ids.length) return '';
            return ids.map(id => {
                const u = TEAM.find(x => x.id === id);
                return u ? `<span class="badge bg-secondary bg-opacity-25 text-info" style="font-size:0.6rem;">@${u.name.split(' ')[0]}</span>` : '';
            }).join('');
        }
    </script>
</body>
</html>
