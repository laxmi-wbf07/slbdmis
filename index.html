<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SLBDMIS | Team Portal</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* === THEME VARIABLES === */
        :root { 
            --bg-body: #0d1117; 
            --bg-card: #161b22; 
            --bg-subtle: #21262d;
            --border: #30363d;
            --primary: #2f81f7; 
            --success: #238636;
            --warning: #d29922;
            --text-main: #f0f6fc;
            --text-sub: #8b949e;
            --sidebar-w: 260px;
            --nav-h: 70px;
        }

        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
            /* Critical for Mobile: Prevent bottom nav from covering content */
            padding-bottom: 90px; 
        }

        /* === UTILITIES === */
        .glass { background: rgba(22, 27, 34, 0.95); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
        .card-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            transition: all 0.2s;
        }
        .card-box:active { transform: scale(0.99); }
        .text-xs { font-size: 0.75rem; }
        .fw-bold { font-weight: 600 !important; }
        .cursor-pointer { cursor: pointer; }
        
        /* Force element to hide (Fixes overlap issues) */
        .d-none-imp { display: none !important; }

        /* === LAYOUT SYSTEM === */
        
        /* 1. LOGIN SCREEN (Full Screen Overlay) */
        #view-auth {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: var(--bg-body);
            z-index: 99999; /* Extreme Z-Index to stay on top */
            display: flex; align-items: center; justify-content: center;
            padding: 20px;
        }
        
        /* 2. SIDEBAR (Desktop Only) */
        .sidebar {
            position: fixed; top: 0; left: 0; bottom: 0;
            width: var(--sidebar-w);
            background: #010409;
            border-right: 1px solid var(--border);
            padding: 24px;
            display: none; flex-direction: column;
            z-index: 1000;
        }

        /* 3. BOTTOM NAV (Mobile Only) */
        .mobile-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: var(--nav-h);
            background: rgba(13, 17, 23, 0.98);
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* 4. MAIN CONTENT WRAPPER */
        .main-wrapper {
            padding: 20px;
            max-width: 100%;
        }

        /* RESPONSIVE SWITCHER */
        @media (min-width: 992px) {
            .sidebar { display: flex; }
            .mobile-nav { display: none !important; }
            .mobile-header { display: none !important; }
            body { padding-bottom: 0; }
            .main-wrapper {
                margin-left: var(--sidebar-w);
                padding: 40px;
                max-width: 1200px;
            }
        }

        /* COMPONENT STYLES */
        .nav-item-d {
            display: flex; align-items: center; gap: 12px; padding: 12px;
            border-radius: 6px; color: var(--text-sub); text-decoration: none;
            margin-bottom: 2px; transition: 0.2s;
        }
        .nav-item-d:hover, .nav-item-d.active { background: var(--bg-subtle); color: white; }
        .nav-item-d.active { border-left: 3px solid var(--primary); }

        .nav-item-m {
            display: flex; flex-direction: column; align-items: center;
            color: var(--text-sub); font-size: 10px; text-decoration: none;
            width: 100%; padding: 8px 0;
        }
        .nav-item-m.active { color: var(--primary); }
        
        .avatar {
            width: 42px; height: 42px; border-radius: 50%;
            background: var(--bg-subtle); display: grid; place-items: center;
            font-size: 20px; border: 2px solid transparent;
        }

        .badge-st { padding: 4px 8px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .st-done { background: rgba(35, 134, 54, 0.2); color: #3fb950; }
        .st-wait { background: rgba(210, 153, 34, 0.2); color: #d29922; }
        .st-rev { background: rgba(56, 139, 253, 0.2); color: #58a6ff; }
        .st-fut { background: rgba(139, 148, 158, 0.2); color: #8b949e; }
    </style>
</head>
<body>

    <div id="view-auth">
        <div class="card-box p-4 w-100" style="max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.6);">
            <div class="text-center mb-4">
                <div class="d-inline-flex p-3 rounded-circle bg-primary bg-opacity-10 text-primary mb-3">
                    <i data-lucide="shield-check" size="32"></i>
                </div>
                <h3 class="fw-bold text-white">SLBDMIS Portal</h3>
                <p class="text-sub small">Secure Team Workspace</p>
            </div>
            
            <div id="auth-step-1" class="row g-2"></div>
            
            <div id="auth-step-2" class="d-none">
                <div class="d-flex align-items-center gap-3 p-3 rounded bg-dark border border-secondary border-opacity-25 mb-4">
                    <div id="auth-av" class="avatar fs-4"></div>
                    <div>
                        <div id="auth-name" class="fw-bold text-white"></div>
                        <div class="text-sub text-xs">Enter ID/PIN</div>
                    </div>
                </div>
                <input type="password" id="inp-pin" class="form-control form-control-lg bg-black text-white text-center border-secondary mb-3" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="11" inputmode="numeric">
                <button onclick="tryLogin()" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow">Login Access</button>
                <button onclick="authReset()" class="btn btn-link text-secondary w-100 text-decoration-none mt-2">Go Back</button>
            </div>
        </div>
    </div>

    <div id="view-app" class="d-none">
        
        <div class="mobile-header fixed-top glass border-bottom border-secondary border-opacity-25 px-3 py-3 d-flex justify-content-between align-items-center" style="z-index: 900;">
            <div class="d-flex align-items-center gap-2">
                <div id="mob-u-av" class="avatar" style="width:32px; height:32px; font-size:16px;"></div>
                <span id="mob-pg-title" class="fw-bold">Dashboard</span>
            </div>
            <div class="d-flex gap-2">
                <button onclick="checkNoti(true)" class="btn btn-dark btn-sm border border-secondary border-opacity-25 position-relative">
                    <i data-lucide="bell" size="18"></i>
                    <span id="badge-bell-m" class="position-absolute top-0 end-0 p-1 bg-danger rounded-circle d-none"></span>
                </button>
                <button onclick="openCreate()" class="btn btn-primary btn-sm shadow-sm"><i data-lucide="plus" size="18"></i></button>
            </div>
        </div>

        <nav class="sidebar">
            <div class="d-flex align-items-center gap-3 mb-5 px-2 text-white">
                <div class="bg-primary rounded p-1"><i data-lucide="layout-grid" size="24"></i></div>
                <span class="fw-bold fs-5">SLBDMIS</span>
            </div>
            <div id="nav-d-links" class="flex-grow-1"></div>
            <div class="mt-auto border-top border-secondary border-opacity-25 pt-3">
                <div class="d-flex align-items-center gap-3 px-2 mb-3">
                    <div id="desk-u-av" class="avatar"></div>
                    <div>
                        <div id="desk-u-name" class="fw-bold text-white small"></div>
                        <div class="text-success text-xs">‚óè Online</div>
                    </div>
                </div>
                <button onclick="doLogout()" class="btn btn-outline-danger btn-sm w-100">Sign Out</button>
            </div>
        </nav>

        <main class="main-wrapper" style="padding-top: 80px;">
            <div class="d-none d-lg-flex justify-content-between align-items-center mb-4 mt-n4">
                <h3 id="desk-pg-title" class="fw-bold m-0">Dashboard</h3>
                <div class="d-flex gap-2">
                    <button onclick="checkNoti(true)" class="btn btn-dark border border-secondary border-opacity-25 position-relative">
                        <i data-lucide="bell" size="20"></i>
                        <span id="badge-bell-d" class="position-absolute top-0 end-0 p-1 bg-danger rounded-circle d-none"></span>
                    </button>
                    <button onclick="openCreate()" class="btn btn-primary px-4 fw-bold shadow"><i data-lucide="plus" size="18" class="me-2"></i>New Item</button>
                </div>
            </div>
            <div id="content-box"></div>
        </main>

        <nav class="mobile-nav" id="nav-m-links"></nav>
    </div>

    <div class="modal fade" id="modCreate" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
            <div class="modal-content card-box border-0">
                <div class="modal-header border-bottom border-secondary border-opacity-25">
                    <h5 class="modal-title fw-bold">Create New</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="d-flex bg-dark p-1 rounded mb-4 border border-secondary border-opacity-25">
                        <button onclick="setMode('task')" id="bm-task" class="btn btn-sm text-white flex-fill bg-secondary bg-opacity-25">Task</button>
                        <button onclick="setMode('future')" id="bm-future" class="btn btn-sm text-secondary flex-fill">Not Yet</button>
                        <button onclick="setMode('dec')" id="bm-dec" class="btn btn-sm text-secondary flex-fill">Decision</button>
                    </div>
                    
                    <input type="text" id="inp-t" class="form-control form-control-lg bg-black text-white border-secondary mb-3" placeholder="Title">
                    <textarea id="inp-d" class="form-control bg-black text-white border-secondary mb-3" rows="3" placeholder="Details..."></textarea>
                    
                    <div id="sec-task-opt">
                        <label class="text-sub text-xs fw-bold mb-2">DUE DATE</label>
                        <input type="date" id="inp-date" class="form-control bg-black text-white border-secondary mb-3">
                        <label class="text-sub text-xs fw-bold mb-2">ASSIGN TO</label>
                        <div id="div-mems" class="d-flex flex-column gap-2 mb-4"></div>
                    </div>
                    
                    <button onclick="saveItem()" class="btn btn-primary w-100 py-3 rounded-pill fw-bold">Save Record</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modProof" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
            <div class="modal-content card-box border-0">
                <div class="modal-header border-bottom border-secondary border-opacity-25">
                    <h5 class="modal-title fw-bold">Proof of Work</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="d-grid gap-2 mb-4">
                        <a href="https://drive.google.com/drive/folders/1VskzY_IgfF6lagiEdaF5-yy6Te_u-MMG?usp=sharing" target="_blank" class="btn btn-dark text-start p-3 border border-secondary border-opacity-25"><i data-lucide="folder" class="me-2 text-warning inline"></i> Admin & Finance</a>
                        <a href="https://drive.google.com/drive/folders/1FivXbl7Qo5qnKV2Kn6DXxdtVUS4nB5CF?usp=sharing" target="_blank" class="btn btn-dark text-start p-3 border border-secondary border-opacity-25"><i data-lucide="cpu" class="me-2 text-info inline"></i> Machine Unit</a>
                        <a href="https://drive.google.com/drive/folders/11Q6gWSLqU4H88DrmWA_Fmbkx8dsNs0Ka?usp=sharing" target="_blank" class="btn btn-dark text-start p-3 border border-secondary border-opacity-25"><i data-lucide="image" class="me-2 text-danger inline"></i> Pictures</a>
                    </div>
                    <div class="form-check bg-black p-3 rounded border border-secondary border-opacity-25">
                        <input class="form-check-input" type="checkbox" id="chk-done" onchange="toggleFin()">
                        <label class="form-check-label text-white small">I have uploaded the files.</label>
                    </div>
                </div>
                <div class="modal-footer border-0 p-3">
                    <button id="btn-fin" onclick="finishTask()" class="btn btn-success w-100 py-3 rounded-pill fw-bold disabled">Mark Complete</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modNoti" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content card-box border-0">
                <div class="modal-header border-bottom border-secondary border-opacity-25">
                    <h5 class="modal-title fw-bold">Alerts</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="noti-list" class="list-group list-group-flush bg-transparent"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modArc" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content bg-dark">
                <div class="modal-header border-bottom border-secondary border-opacity-25">
                    <h5 class="modal-title fw-bold" id="arc-t">Archive</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="d-flex border-bottom border-secondary border-opacity-25">
                        <button onclick="loadArcTab('t')" class="btn btn-dark flex-fill rounded-0 py-3 active border-bottom border-primary border-2" id="at-t">Tasks</button>
                        <button onclick="loadArcTab('d')" class="btn btn-dark flex-fill rounded-0 py-3 text-secondary" id="at-d">Decisions</button>
                        <button onclick="loadArcTab('a')" class="btn btn-dark flex-fill rounded-0 py-3 text-secondary" id="at-a">Logs</button>
                    </div>
                    <div id="arc-b" class="p-3"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1100;">
        <div id="sysToast" class="toast align-items-center text-bg-dark border-0 shadow-lg" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body d-flex gap-3 align-items-center">
                    <i id="t-ico" data-lucide="check" class="text-success"></i>
                    <div>
                        <strong id="t-tit" class="d-block"></strong>
                        <small id="t-msg" class="text-secondary"></small>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const SB_URL = 'https://bzrkbjjgymdbbwpatfct.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6cmtiampneW1kYmJ3cGF0ZmN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTcyNjcsImV4cCI6MjA4NTg3MzI2N30.Icv1daEp7NophE_ktPl2G1EgDP6awo0tyV14yh3Q4Sw';
        
        // ** SAFE CONNECTION **
        const sbClient = window.supabase.createClient(SB_URL, SB_KEY);

        const TEAM = [
            { id: 1, name: "Pema Ugyen", av: "üë®‚Äçüíº", pin: "11107008201", role: "LEADER" },
            { id: 2, name: "Jamphel",    av: "üë®‚Äçüíª", pin: "11302003634", role: "MEMBER" },
            { id: 3, name: "Laxmi",      av: "üë®‚Äçüî¨", pin: "11103002151", role: "MEMBER" },
            { id: 4, name: "Ngawang",    av: "üë®",   pin: "10801003243", role: "MEMBER" }
        ];

        let STATE = { user: null, page: 'home', mode: 'task', tempId: null, arcData: null };
        const MODALS = {};

        // --- 2. INITIALIZATION ---
        window.onload = () => {
            lucide.createIcons();
            // Initialize Bootstrap Modals
            MODALS.create = new bootstrap.Modal('#modCreate');
            MODALS.proof = new bootstrap.Modal('#modProof');
            MODALS.noti = new bootstrap.Modal('#modNoti');
            MODALS.arc = new bootstrap.Modal('#modArc');
            
            // Auto-Login Check
            const uid = localStorage.getItem('slbd_uid');
            if(uid) {
                const u = TEAM.find(x => x.id == uid);
                if(u) { login(u); return; }
            }
            initAuth();
        };

        // --- 3. AUTHENTICATION ---
        function initAuth() {
            document.getElementById('auth-step-1').innerHTML = TEAM.map(u => `
                <div class="col-6">
                    <div onclick="preLogin(${u.id})" class="card-box p-3 text-center cursor-pointer">
                        <div class="fs-1 mb-2">${u.av}</div>
                        <div class="fw-bold text-white small">${u.name.split(' ')[0]}</div>
                    </div>
                </div>`).join('');
        }

        function preLogin(id) {
            STATE.sel = TEAM.find(u=>u.id===id);
            document.getElementById('auth-step-1').classList.add('d-none');
            document.getElementById('auth-step-2').classList.remove('d-none');
            document.getElementById('auth-av').innerText = STATE.sel.av;
            document.getElementById('auth-name').innerText = STATE.sel.name;
            setTimeout(() => document.getElementById('inp-pin').focus(), 300);
        }

        function authReset() {
            document.getElementById('auth-step-2').classList.add('d-none');
            document.getElementById('auth-step-1').classList.remove('d-none');
            document.getElementById('inp-pin').value = '';
        }

        function tryLogin() {
            if(document.getElementById('inp-pin').value === STATE.sel.pin) {
                localStorage.setItem('slbd_uid', STATE.sel.id);
                login(STATE.sel);
            } else {
                toast('Access Denied', 'Incorrect PIN code', 'shield-alert', 'text-danger');
            }
        }

        function login(u) {
            STATE.user = u;
            // ** CRITICAL: FORCE HIDE AUTH SCREEN **
            document.getElementById('view-auth').classList.add('d-none-imp'); 
            document.getElementById('view-app').classList.remove('d-none');
            
            // Set Avatars/Name
            document.getElementById('mob-u-av').innerText = u.av;
            document.getElementById('desk-u-av').innerText = u.av;
            document.getElementById('desk-u-name').innerText = u.name;
            
            setupNav();
            nav('home');
            
            // Polling for updates every 4 seconds
            setInterval(() => { if(STATE.page!=='arc') render(true); checkNoti(false); }, 4000);
            checkNoti(false);
        }

        function doLogout() {
            localStorage.removeItem('slbd_uid');
            location.reload();
        }

        // --- 4. NAVIGATION & RENDERING ---
        function setupNav() {
            const pages = [
                {id:'home', t:'Dashboard', i:'layout-grid'},
                {id:'task', t:'Tasks', i:'layers'},
                {id:'future', t:'Not Yet', i:'hourglass'},
                {id:'dec', t:'Decisions', i:'scroll-text'},
                {id:'arc', t:'Records', i:'archive'}
            ];
            
            document.getElementById('nav-d-links').innerHTML = pages.map(p => `
                <a href="#" onclick="nav('${p.id}')" id="nd-${p.id}" class="nav-item-d">
                    <i data-lucide="${p.i}" size="18"></i> ${p.t}
                </a>`).join('');

            document.getElementById('nav-m-links').innerHTML = pages.map(p => `
                <a href="#" onclick="nav('${p.id}')" id="nm-${p.id}" class="nav-item-m">
                    <i data-lucide="${p.i}" size="22"></i> <span>${p.t}</span>
                </a>`).join('');
        }
        
        function nav(p) {
            STATE.page = p;
            document.querySelectorAll('.nav-item-d').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.nav-item-m').forEach(e=>e.classList.remove('active'));
            document.getElementById(`nd-${p}`).classList.add('active');
            document.getElementById(`nm-${p}`).classList.add('active');
            
            const titles = {home:'My Workspace', task:'Active Tasks', future:'Future Ideas', dec:'Decision Log', arc:'Archives'};
            document.getElementById('mob-pg-title').innerText = titles[p];
            document.getElementById('desk-pg-title').innerText = titles[p];
            
            render(false);
        }

        async function render(silent) {
            const c = document.getElementById('content-box');
            if(!silent) c.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
            
            const now = new Date();
            const mStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
            
            try {
                if(STATE.page === 'home') {
                    // Fetch My Tasks and Today's Attendance
                    const [ {data:t}, {data:a} ] = await Promise.all([
                        sbClient.from('tasks').select('*').neq('status','Done').neq('status','Future'),
                        sbClient.from('attendance').select('*').eq('user_id',STATE.user.id).eq('date',now.toISOString().split('T')[0])
                    ]);
                    const myT = t.filter(x => (x.tagged_members||[]).includes(STATE.user.id));
                    
                    c.innerHTML = `
                        <div class="row g-3">
                            <div class="col-12 col-md-4">
                                <div class="card-box p-4 text-center h-100 d-flex flex-column justify-content-center">
                                    <h1 class="fw-bold text-white mb-0">${now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</h1>
                                    <div class="text-secondary small mb-3">${now.toDateString()}</div>
                                    ${a && a.length ? '<button class="btn btn-success w-100 rounded-pill" disabled>Checked In ‚úÖ</button>' : '<button onclick="doCheckIn()" class="btn btn-primary w-100 rounded-pill shadow">Check In Now</button>'}
                                </div>
                            </div>
                            <div class="col-12 col-md-8">
                                <div class="card-box h-100 p-3">
                                    <h6 class="text-secondary small fw-bold mb-3 border-bottom border-secondary border-opacity-25 pb-2">MY ASSIGNED TASKS</h6>
                                    ${myT.length ? myT.map(x => `
                                        <div class="p-3 border border-secondary border-opacity-25 rounded mb-2 bg-dark hover-bg" onclick="nav('task')" style="cursor:pointer">
                                            <div class="d-flex justify-content-between mb-1">
                                                <span class="badge-st st-wait">${x.status}</span>
                                                <small class="text-secondary">${x.due_date||'No Date'}</small>
                                            </div>
                                            <div class="fw-bold text-white">${x.task_title}</div>
                                        </div>`).join('') 
                                        : '<div class="text-center text-muted py-5">No active tasks assigned to you.</div>'}
                                </div>
                            </div>
                        </div>`;
                }
                
                if(STATE.page === 'task') {
                    const { data } = await sbClient.from('tasks').select('*').neq('status','Future').order('created_at',{ascending:false});
                    const list = data.filter(x => x.status !== 'Done' || x.updated_at >= mStart); // Show Done tasks only if recent
                    
                    if(list.length === 0) { c.innerHTML = '<div class="text-center text-muted py-5">No tasks found. Create one!</div>'; }
                    else {
                        c.innerHTML = `<div class="row g-3">${list.map(t => `
                            <div class="col-12 col-lg-6">
                                <div class="card-box p-3 border-start border-4 ${t.status==='Done'?'border-success':t.status==='Review'?'border-info':'border-warning'}">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="badge-st ${t.status==='Done'?'st-done':t.status==='Review'?'st-rev':'st-wait'}">${t.status}</span>
                                        <span class="text-xs text-secondary">${new Date(t.created_at).toLocaleDateString()}</span>
                                    </div>
                                    <h5 class="fw-bold text-white text-truncate">${t.task_title}</h5>
                                    <p class="small text-secondary mb-3 text-truncate">${t.description}</p>
                                    
                                    <div class="d-flex gap-2">
                                        ${t.status!=='Done' && t.status!=='Future' ? `<button onclick="initDone(${t.id})" class="btn btn-sm btn-primary flex-fill fw-bold">Mark Done</button>`:''}
                                        ${STATE.user.role==='LEADER' && t.status==='Review' ? `<button onclick="doApprove(${t.id})" class="btn btn-sm btn-success flex-fill fw-bold">Approve</button>`:''}
                                    </div>
                                </div>
                            </div>`).join('')}</div>`;
                    }
                }

                if(STATE.page === 'future') {
                    const { data } = await sbClient.from('tasks').select('*').eq('status','Future');
                    c.innerHTML = `<div class="row g-3">${data.map(t => `<div class="col-12 col-lg-6"><div class="card-box p-3 opacity-75"><h5 class="fw-bold text-white">${t.task_title}</h5><p class="small text-secondary">${t.description}</p><div class="d-flex justify-content-between border-top border-secondary border-opacity-25 pt-2 mt-2"><span class="badge-st st-fut">Not Yet</span>${STATE.user.role==='LEADER'?`<button onclick="doActivate(${t.id})" class="btn btn-sm btn-outline-success">Activate</button>`:''}</div></div></div>`).join('')}</div>`;
                }

                if(STATE.page === 'dec') {
                    const { data } = await sbClient.from('decisions').select('*').order('created_at',{ascending:false});
                    c.innerHTML = data.length ? data.map(d => `<div class="card-box p-3 mb-2"><div class="d-flex gap-3"><i data-lucide="quote" class="text-warning flex-shrink-0"></i><div><div class="fw-bold text-white">${d.subject}</div><div class="small text-secondary">${d.details}</div></div></div></div>`).join('') : '<div class="text-center text-muted py-5">No decisions recorded.</div>';
                }

                if(STATE.page === 'arc') {
                    const { data } = await sbClient.from('tasks').select('updated_at').eq('status','Done');
                    // Group by Month (YYYY-MM)
                    const ms = [...new Set(data.map(x=>x.updated_at.slice(0,7)))].sort().reverse();
                    c.innerHTML = ms.length ? `<div class="row g-3">${ms.map(m=>`<div class="col-6 col-md-3"><div onclick="openArc('${m}')" class="card-box p-4 text-center cursor-pointer hover-bg"><i data-lucide="folder-closed" class="text-warning mb-2" size="32"></i><div class="fw-bold text-white">${m}</div></div></div>`).join('')}</div>` : '<div class="text-center text-muted py-5">Archive is empty.</div>';
                }

            } catch(e) { console.error(e); }
            lucide.createIcons();
        }

        // --- 5. ACTIONS & WORKFLOW ---
        function setMode(m) {
            STATE.mode = m;
            ['task','future','dec'].forEach(x => {
                const b = document.getElementById(`bm-${x}`);
                if(x===m) { b.classList.add('bg-secondary','bg-opacity-25','text-white'); b.classList.remove('text-secondary'); }
                else { b.classList.remove('bg-secondary','bg-opacity-25','text-white'); b.classList.add('text-secondary'); }
            });
            const isT = m!=='dec';
            document.getElementById('sec-task-opt').classList.toggle('d-none', !isT);
            document.getElementById('inp-t').placeholder = m==='dec'?'Subject':'Title';
            if(isT) {
                document.getElementById('div-mems').innerHTML = TEAM.map(u=>`<label class="d-flex align-items-center p-2 rounded bg-black border border-secondary border-opacity-25"><input type="checkbox" class="chk-mem form-check-input me-3" value="${u.id}"> ${u.av} ${u.name}</label>`).join('');
            }
        }

        function openCreate() { 
            setMode('task'); 
            document.getElementById('inp-t').value=''; 
            document.getElementById('inp-d').value=''; 
            MODALS.create.show(); 
        }
        
        async function saveItem() {
            const t = document.getElementById('inp-t').value;
            const d = document.getElementById('inp-d').value;
            if(!t) return toast('Error','Title Missing','alert-circle','text-danger');
            
            if(STATE.mode === 'dec') {
                await sbClient.from('decisions').insert({subject:t, details:d});
            } else {
                const tags = [...document.querySelectorAll('.chk-mem:checked')].map(x=>parseInt(x.value));
                const st = STATE.mode==='future'?'Future':(STATE.user.role==='LEADER'?'Ongoing':'Pending');
                await sbClient.from('tasks').insert({
                    task_title:t, description:d, 
                    due_date:document.getElementById('inp-date').value||null, 
                    creator_id:STATE.user.id, tagged_members:tags, status:st
                });
            }
            MODALS.create.hide(); 
            toast('Saved','Record created successfully','check-circle','text-success'); 
            render(false);
        }

        function initDone(id) { 
            STATE.tempId = id; 
            document.getElementById('chk-done').checked=false; 
            toggleFin(); 
            MODALS.proof.show(); 
        }

        function toggleFin() { 
            document.getElementById('btn-fin').classList.toggle('disabled', !document.getElementById('chk-done').checked); 
        }

        async function finishTask() {
            // Mark as Done (Success)
            await sbClient.from('tasks').update({status:'Done', updated_at:new Date()}).eq('id',STATE.tempId);
            MODALS.proof.hide(); 
            toast('Great Work!','Task marked complete','trophy','text-warning'); 
            render(false);
        }

        async function doCheckIn() { 
            await sbClient.from('attendance').insert({user_id:STATE.user.id, date:new Date().toISOString().split('T')[0]}); 
            render(false); 
            toast('Checked In','Attendance Logged','clock','text-success'); 
        }

        async function doApprove(id) { 
            await sbClient.from('tasks').update({status:'Ongoing'}).eq('id',id); 
            render(false); 
            toast('Approved','Task is now active','thumbs-up','text-success');
        }

        async function doActivate(id) { 
            await sbClient.from('tasks').update({status:'Pending'}).eq('id',id); 
            render(false); 
            toast('Activated','Idea moved to active','zap','text-warning');
        }

        // --- 6. ARCHIVE & NOTIFICATIONS ---
        async function openArc(m) {
            document.getElementById('arc-t').innerText = `Archive: ${m}`;
            const s = `${m}-01`, e = `${m}-31`;
            const [t,d,a] = await Promise.all([
                sbClient.from('tasks').select('*').eq('status','Done').gte('updated_at',s).lte('updated_at',e),
                sbClient.from('decisions').select('*').gte('created_at',s).lte('created_at',e),
                sbClient.from('attendance').select('*').gte('date',s).lte('date',e)
            ]);
            STATE.arcData = {t:t.data, d:d.data, a:a.data};
            MODALS.arc.show(); 
            loadArcTab('t');
        }

        function loadArcTab(k) {
            ['t','d','a'].forEach(x => {
                const b = document.getElementById(`at-${x}`);
                if(x===k) { b.classList.add('active','border-bottom','border-primary','border-2','text-white'); b.classList.remove('text-secondary'); }
                else { b.classList.remove('active','border-bottom','border-primary','border-2','text-white'); b.classList.add('text-secondary'); }
            });
            const d = STATE.arcData[k];
            const c = document.getElementById('arc-b');
            if(!d || !d.length) { c.innerHTML = '<div class="text-center text-muted p-4">No records found.</div>'; return; }
            
            if(k==='t') c.innerHTML = d.map(x=>`<div class="py-2 border-bottom border-secondary border-opacity-25"><div class="fw-bold text-white">${x.task_title}</div><small class="text-secondary">Finished: ${x.updated_at.slice(0,10)}</small></div>`).join('');
            if(k==='d') c.innerHTML = d.map(x=>`<div class="py-2 border-bottom border-secondary border-opacity-25"><div class="fw-bold text-white">${x.subject}</div><small class="text-secondary">${x.details}</small></div>`).join('');
            if(k==='a') c.innerHTML = d.map(x=>`<div class="py-2 border-bottom border-secondary border-opacity-25 d-flex justify-content-between"><span class="text-white">${TEAM.find(u=>u.id==x.user_id)?.name}</span><span class="font-monospace text-secondary">${x.date}</span></div>`).join('');
        }

        async function checkNoti(showModal) {
            if(!STATE.user) return;
            // Simple logic: fetch unread
            const {data} = await sbClient.from('notifications').select('*').eq('user_id',STATE.user.id).eq('is_read',false);
            const has = data && data.length > 0;
            
            // Toggle Red Dot
            document.getElementById('badge-bell-m').classList.toggle('d-none', !has);
            document.getElementById('badge-bell-d').classList.toggle('d-none', !has);
            
            if(showModal) {
                const box = document.getElementById('noti-list');
                const {data: all} = await sbClient.from('notifications').select('*').eq('user_id',STATE.user.id).order('created_at',{ascending:false}).limit(10);
                
                if(!all || !all.length) { 
                    box.innerHTML = '<div class="p-4 text-center text-secondary">No notifications.</div>'; 
                } else {
                    box.innerHTML = all.map(n=>`<div class="list-group-item bg-dark border-secondary border-opacity-25 p-3"><div class="${n.is_read?'text-secondary':'fw-bold text-white'}">${n.message}</div></div>`).join('');
                    // Mark all as read
                    await sbClient.from('notifications').update({is_read:true}).eq('user_id',STATE.user.id);
                    document.getElementById('badge-bell-m').classList.add('d-none');
                    document.getElementById('badge-bell-d').classList.add('d-none');
                }
                MODALS.noti.show();
            }
        }

        function toast(t, m, i, c) {
            document.getElementById('t-tit').innerText = t; 
            document.getElementById('t-msg').innerText = m;
            document.getElementById('t-ico').setAttribute('data-lucide', i); 
            document.getElementById('t-ico').className = c;
            lucide.createIcons();
            bootstrap.Toast.getOrCreateInstance(document.getElementById('sysToast')).show();
        }
    </script>
</body>
</html>
