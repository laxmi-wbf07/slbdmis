<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>SLBDMIS | Commander V9.3</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* === THEME: COMMANDER V9.3 === */
        :root {
            --bg-body: #000000;
            --bg-card: #0F0F0F;
            --bg-hover: #161616;
            --border: #222222;
            --primary: #3B82F6;
            --primary-dim: rgba(59, 130, 246, 0.15);
            --accent: #F59E0B;
            --success: #10B981;
            --text-main: #FFFFFF;
            --text-sub: #888888;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* === UI ELEMENTS === */
        .glass-panel {
            background: rgba(15, 15, 15, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
        }

        .card-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        /* Quick Links Grid */
        .quick-link {
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: 12px;
            height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: var(--text-sub);
            transition: 0.2s;
            text-align: center;
            padding: 10px;
            position: relative;
            overflow: hidden;
        }
        .quick-link:active { transform: scale(0.96); border-color: var(--primary); color: white; }
        .quick-link i { margin-bottom: 8px; transition: 0.2s; }
        .quick-link:hover i { transform: scale(1.1); }

        /* Tabs for "Not Yet" */
        .nav-tabs-custom {
            display: flex;
            background: var(--bg-hover);
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }
        .nav-tab-item {
            flex: 1;
            text-align: center;
            padding: 12px;
            font-size: 13px;
            font-weight: 800;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-sub);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .nav-tab-item.active {
            background: var(--bg-card);
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border: 1px solid var(--border);
        }

        /* Analytics Cards */
        .stat-card {
            background: linear-gradient(180deg, #161616 0%, #0a0a0a 100%);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border);
            height: 100%;
        }

        /* Progress Slider Customization */
        input[type=range] {
            height: 6px;
            border-radius: 5px;
            accent-color: var(--primary);
        }

        /* Animations */
        @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 100% { box-shadow: 0 0 0 15px rgba(0,0,0,0); } }
        .boot-btn { animation: pulse-glow 2s infinite; }

        /* Layout */
        @media (min-width: 992px) {
            .sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: 280px; background: #050505; border-right: 1px solid var(--border); padding: 30px; z-index: 1000; }
            .main-content { margin-left: 280px; padding: 40px; max-width: 1400px; }
            .mobile-only { display: none !important; }
        }
        @media (max-width: 991px) {
            .sidebar, .desktop-only { display: none !important; }
            .mobile-head { position: fixed; top: 0; left: 0; right: 0; height: 60px; z-index: 1000; padding: 0 16px; display: flex; align-items: center; justify-content: space-between; }
            .mobile-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 80px; background: #000; border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding-bottom: 15px; z-index: 1000; }
            .main-content { padding: 80px 16px 120px 16px; }
        }
    </style>
</head>
<body>

    <audio id="sfx-boot" src="https://assets.mixkit.co/active_storage/sfx/1364/1364-preview.mp3" preload="auto"></audio>
    <audio id="sfx-ping" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <div id="view-boot" class="position-fixed top-0 start-0 w-100 h-100 bg-black z-3 d-flex flex-column align-items-center justify-content-center p-4">
        <div class="mb-5 text-center">
            <i data-lucide="cpu" class="text-primary mb-3" size="50"></i>
            <h1 class="h3 fw-bold ls-2">SYSTEM V9.3</h1>
            <p class="text-secondary small font-monospace">READY FOR INITIALIZATION</p>
        </div>
        <button onclick="bootSystem()" class="btn btn-primary px-5 py-3 rounded-pill fw-bold shadow-lg boot-btn">
            INITIALIZE SYSTEM
        </button>
    </div>

    <div id="view-auth" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-black z-2 d-flex align-items-center justify-content-center p-3">
        <div class="card-box p-4 w-100" style="max-width: 400px;">
            <div class="text-center mb-4">
                <h4 class="fw-bold">IDENTIFICATION</h4>
                <p class="text-secondary text-xs">SELECT OPERATOR</p>
            </div>
            <div id="auth-list" class="row g-2"></div>
            
            <div id="auth-pin" class="d-none animate-fade">
                <div class="bg-dark p-3 rounded-3 mb-4 d-flex align-items-center gap-3 border border-secondary border-opacity-25">
                    <div id="l-av" class="fs-4"></div>
                    <div><div id="l-name" class="fw-bold text-white"></div><div class="text-xs text-secondary">Enter PIN</div></div>
                </div>
                <input type="password" id="inp-pin" class="form-control bg-black text-white text-center fs-3 mb-3 py-3 font-monospace border-secondary" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="11" inputmode="numeric">
                <button onclick="tryLogin()" class="btn btn-primary w-100 py-3 rounded-pill fw-bold">AUTHENTICATE</button>
                <button onclick="resetAuth()" class="btn btn-link w-100 text-secondary mt-2 text-decoration-none">Back</button>
            </div>
        </div>
    </div>

    <div id="view-app" class="d-none">
        <header class="mobile-head glass-panel mobile-only">
            <div class="d-flex align-items-center gap-2">
                <i data-lucide="layout-grid" class="text-primary" size="20"></i>
                <span id="m-tit" class="fw-bold">DASHBOARD</span>
            </div>
            <div class="d-flex gap-3 align-items-center">
                <div class="position-relative" onclick="checkNoti(true)">
                    <i data-lucide="bell" class="text-white" size="22"></i>
                    <span id="bad-m" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none border border-black">0</span>
                </div>
                <i onclick="openCreate('task')" data-lucide="plus-circle" class="text-primary" size="24"></i>
            </div>
        </header>

        <nav class="sidebar">
            <div class="d-flex align-items-center gap-3 mb-5">
                <div class="bg-primary bg-opacity-10 p-2 rounded"><i data-lucide="command" class="text-primary"></i></div>
                <div><div class="fw-bold">SLBDMIS</div><div class="text-xs text-secondary">COMMANDER</div></div>
            </div>
            <div id="nav-d" class="d-flex flex-column gap-2 flex-grow-1"></div>
            <div class="mt-auto pt-4 border-top border-secondary border-opacity-25">
                <div class="d-flex align-items-center gap-3 mb-3">
                    <div id="d-av" class="fs-5"></div>
                    <div><div id="d-name" class="fw-bold text-sm"></div><div class="text-xs text-success">‚óè Online</div></div>
                </div>
                <button onclick="doLogout()" class="btn btn-outline-danger btn-sm w-100">Disconnect</button>
            </div>
        </nav>

        <main class="main-content">
            <div class="desktop-only d-flex justify-content-between align-items-center mb-5">
                <h2 id="d-tit" class="fw-bold m-0">Dashboard</h2>
                <div class="d-flex gap-3">
                    <button onclick="checkNoti(true)" class="btn btn-dark border border-secondary border-opacity-25 px-3 rounded-pill position-relative">
                        <i data-lucide="bell" size="18" class="me-2"></i> Alerts
                        <span id="bad-d" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">0</span>
                    </button>
                    <button onclick="openCreate('task')" class="btn btn-primary px-4 rounded-pill fw-bold shadow-lg">New Entry</button>
                </div>
            </div>
            <div id="content-box"></div>
        </main>

        <nav class="mobile-nav mobile-only" id="nav-m"></nav>
    </div>

    <div class="modal fade" id="modCreate" tabindex="-1">
        <div class="modal-dialog modal-fullscreen-sm-down modal-dialog-centered">
            <div class="modal-content card-box border-0">
                <div class="modal-header border-bottom border-secondary border-opacity-25">
                    <h5 class="fw-bold">New Record</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="d-flex gap-2 mb-3 bg-dark p-1 rounded-3">
                        <button onclick="setMode('task')" id="bm-task" class="btn flex-fill btn-sm fw-bold">Task</button>
                        <button onclick="setMode('future')" id="bm-future" class="btn flex-fill btn-sm text-secondary">Not Yet</button>
                        <button onclick="setMode('dec')" id="bm-dec" class="btn flex-fill btn-sm text-secondary">Decision</button>
                    </div>

                    <input id="inp-t" class="form-control bg-dark text-white border-secondary mb-3" placeholder="Title">
                    <textarea id="inp-d" class="form-control bg-dark text-white border-secondary mb-3" rows="3" placeholder="Details..."></textarea>
                    
                    <div id="sec-task">
                        <label class="text-xs fw-bold text-secondary mb-2">DUE DATE</label>
                        <input type="date" id="inp-date" class="form-control bg-dark text-white border-secondary mb-3">
                        <div id="sec-assign">
                            <label class="text-xs fw-bold text-secondary mb-2">ASSIGN TEAM</label>
                            <div id="div-mems" class="d-flex flex-wrap gap-2 mb-4"></div>
                        </div>
                    </div>

                    <button onclick="saveItem()" id="btn-save" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow-lg">Save Record</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modCal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content card-box border-0">
                <div class="modal-body p-4">
                    <h5 class="fw-bold mb-3">Add Event</h5>
                    <input id="cal-t" class="form-control bg-dark text-white border-secondary mb-3" placeholder="Event Name">
                    <div class="row g-2 mb-3">
                        <div class="col-6"><input type="date" id="cal-d" class="form-control bg-dark text-white border-secondary"></div>
                        <div class="col-6">
                            <select id="cal-y" class="form-select bg-dark text-white border-secondary">
                                <option value="meeting">Meeting</option>
                                <option value="deadline">Deadline</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="saveCal()" class="btn btn-success w-100 rounded-pill fw-bold">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modNoti" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content card-box border-0">
                <div class="modal-header border-bottom border-secondary border-opacity-25 bg-black">
                    <h5 class="modal-title fw-bold">Alerts</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="noti-list" class="list-group list-group-flush bg-transparent"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 2000;">
        <div id="sysToast" class="toast align-items-center text-bg-dark border border-secondary shadow-lg rounded-4">
            <div class="d-flex">
                <div class="toast-body d-flex gap-3 align-items-center">
                    <i id="t-ico" data-lucide="check" class="text-success"></i>
                    <div><strong id="t-tit" class="d-block text-white">System</strong><small id="t-msg" class="text-secondary">Action Completed</small></div>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const SB_URL = 'https://bzrkbjjgymdbbwpatfct.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6cmtiampneW1kYmJ3cGF0ZmN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTcyNjcsImV4cCI6MjA4NTg3MzI2N30.Icv1daEp7NophE_ktPl2G1EgDP6awo0tyV14yh3Q4Sw';
        const sbClient = window.supabase.createClient(SB_URL, SB_KEY);
        
        const TEAM = [
            { id: 1, name: "Pema Ugyen", av: "üë®‚Äçüíº", pin: "11107008201", role: "LEADER" },
            { id: 2, name: "Jamphel",    av: "üë®‚Äçüíª", pin: "11302003634", role: "MEMBER" },
            { id: 3, name: "Laxmi",      av: "üë®‚Äçüî¨", pin: "11103002151", role: "MEMBER" },
            { id: 4, name: "Ngawang",    av: "üë®",   pin: "10801003243", role: "MEMBER" }
        ];

        let STATE = { user: null, page: 'home', mode: 'task', subTab: 'live', lastNoti: 0 };
        const MODALS = {};

        // --- 1. BOOT SEQUENCE ---
        window.onload = () => {
            lucide.createIcons();
            ['modCreate','modCal','modNoti'].forEach(id => MODALS[id] = new bootstrap.Modal('#'+id));
            
            // If already logged in, show boot for Audio Context, but can skip Auth later
            document.getElementById('view-boot').classList.remove('d-none');
        };

        function bootSystem() {
            // Unlock Audio
            document.getElementById('sfx-boot').play().catch(()=>{});
            
            // Request Noti
            if (Notification.permission !== "granted") Notification.requestPermission();
            
            // Navigate
            document.getElementById('view-boot').classList.add('d-none');
            const uid = localStorage.getItem('slbd_uid');
            if(uid) login(TEAM.find(x => x.id == uid));
            else initAuth();
        }

        // --- 2. AUTH ---
        function initAuth() {
            document.getElementById('view-auth').classList.remove('d-none');
            document.getElementById('auth-list').innerHTML = TEAM.map(u => `
                <div class="col-6"><div onclick="preLogin(${u.id})" class="card-box p-3 text-center h-100 cursor-pointer quick-link border-opacity-50">
                    <div class="fs-1 mb-1">${u.av}</div><div class="fw-bold small text-uppercase">${u.name.split(' ')[0]}</div>
                </div></div>`).join('');
        }

        function preLogin(id) {
            STATE.sel = TEAM.find(u=>u.id===id);
            document.getElementById('auth-list').classList.add('d-none');
            document.getElementById('auth-pin').classList.remove('d-none');
            document.getElementById('l-av').innerText = STATE.sel.av;
            document.getElementById('l-name').innerText = STATE.sel.name;
        }

        function resetAuth() {
            document.getElementById('auth-pin').classList.add('d-none');
            document.getElementById('auth-list').classList.remove('d-none');
        }

        function tryLogin() {
            if(document.getElementById('inp-pin').value === STATE.sel.pin) {
                localStorage.setItem('slbd_uid', STATE.sel.id);
                document.getElementById('view-auth').classList.add('d-none');
                login(STATE.sel);
            } else {
                toast('Denied', 'Incorrect PIN', 'lock', 'text-danger');
                document.getElementById('inp-pin').value = '';
            }
        }

        async function login(u) {
            STATE.user = u;
            document.getElementById('view-app').classList.remove('d-none');
            document.getElementById('d-av').innerText = u.av;
            document.getElementById('d-name').innerText = u.name;
            
            const navs = [
                {id:'home', t:'Dash', i:'layout-grid'},
                {id:'cal', t:'Schedule', i:'calendar'},
                {id:'task', t:'Tasks', i:'check-square'},
                {id:'dec', t:'Decisions', i:'file-signature'},
                {id:'rec', t:'Files', i:'folder'}
            ];
            
            document.getElementById('nav-d').innerHTML = navs.map(p => `<a href="#" onclick="nav('${p.id}')" id="nd-${p.id}" class="text-decoration-none p-3 rounded-3 d-flex align-items-center gap-3 text-secondary" style="transition:0.2s"><i data-lucide="${p.i}" size="20"></i> <span class="fw-medium">${p.t}</span></a>`).join('');
            document.getElementById('nav-m').innerHTML = navs.map(p => `<a href="#" onclick="nav('${p.id}')" id="nm-${p.id}" class="d-flex flex-column align-items-center justify-content-center text-decoration-none text-secondary opacity-50 w-100"><i data-lucide="${p.i}" size="24" class="mb-1"></i> <span style="font-size:10px; font-weight:600">${p.t}</span></a>`).join('');

            // Attendance
            const today = new Date().toISOString().split('T')[0];
            const {data} = await sbClient.from('attendance').select('*').eq('user_id',u.id).eq('date',today);
            if(!data.length) await sbClient.from('attendance').insert({user_id:u.id, date:today});

            nav('home');
            setInterval(() => { if(STATE.page!=='rec') render(true); checkNoti(false); }, 5000);
            checkNoti(false);
        }

        function doLogout() { localStorage.removeItem('slbd_uid'); location.reload(); }

        // --- 3. NAV & RENDER ---
        function nav(p) {
            STATE.page = p;
            document.querySelectorAll('[id^="nd-"]').forEach(e => e.classList.remove('bg-primary','bg-opacity-10','text-white'));
            document.querySelectorAll('[id^="nm-"]').forEach(e => {e.classList.remove('text-primary','opacity-100'); e.classList.add('opacity-50');});
            const nd = document.getElementById(`nd-${p}`); if(nd) { nd.classList.add('bg-primary','bg-opacity-10','text-white'); nd.classList.remove('text-secondary'); }
            const nm = document.getElementById(`nm-${p}`); if(nm) { nm.classList.add('text-primary','opacity-100'); nm.classList.remove('opacity-50'); }
            
            const titles = {home:'Command Center', cal:'Schedule', task:'Mission Logs', dec:'Decisions', rec:'Archives'};
            document.getElementById('m-tit').innerText = document.getElementById('d-tit').innerText = titles[p];
            render(false);
        }

        function switchTab(t) { STATE.subTab = t; render(true); }

        async function render(silent) {
            const c = document.getElementById('content-box');
            if(!silent) c.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';

            try {
                const [{data:tasks}, {data:evts}] = await Promise.all([
                    sbClient.from('tasks').select('*').order('created_at',{ascending:false}),
                    sbClient.from('calendar_events').select('*')
                ]);
                
                // Segregate Tasks
                const activeT = tasks ? tasks.filter(t => t.status !== 'Done' && t.status !== 'Planned') : [];
                const futureT = tasks ? tasks.filter(t => t.status === 'Planned') : [];

                if(STATE.page === 'home') {
                    // 4 Quick Links (Updated with exact Drive URLs)
                    const quickLinks = `
                        <div class="row g-3 mb-4">
                            <div class="col-6 col-md-3"><a href="https://drive.google.com/drive/folders/1VskzY_IgfF6lagiEdaF5-yy6Te_u-MMG?usp=sharing" target="_blank" class="quick-link"><i data-lucide="shield" size="24" class="text-warning"></i><span class="text-xs fw-bold">ADMIN & FIN</span></a></div>
                            <div class="col-6 col-md-3"><a href="https://drive.google.com/drive/folders/1FivXbl7Qo5qnKV2Kn6DXxdtVUS4nB5CF?usp=sharing" target="_blank" class="quick-link"><i data-lucide="cpu" size="24" class="text-info"></i><span class="text-xs fw-bold">MACHINE UNIT</span></a></div>
                            <div class="col-6 col-md-3"><a href="https://drive.google.com/drive/folders/11Q6gWSLqU4H88DrmWA_Fmbkx8dsNs0Ka?usp=sharing" target="_blank" class="quick-link"><i data-lucide="image" size="24" class="text-success"></i><span class="text-xs fw-bold">PICTURES</span></a></div>
                            <div class="col-6 col-md-3"><a href="https://drive.google.com/drive/folders/1IBpIa7nH43g1UVMYkFOwLA6iEFVvuv7y?usp=sharing" target="_blank" class="quick-link"><i data-lucide="presentation" size="24" class="text-danger"></i><span class="text-xs fw-bold">PROPOSALS & PPT</span></a></div>
                        </div>`;

                    // Tab Switcher for "Not Yet"
                    const tabSwitch = `
                        <div class="nav-tabs-custom">
                            <div onclick="switchTab('live')" class="nav-tab-item ${STATE.subTab==='live'?'active':''}">LIVE OPS</div>
                            <div onclick="switchTab('notyet')" class="nav-tab-item ${STATE.subTab==='notyet'?'active':''}">NOT YET</div>
                        </div>`;

                    let viewContent = '';

                    if(STATE.subTab === 'notyet') {
                        // "Not Yet" View (Future/Planned)
                        viewContent = futureT.length 
                            ? `<div class="row g-3">${futureT.map(t => {
                                const mems = (t.tagged_members||[]).map(id=>TEAM.find(x=>x.id===id)).filter(x=>x);
                                const assignStr = mems.length ? `<div class="mt-2 text-xs text-secondary">Team: ${mems.map(m=>m.av).join(' ')}</div>` : '';
                                return `<div class="col-12"><div class="card-box p-3 d-flex justify-content-between align-items-center"><div class="d-flex align-items-center gap-3"><div class="bg-secondary bg-opacity-25 p-2 rounded"><i data-lucide="clock" class="text-secondary"></i></div><div><div class="fw-bold">${t.task_title}</div><div class="text-xs text-secondary">${t.description}</div>${assignStr}</div></div><button onclick="setStatus(${t.id},'${STATE.user.role==='LEADER'?'Pending':'ApprovalReq'}',${t.creator_id},'${t.task_title}')" class="btn btn-sm btn-outline-primary rounded-pill">Activate</button></div></div>`
                            }).join('')}</div>`
                            : `<div class="text-center py-5 text-secondary card-box"><i data-lucide="coffee" size="32" class="mb-3 opacity-50"></i><p class="m-0 fw-bold">PLANNED / NOT YET</p><p class="small opacity-75">No future logs pending.</p></div>`;
                    } else {
                        // "Live" View
                        if(STATE.user.role === 'LEADER') {
                            // Leader Analytics
                            const doneCount = tasks.filter(t=>t.status==='Done').length;
                            const totalCount = tasks.length;
                            const rate = totalCount ? Math.round((doneCount/totalCount)*100) : 0;
                            const analytics = `
                                <div class="row g-2 mb-3">
                                    <div class="col-4"><div class="stat-card text-center"><div class="text-xs text-secondary fw-bold mb-1">COMPLETION</div><div class="fs-4 fw-bold text-success">${rate}%</div></div></div>
                                    <div class="col-4"><div class="stat-card text-center"><div class="text-xs text-secondary fw-bold mb-1">ACTIVE</div><div class="fs-4 fw-bold text-primary">${activeT.length}</div></div></div>
                                    <div class="col-4"><div class="stat-card text-center"><div class="text-xs text-secondary fw-bold mb-1">TEAM</div><div class="fs-4 fw-bold text-warning">${TEAM.length}</div></div></div>
                                </div>`;

                            // Team Status breakdown
                            const rows = TEAM.map(u => {
                                const uts = activeT.filter(t => (t.tagged_members||[]).includes(u.id));
                                if(!uts.length) return '';
                                return `<div class="p-3 border-bottom border-secondary border-opacity-25"><div class="d-flex align-items-center gap-2 mb-2"><span style="font-size:20px">${u.av}</span> <span class="fw-bold small">${u.name}</span></div>${uts.map(t => `<div class="mb-2 ps-2 border-start border-2 border-primary ms-2"><div class="d-flex justify-content-between text-xs text-secondary"><span class="text-truncate" style="max-width:150px">${t.task_title}</span><span>${t.progress}%</span></div><div class="progress bg-black mt-1" style="height:4px"><div class="progress-bar bg-${t.progress<100?'warning':'success'}" style="width:${t.progress}%"></div></div></div>`).join('')}</div>`;
                            }).join('');
                            
                            viewContent = analytics + `<div class="card-box h-100"><div class="p-3 bg-dark border-bottom border-secondary border-opacity-25 d-flex justify-content-between align-items-center"><h6 class="fw-bold m-0 text-white">Team Status</h6><button onclick="pingAll()" class="btn btn-sm btn-outline-info py-0 px-2 text-xs rounded-pill border-info">PING ALL</button></div><div style="max-height:400px;overflow-y:auto">${rows||'<div class="p-4 text-center text-secondary small">All quiet on the front.</div>'}</div></div>`;
                        } else {
                            // Member View
                            const myT = activeT.filter(t => (t.tagged_members||[]).includes(STATE.user.id));
                            viewContent = `<div class="card-box p-4 border-start border-4 border-primary"><h5 class="fw-bold mb-4">My Assignments</h5>${myT.map(t => `<div class="bg-black p-3 rounded-3 mb-3 border border-secondary border-opacity-25"><div class="d-flex justify-content-between mb-2"><span class="fw-bold">${t.task_title}</span><span class="badge bg-secondary bg-opacity-25 text-white">${t.status}</span></div><div class="d-flex align-items-center gap-3"><input type="range" class="form-range flex-grow-1" value="${t.progress}" onchange="updProg(${t.id},this.value)"> <span class="fw-bold small">${t.progress}%</span></div></div>`).join('') || '<div class="text-center text-secondary small">No active tasks.</div>'}</div>`;
                        }
                    }

                    c.innerHTML = quickLinks + tabSwitch + viewContent;
                }

                if(STATE.page === 'task') {
                    // Task Management View
                    const allT = activeT; // Only showing active here
                    if(!allT.length) c.innerHTML = '<div class="text-center py-5 text-secondary">No active missions.</div>';
                    else c.innerHTML = `<div class="row g-3">${allT.map(t => {
                        let btn = '';
                        // Identify assigned members
                        const mems = (t.tagged_members||[]).map(id=>TEAM.find(x=>x.id===id)).filter(x=>x);
                        const assignedHtml = mems.length 
                            ? `<div class="d-flex align-items-center gap-1 mt-3 pt-3 border-top border-secondary border-opacity-25"><span class="text-xs text-secondary fw-bold me-2">TEAM:</span>${mems.map(m=>`<span title="${m.name}" style="cursor:help">${m.av}</span>`).join('')}</div>` 
                            : `<div class="d-flex align-items-center gap-1 mt-3 pt-3 border-top border-secondary border-opacity-25"><span class="text-xs text-secondary fw-bold">TEAM:</span> <span class="text-xs text-secondary fst-italic">Unassigned</span></div>`;

                        if(STATE.user.role==='LEADER') {
                            if(t.status==='ApprovalReq') btn=`<button onclick="setStatus(${t.id},'Pending',${t.creator_id},'${t.task_title}')" class="btn btn-warning w-100 btn-sm mt-3 fw-bold text-black">Approve</button>`;
                            else if(t.status==='Review') btn=`<button onclick="setStatus(${t.id},'Done',${t.creator_id},'${t.task_title}')" class="btn btn-success w-100 btn-sm mt-3 fw-bold">Finalize</button>`;
                            else btn=`<button onclick="setStatus(${t.id},'Done',${t.creator_id},'${t.task_title}')" class="btn btn-outline-secondary w-100 btn-sm mt-3">Mark Done</button>`;
                        } else if(t.status==='Pending' || t.status==='Ongoing') btn=`<button onclick="setStatus(${t.id},'Review',1,'${t.task_title}')" class="btn btn-primary w-100 btn-sm mt-3">Submit for Review</button>`;
                        
                        return `<div class="col-12 col-md-6 col-lg-4"><div class="card-box p-4 h-100 d-flex flex-column"><div class="d-flex justify-content-between mb-2"><span class="badge bg-dark border border-secondary text-secondary">${t.status}</span><span class="small text-secondary fw-bold">${t.progress}%</span></div><h5 class="fw-bold mb-2">${t.task_title}</h5><p class="small text-secondary flex-grow-1 text-truncate">${t.description}</p><div class="progress bg-black" style="height:4px"><div class="progress-bar bg-white" style="width:${t.progress}%"></div></div>${assignedHtml}${btn}</div></div>`;
                    }).join('')}</div>`;
                }

                if(STATE.page === 'cal') {
                    const d = new Date();
                    const dim = new Date(d.getFullYear(),d.getMonth()+1,0).getDate();
                    let cells = '';
                    for(let i=1;i<=dim;i++) {
                        const str = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                        const es = evts ? evts.filter(e=>e.date===str) : [];
                        cells += `<div onclick="openCal('${str}')" class="p-2 rounded border border-transparent hover-border-primary bg-dark text-white d-flex flex-column" style="min-height:80px; cursor:pointer; ${i===d.getDate()?'border-color:var(--primary); background:#111':''}"><span class="text-end text-xs opacity-50 fw-bold">${i}</span>${es.map(e=>`<div class="text-xs text-truncate px-1 rounded mt-1 fw-bold" style="background:${e.type==='meeting'?'rgba(59,130,246,0.2)':'rgba(245,158,11,0.2)'};color:${e.type==='meeting'?'#93C5FD':'#FCD34D'}">${e.title}</div>`).join('')}</div>`;
                    }
                    c.innerHTML = `<div class="d-flex justify-content-between mb-4 align-items-center"><h4 class="fw-bold m-0 text-uppercase">${d.toLocaleString('default',{month:'long'})}</h4><button onclick="openCal('${new Date().toISOString().split('T')[0]}')" class="btn btn-primary btn-sm rounded-pill px-3 shadow">Add Event</button></div><div style="display:grid; grid-template-columns:repeat(7,1fr); gap:4px;">${['S','M','T','W','T','F','S'].map(x=>`<div class="text-center text-xs text-secondary py-2 fw-bold">${x}</div>`).join('')}${cells}</div>`;
                }
                
                if(STATE.page === 'dec') {
                    const {data} = await sbClient.from('decisions').select('*').order('created_at',{ascending:false});
                    c.innerHTML = data && data.length ? data.map(d=>`<div class="card-box p-4 mb-2"><div class="fw-bold text-white">${d.subject}</div><p class="text-secondary small m-0">${d.details}</p></div>`).join('') : '<div class="text-center text-secondary py-5">No logs.</div>';
                }

                if(STATE.page === 'rec') {
                    const {data} = await sbClient.from('tasks').select('*').eq('status','Done').order('updated_at',{ascending:false});
                    c.innerHTML = `<div class="card-box overflow-hidden"><table class="table table-dark mb-0"><thead><tr><th class="p-3 text-secondary text-xs">TASK</th><th class="p-3 text-secondary text-xs text-end">DATE</th></tr></thead><tbody>${data.map(t=>`<tr><td class="p-3"><div class="fw-bold small">${t.task_title}</div></td><td class="p-3 text-secondary text-xs text-end">${new Date(t.updated_at).toLocaleDateString()}</td></tr>`).join('')}</tbody></table></div>`;
                }

            } catch(e) { console.error(e); }
            lucide.createIcons();
        }

        // --- 4. ACTIONS ---
        function setMode(m) { 
            STATE.mode = m; 
            ['task','future','dec'].forEach(k => {
                const el = document.getElementById('bm-'+k);
                if(el) el.className = (k === m) ? 'flex-fill btn btn-sm text-white fw-bold py-2 rounded-2 bg-secondary bg-opacity-25' : 'flex-fill btn btn-sm text-secondary fw-bold py-2 rounded-2';
            });
            document.getElementById('sec-task').classList.toggle('d-none', m==='dec');
            document.getElementById('sec-assign').classList.toggle('d-none', m!=='task'); // Only show members for task
            if(m==='task') document.getElementById('div-mems').innerHTML = TEAM.map(u=>`<input type="checkbox" class="btn-check chk-mem" id="btn-check-${u.id}" value="${u.id}"><label class="btn btn-outline-secondary btn-sm rounded-pill" for="btn-check-${u.id}">${u.name.split(' ')[0]}</label>`).join('');
        }
        function openCreate(m) { setMode(m); MODALS.modCreate.show(); }
        
        async function saveItem() {
            const btn = document.getElementById('btn-save'); btn.innerText = 'Saving...';
            const t = document.getElementById('inp-t').value; const d = document.getElementById('inp-d').value;
            if(!t) { toast('Error','Title Required','alert-circle','text-danger'); btn.innerText='Save Record'; return; }
            
            if(STATE.mode==='dec') await sbClient.from('decisions').insert({subject:t, details:d});
            else if(STATE.mode==='future') await sbClient.from('tasks').insert({task_title:t, description:d, status:'Planned', creator_id:STATE.user.id, progress:0});
            else {
                const tags = [...document.querySelectorAll('.chk-mem:checked')].map(x=>parseInt(x.value));
                await sbClient.from('tasks').insert({task_title:t, description:d, due_date:document.getElementById('inp-date').value||null, creator_id:STATE.user.id, tagged_members:tags, status:STATE.user.role==='LEADER'?'Pending':'ApprovalReq', progress:0});
                tags.forEach(id => sendNoti(id, `New Task: ${t}`));
                if(STATE.user.role!=='LEADER') sendNoti(1, `Approval Req: ${t}`);
            }
            MODALS.modCreate.hide(); toast('Success','Record Saved','check-circle','text-success'); render(false); btn.innerText = 'Save Record';
        }
        
        async function setStatus(id,s,uid,tit) { await sbClient.from('tasks').update({status:s, updated_at:new Date()}).eq('id',id); render(true); if(s==='Pending') sendNoti(uid,`Approved: ${tit}`); if(s==='Done') sendNoti(uid,`Complete: ${tit}`); if(s==='Review') sendNoti(1,`Review: ${tit}`); }
        async function updProg(id,v) { await sbClient.from('tasks').update({progress:v}).eq('id',id); }
        function openCal(d) { document.getElementById('cal-d').value=d; MODALS.modCal.show(); }
        async function saveCal() { await sbClient.from('calendar_events').insert({title:document.getElementById('cal-t').value, date:document.getElementById('cal-d').value, type:document.getElementById('cal-y').value, status:'confirmed', creator_id:STATE.user.id}); MODALS.modCal.hide(); toast('Saved','Event Added','calendar','text-success'); render(false); }
        
        // --- 5. NOTIFICATIONS ---
        async function sendNoti(uid, msg) { await sbClient.from('notifications').insert({user_id:uid, message:msg}); }
        function pingAll() { TEAM.forEach(u=>{ if(u.role!=='LEADER') sendNoti(u.id, "COMMANDER: REPORT STATUS"); }); toast('Sent','Team Pinged','radio','text-info'); }
        async function checkNoti(open) {
            const {data} = await sbClient.from('notifications').select('*').eq('user_id',STATE.user.id).eq('is_read',false);
            const count = data?.length || 0;
            const bM = document.getElementById('bad-m'); const bD = document.getElementById('bad-d');
            
            if(count > 0) {
                bM.classList.remove('d-none'); bM.innerText = count; bD.classList.remove('d-none'); bD.innerText = count;
                if(count > STATE.lastNoti) {
                    document.getElementById('sfx-ping').play().catch(()=>{});
                    if(navigator.vibrate) navigator.vibrate([100,50,100]);
                    if(Notification.permission === "granted") new Notification("SLBDMIS", {body: `${count} New Alerts`});
                }
            } else { bM.classList.add('d-none'); bD.classList.add('d-none'); }
            STATE.lastNoti = count;

            if(open) {
                const {data:msgs} = await sbClient.from('notifications').select('*').eq('user_id',STATE.user.id).order('created_at',{ascending:false}).limit(10);
                document.getElementById('noti-list').innerHTML = msgs.length ? msgs.map(n => `<div class="list-group-item bg-dark border-secondary border-opacity-25 p-3"><div class="fw-bold small text-white">${n.message}</div><div class="text-secondary text-xs mt-1">${new Date(n.created_at).toLocaleTimeString()}</div></div>`).join('') : '<div class="p-4 text-center text-secondary small">No alerts.</div>';
                if(count>0) await sbClient.from('notifications').update({is_read:true}).eq('user_id',STATE.user.id);
                MODALS.modNoti.show();
            }
        }

        // --- UTILS ---
        function toast(t,m,i,c) {
            document.getElementById('t-tit').innerText = t; document.getElementById('t-msg').innerText = m;
            document.getElementById('t-ico').setAttribute('data-lucide', i); document.getElementById('t-ico').className = c;
            lucide.createIcons(); bootstrap.Toast.getOrCreateInstance(document.getElementById('sysToast')).show();
        }
    </script>
</body>
</html>
