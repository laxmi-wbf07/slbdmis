<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SLBDMIS - God Mode</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- THEME --- */
        :root {
            --bg: #0F172A;
            --card: #1E293B;
            --hover: #334155;
            --primary: #3B82F6;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --text: #F8FAFC;
            --muted: #94A3B8;
            --border: rgba(255,255,255,0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background-color: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .grid { display: grid; }
        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-muted { color: var(--muted); }
        .p-4 { padding: 1rem; }
        .w-full { width: 100%; }
        
        /* --- COMPONENTS --- */
        .card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 0.7rem 1.2rem;
            border-radius: 0.6rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex; align-items: center; gap: 0.5rem; justify-content: center;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-ghost { background: transparent; color: var(--muted); border: 1px solid var(--hover); }
        .btn:active { transform: scale(0.98); }

        input, select, textarea {
            background: var(--hover);
            border: 1px solid var(--border);
            color: white;
            padding: 0.8rem;
            border-radius: 0.6rem;
            width: 100%;
            outline: none;
            margin-bottom: 1rem;
            font-size: 16px; /* Prevents zoom on iPhone */
        }

        /* --- LAYOUT --- */
        .sidebar {
            width: 260px; background: var(--card); height: 100vh; position: fixed;
            padding: 1.5rem; display: flex; flex-direction: column;
            border-right: 1px solid var(--border); z-index: 50;
        }
        
        .main-content {
            margin-left: 260px; padding: 2rem; width: calc(100% - 260px);
            min-height: 100vh; padding-bottom: 100px; /* Space for mobile nav */
        }

        .nav-item {
            padding: 1rem; margin-bottom: 0.5rem; border-radius: 0.8rem;
            color: var(--muted); cursor: pointer; display: flex; align-items: center; gap: 12px;
            font-weight: 500; transition: background 0.2s;
        }
        .nav-item.active { background: var(--primary); color: white; }
        .nav-item:hover:not(.active) { background: var(--hover); }

        /* --- MOBILE NAV BAR --- */
        .mobile-nav {
            display: none;
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            justify-content: space-between;
            border-top: 1px solid var(--border);
            z-index: 100;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
        }
        
        .mobile-nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: var(--muted); font-size: 0.7rem; gap: 4px;
            padding: 5px 10px; border-radius: 8px;
        }
        .mobile-nav-item.active { color: var(--primary); }
        .mobile-nav-item.active svg { stroke: var(--primary); }

        /* --- TAGGING UI --- */
        .tag-checkbox {
            display: flex; align-items: center; gap: 10px; padding: 12px;
            background: var(--hover); border-radius: 8px; margin-bottom: 8px; cursor: pointer;
        }
        .tag-checkbox input { width: 20px; height: 20px; margin: 0; accent-color: var(--primary); }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; width: 100%; padding: 1rem; padding-bottom: 120px; }
            .mobile-nav { display: flex; }
            .avatar-grid { grid-template-columns: repeat(2, 1fr) !important; }
        }

        /* --- LOGIN & LOADER --- */
        .avatar-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; }
        .avatar-card { padding: 1.5rem; border-radius: 1rem; cursor: pointer; background: var(--card); border: 2px solid transparent; text-align: center; }
        .avatar-card.selected { border-color: var(--primary); background: rgba(59, 130, 246, 0.1); }

        .loader-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 200; display: flex; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--hover); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="app-loader" class="loader-overlay"><div class="spinner"></div></div>

    <div id="login-view" class="flex hidden" style="height: 100vh; align-items: center; justify-content: center; background: radial-gradient(circle, #1E293B 0%, #0F172A 100%);">
        <div class="card p-4" style="width: 90%; max-width: 600px;">
            <div class="text-center" style="margin-bottom: 2rem;">
                <h1 style="font-size: 2rem; font-weight: 800; margin-bottom: 5px;">SLBDMIS</h1>
                <p class="text-muted text-sm">Lead-Filter Pro Tracking System</p>
            </div>
            
            <div id="avatar-container" class="avatar-grid"></div>

            <div id="auth-box" class="hidden text-center" style="margin-top: 2rem; animation: fadeIn 0.3s;">
                <input type="password" id="cid-input" placeholder="Enter CID to Login" style="text-align: center; letter-spacing: 2px;">
                <p id="login-err" style="color: var(--danger); min-height: 20px; font-size: 0.9rem;"></p>
                <button onclick="login()" class="btn btn-primary" style="width: 100%;">Access Dashboard</button>
            </div>
        </div>
    </div>

    <div id="dashboard-view" class="hidden">
        <nav class="sidebar">
            <div class="flex" style="align-items: center; gap: 10px; margin-bottom: 2rem;">
                <div style="background: var(--primary); padding: 8px; border-radius: 8px;"><i data-lucide="layout-grid" color="white"></i></div>
                <div><div class="font-bold">SLBDMIS</div><div class="text-xs text-muted">v4.0 God Mode</div></div>
            </div>
            <div id="sidebar-links"></div>
            <div style="margin-top: auto;" class="nav-item" onclick="handleLogout()"><i data-lucide="log-out"></i> Logout</div>
        </nav>

        <main class="main-content">
            <header class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div>
                    <h2 id="page-title" class="font-bold" style="font-size: 1.5rem;">Overview</h2>
                    <p class="text-muted text-sm">Hi, <span id="user-display">User</span></p>
                </div>
                <div class="flex" style="gap: 10px;">
                    <button onclick="openCreateModal()" class="btn btn-primary"><i data-lucide="plus"></i> <span style="display:none; @media(min-width:600px){display:inline;}">New</span></button>
                    <button onclick="renderPage(STATE.page)" class="btn btn-ghost"><i data-lucide="refresh-cw"></i></button>
                </div>
            </header>
            <div id="content-area"></div>
        </main>

        <nav id="mobile-nav" class="mobile-nav"></nav>
    </div>

    <div id="create-modal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; display: flex; align-items: center; justify-content: center;">
        <div class="card p-4" style="width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 class="font-bold text-lg">Create New</h3>
                <button onclick="closeModal('create-modal')" class="btn btn-ghost" style="padding: 5px;"><i data-lucide="x"></i></button>
            </div>
            
            <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 1rem;">
                <button onclick="setCreateMode('task')" id="btn-mode-task" class="btn btn-primary text-xs">Task</button>
                <button onclick="setCreateMode('decision')" id="btn-mode-decision" class="btn btn-ghost text-xs">Decision</button>
                <button onclick="setCreateMode('opp')" id="btn-mode-opp" class="btn btn-ghost text-xs">Opportunity</button>
            </div>

            <input id="create-title" placeholder="Title / Subject">
            <textarea id="create-desc" placeholder="Details..." rows="3"></textarea>
            
            <div id="task-fields">
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px;">
                    <select id="create-priority">
                        <option value="Normal">Normal</option>
                        <option value="High">High</option>
                        <option value="Urgent">Urgent</option>
                    </select>
                    <input type="date" id="create-date">
                </div>
            </div>

            <div style="margin-top: 10px;">
                <label class="text-xs text-muted mb-2 block font-bold">TAG TEAM MEMBERS:</label>
                <div id="tag-list" style="max-height: 120px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 5px;"></div>
            </div>

            <button onclick="submitCreate()" class="btn btn-success w-full" style="margin-top: 1.5rem;">Submit</button>
        </div>
    </div>

    <div id="approve-modal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; display: flex; align-items: center; justify-content: center;">
        <div class="card p-4" style="width: 90%; max-width: 400px;">
            <h3 class="font-bold mb-4">Assign Task</h3>
            <input type="hidden" id="approve-id">
            <label class="text-muted text-sm">Assign To:</label>
            <select id="assign-select"></select>
            <button onclick="confirmAssign()" class="btn btn-success w-full" style="margin-top: 1rem;">Confirm Assignment</button>
            <button onclick="closeModal('approve-modal')" class="btn btn-ghost w-full" style="margin-top: 0.5rem;">Cancel</button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const SB_URL = 'https://bzrkbjjgymdbbwpatfct.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6cmtiampneW1kYmJ3cGF0ZmN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTcyNjcsImV4cCI6MjA4NTg3MzI2N30.Icv1daEp7NophE_ktPl2G1EgDP6awo0tyV14yh3Q4Sw';
        const sbClient = window.supabase.createClient(SB_URL, SB_KEY);

        const TEAM = [
            { id: 1, name: "Pema Ugyen", avatar: "ðŸ‘¨â€ðŸ’¼", cid: "11107008201", role: "LEADER" },
            { id: 2, name: "Jamphel", avatar: "ðŸ‘¨â€ðŸ’»", cid: "11302003634", role: "MEMBER" },
            { id: 3, name: "Kuenley", avatar: "ðŸ‘©â€ðŸ’»", cid: "11006001849", role: "MEMBER" },
            { id: 4, name: "Laxmi", avatar: "ðŸ‘¨â€ðŸ”§", cid: "11103002151", role: "MEMBER" },
            { id: 5, name: "Ngawang", avatar: "ðŸ‘¨â€ðŸŽ“", cid: "10801003243", role: "MEMBER" }
        ];

        const STATE = { user: null, page: 'overview', createMode: 'task', selectedAvatar: null };

        // --- INIT ---
        window.onload = () => {
            lucide.createIcons();
            const savedId = localStorage.getItem('slbd_uid');
            if (savedId) {
                const user = TEAM.find(u => u.id === parseInt(savedId));
                if (user) { STATE.user = user; initApp(); return; }
            }
            renderLoginView();
        };

        function renderLoginView() {
            document.getElementById('app-loader').classList.add('hidden');
            document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('avatar-container').innerHTML = TEAM.map(u => `
                <div class="avatar-card" onclick="selectAvatar(${u.id}, this)">
                    <div style="font-size: 2.5rem;">${u.avatar}</div>
                    <div class="font-bold text-sm mt-2">${u.name.split(' ')[0]}</div>
                    <div class="text-xs text-muted">${u.role}</div>
                </div>
            `).join('');
        }

        // --- AUTH ---
        function selectAvatar(id, el) {
            document.querySelectorAll('.avatar-card').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            STATE.selectedAvatar = TEAM.find(u => u.id === id);
            document.getElementById('auth-box').classList.remove('hidden');
            document.getElementById('cid-input').value = '';
            document.getElementById('cid-input').focus();
        }

        function login() {
            if (document.getElementById('cid-input').value === STATE.selectedAvatar.cid) {
                STATE.user = STATE.selectedAvatar;
                localStorage.setItem('slbd_uid', STATE.user.id);
                initApp();
            } else {
                document.getElementById('login-err').innerText = "âŒ Invalid CID";
            }
        }

        function handleLogout() {
            localStorage.removeItem('slbd_uid');
            location.reload();
        }

        // --- NAV ---
        function initApp() {
            document.getElementById('app-loader').classList.add('hidden');
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
            document.getElementById('user-display').innerText = STATE.user.name.split(' ')[0];
            
            const links = [
                { id: 'overview', icon: 'layout-dashboard', label: 'Overview' },
                { id: 'tasks', icon: 'check-square', label: 'Tasks' },
                { id: 'attendance', icon: 'calendar', label: 'Attendance' },
                { id: 'decisions', icon: 'file-text', label: 'Decisions' },
                { id: 'collab', icon: 'users', label: 'Collab' }
            ];
            
            if(STATE.user.role === 'LEADER') links.push({ id: 'team', icon: 'crown', label: 'Team God Mode' });

            const renderNav = (target, isMobile) => {
                document.getElementById(target).innerHTML = links.map(l => `
                    <div class="${isMobile ? 'mobile-nav-item' : 'nav-item'}" id="${isMobile ? 'm-' : ''}nav-${l.id}" onclick="setPage('${l.id}')">
                        <i data-lucide="${l.icon}" size="${isMobile ? 20 : 20}"></i> 
                        <span>${l.label}</span>
                    </div>
                `).join('');
                if(isMobile) {
                    // Add logout to mobile nav
                    document.getElementById(target).innerHTML += `
                        <div class="mobile-nav-item" onclick="handleLogout()">
                            <i data-lucide="log-out" size="20"></i><span>Exit</span>
                        </div>
                    `;
                }
            };

            renderNav('sidebar-links', false);
            renderNav('mobile-nav', true);
            setPage('overview');
        }

        function setPage(page) {
            STATE.page = page;
            document.querySelectorAll('.nav-item, .mobile-nav-item').forEach(e => e.classList.remove('active'));
            document.querySelectorAll(`#nav-${page}, #m-nav-${page}`).forEach(e => e.classList.add('active'));
            document.getElementById('page-title').innerText = page === 'team' ? 'Team God Mode' : page.charAt(0).toUpperCase() + page.slice(1);
            renderPage(page);
        }

        async function renderPage(page) {
            const content = document.getElementById('content-area');
            content.innerHTML = '<div class="text-center p-10 text-muted"><div class="spinner" style="margin: 0 auto;"></div><br>Loading data...</div>';
            
            try {
                if(page === 'overview') await renderOverview(content);
                else if(page === 'tasks') await renderTasks(content);
                else if(page === 'attendance') await renderAttendance(content);
                else if(page === 'decisions') await renderDecisions(content);
                else if(page === 'collab') await renderCollab(content);
                else if(page === 'team') await renderTeam(content);
                lucide.createIcons();
            } catch(e) {
                content.innerHTML = `<div class="text-danger text-center">Error: ${e.message}</div>`;
            }
        }

        // --- VIEWS ---
        
        async function renderOverview(container) {
            const { data: tasks } = await sbClient.from('tasks').select('*');
            const myTasks = STATE.user.role === 'MEMBER' ? tasks.filter(t => t.assignee_id === STATE.user.id) : tasks;
            
            container.innerHTML = `
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div class="card p-4">
                        <div class="text-muted text-xs">Active</div>
                        <div class="font-bold text-2xl text-primary">${myTasks.filter(t => t.status === 'Ongoing').length}</div>
                    </div>
                    <div class="card p-4">
                        <div class="text-muted text-xs">Waiting</div>
                        <div class="font-bold text-2xl text-warning">${tasks.filter(t => t.status === 'Waiting').length}</div>
                    </div>
                    <div class="card p-4">
                        <div class="text-muted text-xs">Done</div>
                        <div class="font-bold text-2xl text-success">${myTasks.filter(t => t.status === 'Done').length}</div>
                    </div>
                </div>
                <div class="card p-4" style="height: 300px;">
                    <canvas id="mainChart"></canvas>
                </div>
            `;
            
            new Chart(document.getElementById('mainChart'), {
                type: 'bar',
                data: {
                    labels: ['Done', 'Ongoing', 'Waiting'],
                    datasets: [{ label: 'Tasks', data: [
                        tasks.filter(t => t.status === 'Done').length,
                        tasks.filter(t => t.status === 'Ongoing').length,
                        tasks.filter(t => t.status === 'Waiting').length
                    ], backgroundColor: ['#10B981', '#3B82F6', '#F59E0B'] }]
                },
                options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        async function renderTasks(container) {
            let query = sbClient.from('tasks').select('*, users!assignee_id(name)').order('created_at', {ascending: false});
            if(STATE.user.role === 'MEMBER') query = query.or(`assignee_id.eq.${STATE.user.id},creator_id.eq.${STATE.user.id}`);
            const { data: tasks } = await query;

            if(!tasks.length) return container.innerHTML = '<div class="text-center text-muted p-10">No tasks found.</div>';

            container.innerHTML = tasks.map(t => `
                <div class="card p-4 mb-3">
                    <div class="flex" style="justify-content: space-between; margin-bottom: 0.5rem;">
                        <h4 class="font-bold">${t.task_title}</h4>
                        <div class="flex gap-2">
                            <span class="text-xs" style="color:var(--primary)">${t.priority}</span>
                            <span class="text-xs" style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">${t.status}</span>
                        </div>
                    </div>
                    <p class="text-sm text-muted mb-2">${t.description || 'No description'}</p>
                    ${renderTags(t.tagged_members)}
                    <div class="text-xs text-muted mt-2">Assigned: ${t.users ? t.users.name.split(' ')[0] : 'Unassigned'} â€¢ Due: ${t.due_date || 'N/A'}</div>
                    
                    <div class="flex gap-2 mt-3">
                        ${t.status === 'Ongoing' ? `<button onclick="updateStatus('${t.id}', 'Done')" class="btn btn-success btn-sm" style="padding: 5px 10px; font-size: 0.8rem;">Done</button>` : ''}
                        ${t.status === 'Waiting' && STATE.user.role === 'LEADER' ? `<button onclick="openApprove('${t.id}')" class="btn btn-primary btn-sm" style="padding: 5px 10px; font-size: 0.8rem;">Approve</button>` : ''}
                        ${STATE.user.role === 'LEADER' ? `<button onclick="deleteItem('tasks', '${t.id}')" class="btn btn-danger btn-sm" style="padding: 5px 10px; font-size: 0.8rem;"><i data-lucide="trash-2" size="14"></i></button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function renderDecisions(container) {
            const { data: items } = await sbClient.from('decisions').select('*, users!proposed_by(name)').order('created_at', {ascending: false});
            container.innerHTML = items.length ? items.map(d => `
                <div class="card p-4 mb-3">
                    <div class="flex" style="justify-content: space-between;">
                        <h4 class="font-bold">${d.subject}</h4>
                        ${d.is_verified ? '<span class="text-success text-xs font-bold">Verified âœ…</span>' : '<span class="text-warning text-xs">Pending</span>'}
                    </div>
                    <p class="text-sm text-muted mt-1">${d.details}</p>
                    ${renderTags(d.tagged_members)}
                    <div class="text-xs text-muted mt-2">By: ${d.users.name.split(' ')[0]}</div>
                    <div class="flex gap-2 mt-2">
                        ${!d.is_verified && STATE.user.role === 'LEADER' ? `<button onclick="verifyDecision('${d.id}')" class="btn btn-success btn-sm" style="padding: 4px 8px; font-size: 0.8rem;">Verify</button>` : ''}
                        ${STATE.user.role === 'LEADER' ? `<button onclick="deleteItem('decisions', '${d.id}')" class="btn btn-danger btn-sm" style="padding: 4px 8px;"><i data-lucide="trash-2" size="14"></i></button>` : ''}
                    </div>
                </div>
            `).join('') : '<div class="text-center text-muted">No decisions yet.</div>';
        }

        async function renderCollab(container) {
            const { data: items } = await sbClient.from('opportunities').select('*, users!posted_by(name)').order('created_at', {ascending: false});
            container.innerHTML = items.length ? items.map(o => `
                <div class="card p-4 mb-3">
                    <h4 class="font-bold">${o.title}</h4>
                    <p class="text-sm text-muted mt-1">${o.description || ''}</p>
                    ${renderTags(o.tagged_members)}
                    <div class="text-xs text-muted mt-2">Posted by ${o.users.name.split(' ')[0]}</div>
                    ${STATE.user.role === 'LEADER' ? `<button onclick="deleteItem('opportunities', '${o.id}')" class="btn btn-danger btn-sm mt-2" style="padding: 4px 8px;"><i data-lucide="trash-2" size="14"></i></button>` : ''}
                </div>
            `).join('') : '<div class="text-center text-muted">No opportunities.</div>';
        }

        async function renderAttendance(container) {
            const today = new Date().toISOString().split('T')[0];
            const { data: myAtt } = await sbClient.from('attendance').select('*').eq('user_id', STATE.user.id).eq('date', today).single();
            const { data: history } = await sbClient.from('attendance').select('*, users(name, avatar)').order('date', {ascending: false}).limit(20);

            container.innerHTML = `
                <div class="card p-4 flex mb-4" style="justify-content: space-between; align-items: center; border: 1px solid var(--primary);">
                    <div><div class="font-bold">Today</div><div class="text-xs text-muted">${today}</div></div>
                    ${myAtt ? `<span class="btn btn-success" style="pointer-events: none;">âœ… Present</span>` : `<button onclick="markPresent()" class="btn btn-primary">Mark Present</button>`}
                </div>
                <h4 class="font-bold mb-2 ml-1">Log</h4>
                <div class="card p-0" style="overflow: hidden;">
                    ${history.map(h => `
                        <div class="p-3 flex" style="justify-content: space-between; border-bottom: 1px solid var(--border);">
                            <div class="flex items-center gap-2">
                                <span>${h.users.avatar}</span>
                                <div><div class="text-sm font-bold">${h.users.name.split(' ')[0]}</div><div class="text-xs text-muted">${h.date}</div></div>
                            </div>
                            <span class="text-success text-xs font-bold">Present</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function renderTeam(container) {
            // GOD MODE
            const { data: users } = await sbClient.from('users').select('*').neq('role', 'LEADER');
            const { data: tasks } = await sbClient.from('tasks').select('*');
            const { data: att } = await sbClient.from('attendance').select('*');

            container.innerHTML = `<div class="grid" style="gap: 1rem;">
                ${users.map(u => {
                    const uTasks = tasks.filter(t => t.assignee_id === u.id);
                    const activeTasks = uTasks.filter(t => t.status === 'Ongoing');
                    const uAtt = att.filter(a => a.user_id === u.id).length;
                    
                    return `
                        <div class="card p-4">
                            <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div class="flex" style="align-items: center; gap: 10px;">
                                    <div style="font-size: 2rem;">${u.avatar}</div>
                                    <div>
                                        <div class="font-bold">${u.name}</div>
                                        <div class="text-xs text-muted">${uTasks.filter(t => t.status === 'Done').length} Completed â€¢ ${uAtt} Days Present</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                                <div class="text-xs font-bold text-muted mb-2">CURRENTLY WORKING ON:</div>
                                ${activeTasks.length ? activeTasks.map(t => `
                                    <div class="text-sm" style="margin-bottom: 4px;">â€¢ ${t.task_title} <span class="text-xs text-warning">(${t.priority})</span></div>
                                `).join('') : '<div class="text-xs text-muted italic">No active tasks</div>'}
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>`;
        }

        // --- HELPERS ---
        function renderTags(ids) {
            if(!ids || ids.length === 0) return '';
            return `<div class="flex gap-1 mt-2 flex-wrap">
                ${ids.map(id => {
                    const u = TEAM.find(x => x.id === id);
                    return u ? `<span class="text-xs" style="background:rgba(59,130,246,0.2); color:#93C5FD; padding:2px 6px; border-radius:4px;">@${u.name.split(' ')[0]}</span>` : '';
                }).join('')}
            </div>`;
        }

        // --- ACTIONS ---
        function setCreateMode(mode) {
            STATE.createMode = mode;
            ['task','decision','opp'].forEach(m => document.getElementById(`btn-mode-${m}`).className = 'btn btn-ghost text-xs');
            document.getElementById(`btn-mode-${mode}`).className = 'btn btn-primary text-xs';
            document.getElementById('task-fields').classList.toggle('hidden', mode !== 'task');
            
            // Generate Tag List for all modes
            document.getElementById('tag-list').innerHTML = TEAM.filter(u => u.id !== STATE.user.id).map(u => `
                <label class="tag-checkbox">
                    <input type="checkbox" value="${u.id}" class="tag-input">
                    <span>${u.avatar} ${u.name.split(' ')[0]}</span>
                </label>
            `).join('');
        }

        async function submitCreate() {
            const title = document.getElementById('create-title').value;
            const desc = document.getElementById('create-desc').value;
            if(!title) return alert('Title required');

            const tags = Array.from(document.querySelectorAll('.tag-input:checked')).map(cb => parseInt(cb.value));
            let error;

            if(STATE.createMode === 'task') {
                const { error: e } = await sbClient.from('tasks').insert({
                    task_title: title, description: desc,
                    priority: document.getElementById('create-priority').value,
                    due_date: document.getElementById('create-date').value,
                    creator_id: STATE.user.id, status: 'Waiting', tagged_members: tags
                });
                error = e;
            } else if (STATE.createMode === 'decision') {
                const { error: e } = await sbClient.from('decisions').insert({
                    subject: title, details: desc, proposed_by: STATE.user.id, tagged_members: tags
                });
                error = e;
            } else {
                const { error: e } = await sbClient.from('opportunities').insert({
                    title: title, description: desc,
                    posted_by: STATE.user.id, tagged_members: tags
                });
                error = e;
            }

            if(error) alert(error.message);
            else { closeModal('create-modal'); renderPage(STATE.page); }
        }

        async function confirmAssign() {
            const tid = document.getElementById('approve-id').value;
            const aid = document.getElementById('assign-select').value;
            await sbClient.from('tasks').update({ status: 'Ongoing', assignee_id: aid }).eq('id', tid);
            closeModal('approve-modal'); renderPage('tasks');
        }

        async function markPresent() {
            await sbClient.from('attendance').insert({ user_id: STATE.user.id, date: new Date().toISOString().split('T')[0] });
            renderPage('attendance');
        }

        async function updateStatus(id, status) {
            await sbClient.from('tasks').update({ status: status, completed_at: new Date().toISOString() }).eq('id', id);
            renderPage('tasks');
        }

        async function verifyDecision(id) {
            await sbClient.from('decisions').update({ is_verified: true, verified_by: STATE.user.id }).eq('id', id);
            renderPage('decisions');
        }

        async function deleteItem(table, id) {
            if(!confirm('Delete?')) return;
            await sbClient.from(table).delete().eq('id', id);
            renderPage(STATE.page);
        }

        function openCreateModal() { 
            document.getElementById('create-modal').classList.remove('hidden'); 
            document.getElementById('create-title').value = '';
            document.getElementById('create-desc').value = '';
            setCreateMode('task'); 
        }
        function openApprove(id) {
            document.getElementById('approve-id').value = id;
            document.getElementById('assign-select').innerHTML = TEAM.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
            document.getElementById('approve-modal').classList.remove('hidden');
        }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    </script>
</body>
</html>
