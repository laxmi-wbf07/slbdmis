<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SLBDMIS | Enterprise v5.5</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”¹</text></svg>">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- THEME SETTINGS --- */
        :root { 
            --primary: #3b82f6;       
            --primary-dark: #2563eb;
            --accent: #10b981;        
            --bg: #0b1121;            /* Very Dark Background */
            --panel: #1e293b;         /* Solid Slate 800 (No Transparency) */
            --border: #334155;        
            --text-main: #ffffff;     /* Pure White */
            --text-desc: #cbd5e1;     /* Light Gray for descriptions */
            --text-muted: #94a3b8;    
            --sidebar-width: 260px;
        }

        body { 
            background-color: var(--bg); 
            color: var(--text-main); 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden; 
        }

        /* --- LAYOUT FIXES (Prevents Overlap) --- */
        .fixed-top { z-index: 1040; background: var(--bg); border-bottom: 1px solid var(--border); }
        .fixed-bottom { z-index: 1040; background: var(--bg); border-top: 1px solid var(--border); }
        
        /* Force Modals to be on top of EVERYTHING */
        .modal { z-index: 9999 !important; }
        .modal-backdrop { z-index: 9998 !important; }

        /* Solid Panels for Maximum Contrast */
        .content-card { 
            background-color: var(--panel); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            padding: 20px;
            margin-bottom: 16px;
        }

        /* Text Styles */
        .mono-label { 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 0.7rem; 
            text-transform: uppercase; 
            letter-spacing: 1px;
            color: var(--text-muted); 
            margin-bottom: 6px;
            display: block;
        }

        .task-desc {
            color: var(--text-desc);
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        /* Assignee Badge */
        .assignee-badge {
            background: #0f172a;
            border: 1px solid var(--border);
            color: #e2e8f0;
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-right: 4px;
            margin-bottom: 4px;
        }

        /* Inputs (High Contrast) */
        .form-control, .form-select {
            background: #020617 !important; 
            border: 1px solid #475569 !important;
            color: white !important; 
            padding: 12px;
        }
        .form-control:focus { border-color: var(--primary) !important; }

        /* --- RESPONSIVE WRAPPER --- */
        .sidebar-container {
            position: fixed; top: 0; left: 0; height: 100vh; width: var(--sidebar-width);
            background: var(--bg); border-right: 1px solid var(--border);
            z-index: 1050; display: none; flex-direction: column; padding: 1.5rem;
        }

        .app-wrapper { width: 100%; min-height: 100vh; padding: 20px; }

        @media (max-width: 767.98px) {
            /* Extra spacing for mobile to clear top/bottom bars */
            .app-wrapper { padding-top: 100px; padding-bottom: 120px; padding-left: 15px; padding-right: 15px; }
            .mobile-header, .mobile-nav { display: flex !important; }
        }

        @media (min-width: 768px) {
            .sidebar-container { display: flex; }
            .app-wrapper { padding-left: calc(var(--sidebar-width) + 40px); padding-top: 40px; }
            .mobile-header, .mobile-nav { display: none !important; }
        }

        /* --- WIDGETS --- */
        .btn-primary { background: var(--primary); border: none; font-weight: 600; }
        
        .nav-link-custom { display: flex; align-items: center; gap: 12px; padding: 12px; color: var(--text-muted); text-decoration: none; border-radius: 8px; transition: 0.2s; }
        .nav-link-custom.active { background: var(--primary); color: white; }
        
        .nav-mobile-item { color: #64748b; padding: 10px; flex: 1; text-align: center; }
        .nav-mobile-item.active { color: var(--primary); }

        .bar-container { display: flex; align-items: flex-end; height: 120px; gap: 8px; }
        .bar-track { width: 100%; height: 100%; background: #334155; border-radius: 4px; position: relative; overflow: hidden; }
        .bar-fill { position: absolute; bottom: 0; left: 0; width: 100%; background: var(--primary); }
    </style>
</head>
<body>

    <div id="view-auth" class="d-none fixed-top w-100 h-100 bg-black d-flex flex-column justify-content-center align-items-center" style="z-index: 5000;">
        <div class="text-center mb-5">
            <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                <i data-lucide="shield-check" class="text-white" size="40"></i>
            </div>
            <h1 class="fw-bold text-white">SLBDMIS</h1>
            <p class="text-muted">SECURE LOGIN</p>
        </div>
        <div id="auth-list" class="row g-3 px-3" style="max-width: 450px; width: 100%;"></div>
        
        <div id="auth-pin" class="d-none text-center" style="max-width: 320px;">
            <div id="l-av" class="display-3 mb-3"></div>
            <h3 id="l-name" class="text-white mb-4"></h3>
            <input type="password" id="inp-pin" class="form-control text-center fs-3 mb-3" maxlength="11" placeholder="Enter PIN">
            <button onclick="tryLogin()" class="btn btn-primary w-100 py-3 fw-bold fs-5">UNLOCK</button>
            <button onclick="resetAuth()" class="btn btn-link text-secondary text-decoration-none mt-2">Go Back</button>
        </div>
    </div>

    <div id="view-app" class="d-none">
        
        <div class="sidebar-container">
            <div class="d-flex align-items-center gap-2 px-2 mb-5">
                <div class="bg-primary rounded p-1"><i data-lucide="box" class="text-white" size="24"></i></div>
                <span class="fw-bold text-white fs-5">SLBDMIS</span>
            </div>
            <nav class="flex-grow-1 d-flex flex-column gap-1">
                <a onclick="nav('home')" id="nd-home" class="nav-link-custom cursor-pointer"><i data-lucide="layout-dashboard"></i> Dashboard</a>
                <a onclick="nav('cal')" id="nd-cal" class="nav-link-custom cursor-pointer"><i data-lucide="calendar"></i> Calendar</a>
                <a onclick="nav('task')" id="nd-task" class="nav-link-custom cursor-pointer"><i data-lucide="check-square"></i> Tasks</a>
                <a onclick="nav('idea')" id="nd-idea" class="nav-link-custom cursor-pointer"><i data-lucide="lightbulb"></i> Ideas</a>
                <a onclick="nav('feed')" id="nd-feed" class="nav-link-custom cursor-pointer"><i data-lucide="message-square"></i> Feed</a>
                <a onclick="nav('drive')" id="nd-drive" class="nav-link-custom cursor-pointer"><i data-lucide="hard-drive"></i> Drive</a>
            </nav>
            <div class="mt-auto border-top border-secondary border-opacity-25 pt-3">
                <div class="d-flex align-items-center gap-3">
                    <div id="d-av" class="fs-4"></div>
                    <div>
                        <div id="d-name" class="fw-bold small"></div>
                        <div id="d-role" class="text-muted text-xs small"></div>
                    </div>
                    <button onclick="doLogout()" class="btn btn-icon ms-auto text-secondary"><i data-lucide="log-out"></i></button>
                </div>
            </div>
        </div>

        <div class="mobile-header fixed-top px-3 d-flex align-items-center justify-content-between" style="height: 70px;">
            <div class="fw-bold text-white d-flex align-items-center gap-2 fs-5">
                <i data-lucide="box" class="text-primary"></i> SLBDMIS
            </div>
            <div class="d-flex align-items-center gap-3">
                <div id="m-av" class="fs-4"></div>
                <button onclick="doLogout()" class="btn btn-sm text-secondary"><i data-lucide="log-out"></i></button>
            </div>
        </div>

        <div class="app-wrapper">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 id="page-title" class="fw-bold text-white m-0">Dashboard</h2>
                <button onclick="openCreate()" class="btn btn-primary d-flex align-items-center gap-2">
                    <i data-lucide="plus"></i> <span class="d-none d-sm-inline">New Item</span>
                </button>
            </div>
            <div id="app-content"></div>
        </div>

        <div class="mobile-nav fixed-bottom px-2 d-flex justify-content-between align-items-center" style="height: 70px;">
            <div onclick="nav('home')" id="nm-home" class="nav-mobile-item"><i data-lucide="layout-dashboard"></i></div>
            <div onclick="nav('cal')" id="nm-cal" class="nav-mobile-item"><i data-lucide="calendar"></i></div>
            <div onclick="nav('task')" id="nm-task" class="nav-mobile-item"><i data-lucide="check-square"></i></div>
            <div onclick="nav('idea')" id="nm-idea" class="nav-mobile-item"><i data-lucide="lightbulb"></i></div>
            <div onclick="nav('feed')" id="nm-feed" class="nav-mobile-item"><i data-lucide="message-square"></i></div>
            <div onclick="nav('drive')" id="nm-drive" class="nav-mobile-item"><i data-lucide="hard-drive"></i></div>
        </div>
    </div>

    <div class="modal fade" id="modCreate" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background: #1e293b; color: white; border: 1px solid #334155;">
                <div class="modal-header border-bottom border-secondary">
                    <h5 class="fw-bold">Create New</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="btn-group w-100 mb-3">
                        <input type="radio" class="btn-check" name="ctype" id="ct-task" value="task" checked onchange="toggleForm('task')">
                        <label class="btn btn-outline-secondary" for="ct-task">Task</label>
                        <input type="radio" class="btn-check" name="ctype" id="ct-idea" value="idea" onchange="toggleForm('idea')">
                        <label class="btn btn-outline-secondary" for="ct-idea">Idea</label>
                        <input type="radio" class="btn-check" name="ctype" id="ct-msg" value="feed" onchange="toggleForm('feed')">
                        <label class="btn btn-outline-secondary" for="ct-msg">Post</label>
                    </div>

                    <label class="mono-label">Title</label>
                    <input type="text" id="inp-title" class="form-control mb-3 fw-bold" placeholder="Task Title...">
                    
                    <label class="mono-label">Description</label>
                    <textarea id="inp-desc" class="form-control mb-3" rows="3" placeholder="Details..."></textarea>
                    
                    <div id="form-task-opts">
                        <div class="row g-2 mb-3">
                            <div class="col-6"><label class="mono-label">Due Date</label><input type="date" id="inp-date" class="form-control"></div>
                            <div class="col-6">
                                <label class="mono-label">Priority</label>
                                <select id="inp-prio" class="form-select">
                                    <option value="Normal">Normal</option>
                                    <option value="High">High</option>
                                </select>
                            </div>
                        </div>
                        <label class="mono-label">Assign To</label>
                        <div id="div-mems" class="d-flex flex-wrap gap-2 mb-3"></div>
                    </div>
                    <button onclick="saveItem()" class="btn btn-primary w-100 py-3">Create</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modSubmit" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background: #1e293b; color: white; border: 1px solid #334155;">
                <div class="modal-header border-bottom border-secondary">
                    <h5 class="fw-bold">Upload File</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="text-muted small">Select Folder:</p>
                    <div class="row g-2 mb-3">
                        <div class="col-6"><button onclick="openDriveLink('Admin')" class="btn btn-outline-secondary w-100 p-3">Admin</button></div>
                        <div class="col-6"><button onclick="openDriveLink('Machine')" class="btn btn-outline-secondary w-100 p-3">Machine</button></div>
                        <div class="col-6"><button onclick="openDriveLink('Pics')" class="btn btn-outline-secondary w-100 p-3">Media</button></div>
                        <div class="col-6"><button onclick="openDriveLink('PPT')" class="btn btn-outline-secondary w-100 p-3">PPT</button></div>
                    </div>
                    <textarea id="sub-note" class="form-control mb-3" placeholder="Submission Note..."></textarea>
                    <button onclick="confirmSubmit()" class="btn btn-success w-100 py-2">Confirm Upload</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 6000">
        <div id="sysToast" class="toast align-items-center text-white bg-primary border-0" role="alert">
            <div class="d-flex"><div class="toast-body fw-bold" id="toast-msg">OK</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>
        </div>
    </div>

    <script>
        const SB_URL = 'https://bzrkbjjgymdbbwpatfct.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6cmtiampneW1kYmJ3cGF0ZmN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTcyNjcsImV4cCI6MjA4NTg3MzI2N30.Icv1daEp7NophE_ktPl2G1EgDP6awo0tyV14yh3Q4Sw';
        const sbClient = window.supabase.createClient(SB_URL, SB_KEY);
        
        const TEAM = [
            { id: 1, name: "Pema Ugyen", av: "ðŸ‘¨â€ðŸ’¼", pin: "11107008201", role: "LEADER" },
            { id: 2, name: "Jamphel",    av: "ðŸ‘¨â€ðŸ’»", pin: "11302003634", role: "MEMBER" },
            { id: 3, name: "Laxmi",      av: "ðŸ‘¨â€ðŸ”¬", pin: "11103002151", role: "MEMBER" },
            { id: 4, name: "Ngawang",    av: "ðŸ‘¨",   pin: "10801003243", role: "MEMBER" }
        ];

        const DRIVE_LINKS = {
            'Admin': 'https://drive.google.com/drive/folders/1VskzY_IgfF6lagiEdaF5-yy6Te_u-MMG?usp=sharing',
            'Machine': 'https://drive.google.com/drive/folders/1FivXbl7Qo5qnKV2Kn6DXxdtVUS4nB5CF?usp=sharing',
            'Pics': 'https://drive.google.com/drive/folders/11Q6gWSLqU4H88DrmWA_Fmbkx8dsNs0Ka?usp=sharing',
            'PPT': 'https://drive.google.com/drive/folders/1IBpIa7nH43g1UVMYkFOwLA6iEFVvuv7y?usp=sharing'
        };

        let STATE = { user: null, page: 'home', createMode: 'task' };
        let MODAL_CREATE, MODAL_SUBMIT;

        window.onload = function() {
            lucide.createIcons();
            MODAL_CREATE = new bootstrap.Modal(document.getElementById('modCreate'));
            MODAL_SUBMIT = new bootstrap.Modal(document.getElementById('modSubmit'));

            const uid = localStorage.getItem('slbd_uid');
            if(uid) { const u = TEAM.find(x => x.id == uid); if(u) login(u); else initAuth(); } else initAuth();

            sbClient.channel('public:any').on('postgres_changes', { event: '*', schema: 'public' }, () => {
                if(STATE.user) render();
            }).subscribe();
        };

        function initAuth() {
            document.getElementById('view-auth').classList.remove('d-none');
            document.getElementById('auth-list').innerHTML = TEAM.map(u => `
                <div class="col-6"><div onclick="preLogin(${u.id})" class="content-card text-center cursor-pointer"><div class="fs-1 mb-2">${u.av}</div><div class="fw-bold">${u.name.split(' ')[0]}</div></div></div>
            `).join('');
        }
        function preLogin(id) {
            STATE.selUser = TEAM.find(u => u.id === id);
            document.getElementById('auth-list').classList.add('d-none');
            document.getElementById('auth-pin').classList.remove('d-none');
            document.getElementById('l-av').innerText = STATE.selUser.av;
            document.getElementById('l-name').innerText = STATE.selUser.name;
        }
        function resetAuth() {
            document.getElementById('auth-pin').classList.add('d-none');
            document.getElementById('auth-list').classList.remove('d-none');
        }
        function tryLogin() {
            if(document.getElementById('inp-pin').value === STATE.selUser.pin) {
                localStorage.setItem('slbd_uid', STATE.selUser.id);
                document.getElementById('view-auth').classList.add('d-none');
                login(STATE.selUser);
            } else alert('Invalid PIN');
        }
        function login(u) {
            STATE.user = u;
            document.getElementById('view-app').classList.remove('d-none');
            document.getElementById('d-name').innerText = u.name;
            document.getElementById('d-role').innerText = u.role;
            document.getElementById('d-av').innerText = u.av;
            document.getElementById('m-av').innerText = u.av;
            nav('home');
        }
        function doLogout() { localStorage.removeItem('slbd_uid'); location.reload(); }

        function nav(page) {
            STATE.page = page;
            document.querySelectorAll('.nav-link-custom, .nav-mobile-item').forEach(el => el.classList.remove('active'));
            if(document.getElementById('nd-'+page)) document.getElementById('nd-'+page).classList.add('active');
            if(document.getElementById('nm-'+page)) document.getElementById('nm-'+page).classList.add('active');
            document.getElementById('page-title').innerText = page.charAt(0).toUpperCase() + page.slice(1);
            render();
        }

        async function render() {
            const container = document.getElementById('app-content');
            if(!container.innerHTML) container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
            
            try {
                const { data: tasks } = await sbClient.from('tasks').select('*').order('created_at', {ascending: false});
                const { data: feed } = await sbClient.from('decisions').select('*').order('created_at', {ascending: false});
                let html = '';

                if(STATE.page === 'home') {
                    let graph = '';
                    TEAM.forEach(m => {
                        const mt = tasks.filter(t => (t.tagged_members||[]).includes(m.id) && t.status!=='Idea');
                        let p = mt.length ? mt.reduce((a,c)=>a+(c.progress||0),0)/mt.length : 0;
                        graph += `<div class="d-flex flex-column align-items-center flex-grow-1"><div class="bar-track" style="width:100%"><div class="bar-fill" style="height:${Math.round(p)}%"></div></div><div class="mono-label mt-2">${m.name.split(' ')[0]}</div></div>`;
                    });
                    const myTasks = tasks.filter(t => t.status!=='Done' && t.status!=='Idea' && (t.tagged_members||[]).includes(STATE.user.id)).slice(0,5);
                    html = `
                        <div class="row g-4">
                            <div class="col-lg-6"><div class="content-card h-100"><h6 class="mono-label">Momentum</h6><div class="bar-container">${graph}</div></div></div>
                            <div class="col-lg-6"><div class="content-card h-100"><h6 class="mono-label">My Queue</h6>${myTasks.map(t=>`<div class="d-flex justify-content-between p-2 mb-2 border rounded border-secondary bg-dark"><span class="small">${t.task_title}</span><span class="text-primary fw-bold small">${t.progress}%</span></div>`).join('')}</div></div>
                        </div>`;
                }

                if(STATE.page === 'task') {
                    const active = tasks.filter(t => t.status!=='Idea' && t.status!=='Done');
                    html = `<div class="row g-3">${active.map(t => {
                        // FIX: Generate Assignee HTML
                        const assignees = (t.tagged_members || []).map(mid => {
                            const u = TEAM.find(x => x.id === mid);
                            return u ? `<span class="assignee-badge">${u.av} ${u.name.split(' ')[0]}</span>` : '';
                        }).join('');

                        const isMine = (t.tagged_members||[]).includes(STATE.user.id);
                        let btn = `<button onclick="openSubmit(${t.id}, '${t.task_title}')" class="btn btn-outline-secondary w-100 mt-2">Submit File</button>`;
                        if(STATE.user.role === 'LEADER' && t.status === 'ApprovalReq') btn = `<button onclick="setStatus(${t.id}, 'Pending')" class="btn btn-primary w-100 mt-2">Approve</button>`;
                        else if(t.status === 'Review') btn = STATE.user.role==='LEADER' ? `<div class="d-flex gap-2 mt-2"><button onclick="setStatus(${t.id},'Done')" class="btn btn-success flex-fill">Accept</button><button onclick="setStatus(${t.id},'Pending')" class="btn btn-danger flex-fill">Reject</button></div>` : `<div class="alert alert-info p-2 mt-2 text-center small">Under Review</div>`;

                        return `
                            <div class="col-md-6 col-xl-4">
                                <div class="content-card h-100">
                                    <div class="d-flex justify-content-between mb-2"><span class="badge bg-secondary">${t.status}</span>${t.priority==='High'?'<span class="text-danger fw-bold small">HIGH</span>':''}</div>
                                    <h5 class="fw-bold mb-2">${t.task_title}</h5>
                                    <div class="mb-3">${assignees || '<span class="text-muted small">Unassigned</span>'}</div>
                                    <p class="task-desc">${t.description}</p>
                                    ${isMine ? `<input type="range" class="form-range" value="${t.progress}" onchange="setProgress(${t.id},this.value)">` : `<div class="progress" style="height:5px"><div class="progress-bar" style="width:${t.progress}%"></div></div>`}
                                    ${btn}
                                </div>
                            </div>`;
                    }).join('')}</div>`;
                }

                if(STATE.page === 'cal') {
                    const now = new Date();
                    const dim = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
                    const skip = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
                    let grid = '';
                    for(let i=0;i<skip;i++) grid += `<div></div>`;
                    for(let d=1;d<=dim;d++) {
                        const date = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                        const dt = tasks.filter(t=>t.due_date===date && t.status!=='Idea');
                        grid += `<div onclick="openCreateWithDate('${date}')" class="p-2 border border-secondary" style="min-height:80px; background:${d===now.getDate()?'rgba(59,130,246,0.1)':'transparent'}"><div class="small fw-bold text-end">${d}</div>${dt.map(t=>`<div class="small text-truncate bg-primary bg-opacity-25 px-1 mt-1 rounded" style="font-size:10px">${t.task_title}</div>`).join('')}</div>`;
                    }
                    html = `<div class="content-card p-0 overflow-hidden"><div class="p-3 text-center fw-bold bg-dark border-bottom border-secondary">${now.toLocaleString('default',{month:'long'})}</div><div style="display:grid; grid-template-columns:repeat(7,1fr); gap:1px; background:#334155">${grid}</div></div>`;
                }

                if(STATE.page === 'idea') {
                    html = `<div class="text-center mb-4"><button onclick="openCreate('idea')" class="btn btn-outline-secondary px-5">Add Idea</button></div>
                    <div class="row g-3">${tasks.filter(t=>t.status==='Idea').map(t=>`<div class="col-md-6"><div class="content-card border-start border-4 border-info"><h5>${t.task_title}</h5><p class="task-desc">${t.description}</p><button onclick="setStatus(${t.id},'Pending')" class="btn btn-sm btn-primary">Approve</button></div></div>`).join('')}</div>`;
                }

                if(STATE.page === 'feed') {
                    html = `<div class="content-card mb-3" style="height:60vh; overflow-y:auto">${feed.map(f=>`<div class="p-3 mb-2 rounded ${f.subject.includes('LEADER')?'bg-primary bg-opacity-10 border border-primary':'bg-dark border border-secondary'}"><div class="fw-bold small mb-1">${f.subject}</div><div class="small text-light">${f.details}</div></div>`).join('')}</div><button onclick="openCreate('feed')" class="btn btn-primary w-100 p-3">Post Message</button>`;
                }

                if(STATE.page === 'drive') {
                    html = `<div class="row g-3 mb-4">${Object.keys(DRIVE_LINKS).map(k=>`<div class="col-6 col-md-3"><div onclick="window.open('${DRIVE_LINKS[k]}')" class="content-card text-center cursor-pointer"><i data-lucide="folder" class="text-primary mb-2"></i><div class="fw-bold">${k}</div></div></div>`).join('')}</div><div class="content-card"><h6 class="mono-label">Archive</h6><table class="table table-dark table-sm"><tbody>${tasks.filter(t=>t.status==='Done').map(t=>`<tr><td>${t.task_title}</td><td class="text-end">${new Date(t.updated_at).toLocaleDateString()}</td></tr>`).join('')}</tbody></table></div>`;
                }

                container.innerHTML = html;
                lucide.createIcons();
            } catch(e) { console.error(e); }
        }

        function openCreate(type) {
            if(type) { document.getElementById('ct-'+(type==='feed'?'msg':type)).checked=true; toggleForm(type==='feed'?'feed':type); }
            document.getElementById('div-mems').innerHTML = TEAM.map(u => `<input type="checkbox" class="btn-check" id="chk-${u.id}" value="${u.id}"><label class="btn btn-outline-secondary btn-sm" for="chk-${u.id}">${u.name.split(' ')[0]}</label>`).join('');
            MODAL_CREATE.show();
        }
        function openCreateWithDate(d) { openCreate('task'); setTimeout(()=>document.getElementById('inp-date').value=d, 200); }
        function toggleForm(t) { STATE.createMode=t; document.getElementById('form-task-opts').style.display = t==='task'?'block':'none'; }
        
        async function saveItem() {
            const title = document.getElementById('inp-title').value;
            const desc = document.getElementById('inp-desc').value;
            if(!title) return alert('Title required');
            
            if(STATE.createMode==='feed') await sbClient.from('decisions').insert({subject:`${STATE.user.name} [${STATE.user.role}]`, details:`${title} - ${desc}`});
            else {
                const mems = [...document.querySelectorAll('#div-mems input:checked')].map(c=>parseInt(c.value));
                await sbClient.from('tasks').insert({
                    task_title: title, description: desc, status: STATE.createMode==='idea'?'Idea':(STATE.user.role==='LEADER'?'Pending':'ApprovalReq'),
                    creator_id: STATE.user.id, tagged_members: mems, due_date: document.getElementById('inp-date').value||null, priority: document.getElementById('inp-prio').value
                });
            }
            MODAL_CREATE.hide(); document.getElementById('inp-title').value='';
            showToast('Created');
        }

        async function setProgress(id, val) { await sbClient.from('tasks').update({progress:val, updated_at:new Date()}).eq('id',id); }
        async function setStatus(id, st) { await sbClient.from('tasks').update({status:st, updated_at:new Date()}).eq('id',id); showToast('Updated'); }
        
        function openSubmit(id, t) { STATE.activeTaskForSub={id,t}; MODAL_SUBMIT.show(); }
        function openDriveLink(t) { STATE.selectedDrive=t; window.open(DRIVE_LINKS[t], '_blank'); }
        async function confirmSubmit() {
            if(!STATE.selectedDrive) return alert('Select folder first');
            await sbClient.from('tasks').update({status:'Review', updated_at:new Date()}).eq('id',STATE.activeTaskForSub.id);
            await sbClient.from('decisions').insert({subject:`FILE: ${STATE.activeTaskForSub.t}`, details:`Uploaded to ${STATE.selectedDrive}. Note: ${document.getElementById('sub-note').value}`});
            MODAL_SUBMIT.hide(); showToast('Submitted');
        }

        function showToast(m) { document.getElementById('toast-msg').innerText=m; new bootstrap.Toast(document.getElementById('sysToast')).show(); }
    </script>
</body>
</html>
