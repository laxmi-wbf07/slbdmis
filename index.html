<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>COMMAND OS | TITAN OPS</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">

    <style>
        /* --- CORE THEME --- */
        :root { 
            --primary: #00f2ff; 
            --primary-dim: rgba(0, 242, 255, 0.15);
            --accent: #ff0055;
            --bg: #050507; 
            --panel: rgba(20, 20, 28, 0.9); 
            --border: rgba(255,255,255,0.12);
            --glass: blur(12px) saturate(160%);
            --font-ui: 'Inter', sans-serif;
            --font-hud: 'JetBrains Mono', monospace;
        }

        body { background-color: var(--bg); color: #e5e5e5; font-family: var(--font-ui); overflow-x: hidden; }
        
        /* SCIFI BACKGROUND */
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(0, 242, 255, 0.04) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(255, 0, 85, 0.03) 0%, transparent 40%);
            z-index: -1; pointer-events: none;
        }

        /* --- COMPONENTS --- */
        .glass-panel { 
            background: var(--panel); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .hud-text { font-family: var(--font-hud); letter-spacing: -0.5px; text-transform: uppercase; }

        /* BUTTONS */
        .btn { border-radius: 8px; font-weight: 600; letter-spacing: 0.5px; border: none; transition: 0.2s; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary-dim); }
        .btn-primary:hover { background: #fff; box-shadow: 0 0 25px rgba(255,255,255,0.4); }
        .btn-outline-primary { border: 1px solid var(--primary); color: var(--primary); }
        .btn-outline-primary:hover { background: var(--primary); color: #000; }
        
        /* FORMS */
        .form-control, .form-select {
            background: rgba(0,0,0,0.4) !important; border: 1px solid var(--border) !important;
            color: #fff !important; border-radius: 8px; padding: 12px;
        }
        .form-control:focus { border-color: var(--primary) !important; box-shadow: 0 0 0 2px var(--primary-dim); }

        /* --- CALENDAR SYSTEM (GOOGLE STYLE) --- */
        .cal-wrapper { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .cal-header-row { display: grid; grid-template-columns: repeat(7, 1fr); background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border); }
        .cal-header-cell { padding: 10px; text-align: center; font-family: var(--font-hud); font-size: 0.7rem; color: #888; font-weight: bold; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); auto-rows: minmax(100px, auto); }
        .cal-day { 
            border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); 
            padding: 8px; position: relative; cursor: pointer; transition: 0.2s; 
            background: rgba(0,0,0,0.2);
        }
        .cal-day:hover { background: rgba(255,255,255,0.05); }
        .cal-date-num { font-family: var(--font-hud); font-size: 0.8rem; color: #666; margin-bottom: 5px; }
        .cal-today { background: rgba(0, 242, 255, 0.03); }
        .cal-today .cal-date-num { color: var(--primary); font-weight: bold; }
        
        /* TASK BARS IN CALENDAR */
        .cal-task { 
            display: block; font-size: 0.65rem; padding: 3px 6px; margin-bottom: 3px; border-radius: 4px; 
            background: rgba(255, 255, 255, 0.1); color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            border-left: 3px solid #666;
        }
        .cal-task.status-Done { text-decoration: line-through; opacity: 0.5; border-color: #444; }
        .cal-task.status-Pending { background: rgba(255, 165, 0, 0.15); color: #ffbd59; border-color: #ffbd59; }
        .cal-task.status-Review { background: rgba(0, 242, 255, 0.15); color: #00f2ff; border-color: #00f2ff; }

        /* --- MOMENTUM GRAPH --- */
        .graph-wrap { display: flex; align-items: flex-end; gap: 15px; height: 140px; padding: 10px 0; }
        .graph-col { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; }
        .graph-bar-bg { width: 100%; height: 100%; background: rgba(255,255,255,0.05); border-radius: 6px; position: relative; overflow: hidden; }
        .graph-bar-fill { 
            position: absolute; bottom: 0; left: 0; width: 100%; 
            background: linear-gradient(to top, var(--primary) 0%, #00a8ff 100%);
            transition: height 1s ease; opacity: 0.9;
        }
        .graph-val { margin-top: 8px; font-family: var(--font-hud); font-size: 0.7rem; font-weight: bold; color: #fff; }
        .graph-name { margin-top: 2px; font-size: 0.65rem; color: #888; text-transform: uppercase; }

        /* --- CHAT WIRE --- */
        .wire-msg { margin-bottom: 12px; padding: 12px; border-radius: 8px; background: rgba(255,255,255,0.03); border-left: 3px solid #444; }
        .wire-msg.type-intel { border-color: var(--accent); background: linear-gradient(90deg, rgba(255,0,85,0.05), transparent); }
        .wire-msg.type-leader { border-color: var(--primary); background: linear-gradient(90deg, rgba(0,242,255,0.05), transparent); }

        /* --- LAYOUTS --- */
        #view-boot, #view-auth { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        .nav-item { color: #666; transition: 0.3s; position: relative; padding: 10px; }
        .nav-active { color: var(--primary); }
        .nav-active::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 10px var(--primary); }

        .d-tit-shadow { text-shadow: 0 0 20px rgba(0, 242, 255, 0.2); }
    </style>
</head>
<body>

    <audio id="sfx-boot" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>
    <audio id="sfx-ping" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <div id="view-boot">
        <div class="text-center" style="max-width: 320px;">
            <i data-lucide="cpu" size="64" class="text-primary mb-4" style="filter: drop-shadow(0 0 15px var(--primary))"></i>
            <h1 class="hud-text fw-bold fs-3 mb-2 text-white tracking-widest">TITAN OS</h1>
            <div id="boot-log" class="text-secondary hud-text small mb-5" style="min-height:20px;">SYSTEM CHECK...</div>
            <button onclick="bootSystem()" class="btn btn-outline-light w-100 py-3 rounded-pill hud-text fw-bold" style="border-color: #333">INITIATE UPLINK</button>
        </div>
    </div>

    <div id="view-auth" class="d-none">
        <div class="container text-center" style="max-width: 400px;">
            <div id="auth-list" class="row g-3"></div>
            
            <div id="auth-pin" class="d-none">
                <div id="l-av" class="display-1 mb-2"></div>
                <h3 id="l-name" class="fw-bold mb-1 text-white"></h3>
                <p class="text-secondary small hud-text mb-4">ENTER CREDENTIALS</p>
                <input type="password" id="inp-pin" class="form-control text-center fs-3 mb-4 py-3 hud-text" maxlength="11" placeholder="â€¢ â€¢ â€¢ â€¢">
                <button onclick="tryLogin()" class="btn btn-primary w-100 py-3 fw-bold hud-text">ACCESS DASHBOARD</button>
                <button onclick="resetAuth()" class="btn btn-link text-secondary mt-3 text-decoration-none">Back</button>
            </div>
        </div>
    </div>

    <div id="view-app" class="d-none">
        <div class="fixed-top glass-panel m-2" style="height:64px; z-index:1001; border-radius: 12px; border-bottom: 1px solid var(--border);">
            <div class="container-fluid h-100 d-flex align-items-center justify-content-between px-3">
                <div class="d-flex align-items-center gap-3">
                    <div id="d-av" class="bg-dark rounded-circle d-flex align-items-center justify-content-center border border-secondary" style="width:38px; height:38px; font-size: 18px;"></div>
                    <div class="lh-1">
                        <div id="d-role" class="hud-text text-primary" style="font-size: 0.6rem;">UNIT</div>
                        <div id="d-name" class="fw-bold text-sm text-white"></div>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <button onclick="checkNoti(true)" class="btn btn-icon position-relative text-secondary">
                        <i data-lucide="bell"></i>
                        <span id="bad-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger border border-dark d-none">0</span>
                    </button>
                    <button onclick="doLogout()" class="btn btn-sm text-secondary"><i data-lucide="log-out" size="18"></i></button>
                </div>
            </div>
        </div>

        <div class="container-fluid" style="margin-top: 80px; padding-bottom: 100px;">
            <div class="row">
                <div class="col-md-3 col-lg-2 d-none d-md-block position-fixed h-100 pt-4">
                    <div id="nav-d" class="d-flex flex-column gap-2"></div>
                </div>

                <div class="col-12 col-md-9 offset-md-3 col-lg-10 offset-lg-2 p-1 p-md-4">
                    <div class="d-flex justify-content-between align-items-end mb-4 px-2">
                        <div>
                            <div class="hud-text text-secondary" style="font-size: 0.7rem;">SYSTEM VIEW</div>
                            <h2 id="d-tit" class="fw-bold m-0 hud-text text-white tracking-tight d-tit-shadow">DASHBOARD</h2>
                        </div>
                        <button onclick="openCreate('task')" class="btn btn-primary rounded-circle shadow d-md-none" style="width:48px;height:48px;display:flex;align-items:center;justify-content:center"><i data-lucide="plus"></i></button>
                    </div>
                    
                    <div id="content-box"></div>
                </div>
            </div>
        </div>

        <div class="d-md-none fixed-bottom m-3 p-2 glass-panel d-flex justify-content-between align-items-center" style="border-radius: 16px; z-index: 1000; background: #111;">
            <div id="nav-m" class="d-flex w-100 justify-content-around"></div>
        </div>
    </div>

    <div class="modal fade" id="modCreate" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass-panel border-0">
                <div class="modal-body p-4">
                    <h5 class="hud-text fw-bold mb-3 text-white">NEW DIRECTIVE</h5>
                    
                    <div class="d-flex bg-black bg-opacity-50 p-1 rounded-3 mb-3 border border-secondary border-opacity-25">
                        <button onclick="setMode('task')" id="bm-task" class="flex-fill btn btn-sm text-white">TASK</button>
                        <button onclick="setMode('intel')" id="bm-intel" class="flex-fill btn btn-sm text-secondary">INTEL / WIRE</button>
                    </div>

                    <div id="form-core">
                        <input type="text" id="inp-t" class="form-control mb-3 fw-bold" placeholder="Subject / Title">
                        <textarea id="inp-d" class="form-control mb-3" rows="3" placeholder="Details or Message..."></textarea>
                        
                        <div id="sec-task-dets">
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label class="hud-text text-secondary" style="font-size:0.6rem">DEADLINE</label>
                                    <input type="date" id="inp-date" class="form-control">
                                </div>
                                <div class="col-6">
                                    <label class="hud-text text-secondary" style="font-size:0.6rem">PRIORITY</label>
                                    <select id="inp-prio" class="form-select form-control">
                                        <option value="Normal">Normal</option>
                                        <option value="High">High</option>
                                    </select>
                                </div>
                            </div>
                            <label class="hud-text text-secondary mb-2 d-block" style="font-size:0.6rem">ASSIGN OPERATIVES</label>
                            <div id="div-mems" class="d-flex flex-wrap gap-2 mb-3"></div>
                        </div>
                    </div>

                    <button onclick="saveItem()" id="btn-save" class="btn btn-primary w-100 py-3 rounded-pill hud-text">EXECUTE</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modSubmit" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass-panel border-0">
                <div class="modal-body p-4 text-center">
                    <h5 class="hud-text fw-bold mb-1">UPLOAD PROTOCOL</h5>
                    <p class="text-secondary small mb-4">Select Destination Drive</p>
                    <div class="row g-3 mb-4">
                        <div class="col-6"><div onclick="selSub('Admin')" id="sub-Admin" class="p-3 border rounded cursor-pointer"><i data-lucide="shield" class="text-warning mb-2"></i><div class="hud-text small">ADMIN</div></div></div>
                        <div class="col-6"><div onclick="selSub('Machine')" id="sub-Machine" class="p-3 border rounded cursor-pointer"><i data-lucide="cpu" class="text-info mb-2"></i><div class="hud-text small">MACHINE</div></div></div>
                        <div class="col-6"><div onclick="selSub('Pics')" id="sub-Pics" class="p-3 border rounded cursor-pointer"><i data-lucide="image" class="text-success mb-2"></i><div class="hud-text small">MEDIA</div></div></div>
                        <div class="col-6"><div onclick="selSub('PPT')" id="sub-PPT" class="p-3 border rounded cursor-pointer"><i data-lucide="presentation" class="text-danger mb-2"></i><div class="hud-text small">DECK</div></div></div>
                    </div>
                    <textarea id="sub-note" class="form-control mb-3" rows="2" placeholder="Sitrep (Optional)..."></textarea>
                    <button onclick="confirmSubmit()" class="btn btn-success w-100 py-3 rounded-pill hud-text">TRANSMIT</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modNoti" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass-panel border-0">
                <div class="modal-header border-bottom border-secondary border-opacity-25">
                    <h6 class="hud-text fw-bold m-0 text-white">COMMS LOG</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="noti-list" class="list-group list-group-flush"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 2000">
        <div id="sysToast" class="toast bg-dark text-white border border-secondary" role="alert">
            <div class="d-flex p-3 align-items-center">
                <div class="me-3 text-primary"><i id="t-ico" data-lucide="info"></i></div>
                <div><strong id="t-tit" class="d-block hud-text">SYSTEM</strong><small id="t-msg" class="text-secondary">Message</small></div>
            </div>
        </div>
    </div>

    <script>
    // --- WRAPPERS ---
    function safeText(id, txt) { const el = document.getElementById(id); if(el) el.innerText = txt; }
    function safeHtml(id, htm) { const el = document.getElementById(id); if(el) el.innerHTML = htm; }
    function safeClass(id, cls, act) { const el = document.getElementById(id); if(el) act === 'add' ? el.classList.add(cls) : el.classList.remove(cls); }
    function safeVal(id) { const el = document.getElementById(id); return el ? el.value : ''; }

    // --- CONFIG ---
    const SB_URL = 'https://bzrkbjjgymdbbwpatfct.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6cmtiampneW1kYmJ3cGF0ZmN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTcyNjcsImV4cCI6MjA4NTg3MzI2N30.Icv1daEp7NophE_ktPl2G1EgDP6awo0tyV14yh3Q4Sw';
    let sbClient = null;

    const TEAM = [
        { id: 1, name: "Pema Ugyen", av: "ðŸ‘¨â€ðŸ’¼", pin: "11107008201", role: "LEADER" },
        { id: 2, name: "Jamphel",    av: "ðŸ‘¨â€ðŸ’»", pin: "11302003634", role: "MEMBER" },
        { id: 3, name: "Laxmi",      av: "ðŸ‘¨â€ðŸ”¬", pin: "11103002151", role: "MEMBER" },
        { id: 4, name: "Ngawang",    av: "ðŸ‘¨",   pin: "10801003243", role: "MEMBER" }
    ];

    const DRIVE = {
        'Admin': 'https://drive.google.com/drive/folders/1VskzY_IgfF6lagiEdaF5-yy6Te_u-MMG?usp=sharing',
        'Machine': 'https://drive.google.com/drive/folders/1FivXbl7Qo5qnKV2Kn6DXxdtVUS4nB5CF?usp=sharing',
        'Pics': 'https://drive.google.com/drive/folders/11Q6gWSLqU4H88DrmWA_Fmbkx8dsNs0Ka?usp=sharing',
        'PPT': 'https://drive.google.com/drive/folders/1IBpIa7nH43g1UVMYkFOwLA6iEFVvuv7y?usp=sharing'
    };

    let STATE = { user: null, page: 'home', mode: 'task', subCat: null, subTid: null, lastNoti: 0 };
    const MODALS = {};

    // --- INIT ---
    window.onload = function() {
        lucide.createIcons();
        sbClient = window.supabase.createClient(SB_URL, SB_KEY);
        ['modCreate','modNoti','modSubmit'].forEach(id => MODALS[id] = new bootstrap.Modal(document.getElementById(id)));
        
        const uid = localStorage.getItem('slbd_uid');
        if(uid) {
            safeClass('view-boot', 'd-none', 'add');
            login(TEAM.find(x => x.id == uid));
        } else {
            typeWriter('boot-log', 'ESTABLISHING SECURE CONNECTION...', 0);
        }
    };

    function typeWriter(id, text, i) {
        if (i < text.length) {
            document.getElementById(id).innerHTML += text.charAt(i);
            setTimeout(() => typeWriter(id, text, i + 1), 30);
        }
    }

    function bootSystem() {
        document.getElementById('sfx-boot').play().catch(()=>{});
        safeClass('view-boot', 'd-none', 'add');
        initAuth();
    }

    // --- AUTHENTICATION ---
    function initAuth() {
        safeClass('view-auth', 'd-none', 'remove');
        safeHtml('auth-list', TEAM.map(u => `
            <div class="col-6"><div onclick="preLogin(${u.id})" class="glass-panel p-3 cursor-pointer h-100 d-flex flex-column align-items-center justify-content-center hover-glow">
                <div class="fs-1 mb-2">${u.av}</div><div class="fw-bold small hud-text">${u.name.split(' ')[0]}</div>
            </div></div>`).join(''));
    }

    function preLogin(id) {
        STATE.sel = TEAM.find(u=>u.id===id);
        safeClass('auth-list', 'd-none', 'add');
        safeClass('auth-pin', 'd-none', 'remove');
        safeText('l-av', STATE.sel.av);
        safeText('l-name', STATE.sel.name);
    }

    function resetAuth() {
        safeClass('auth-pin', 'd-none', 'add');
        safeClass('auth-list', 'd-none', 'remove');
        document.getElementById('inp-pin').value = '';
    }

    function tryLogin() {
        if(safeVal('inp-pin') === STATE.sel.pin) {
            localStorage.setItem('slbd_uid', STATE.sel.id);
            safeClass('view-auth', 'd-none', 'add');
            login(STATE.sel);
        } else {
            toast('ALERT', 'ACCESS DENIED', 'lock', 'text-danger');
        }
    }

    function login(u) {
        if(!u) return initAuth();
        STATE.user = u;
        safeClass('view-app', 'd-none', 'remove');
        safeText('d-av', u.av);
        safeText('d-name', u.name);
        safeText('d-role', u.role);
        
        const navs = [
            {id:'home', t:'Dash', i:'layout-dashboard'},
            {id:'cal', t:'Schedule', i:'calendar'},
            {id:'task', t:'Ops', i:'crosshair'},
            {id:'intel', t:'The Wire', i:'radio'},
            {id:'rec', t:'Files', i:'database'}
        ];
        
        safeHtml('nav-d', navs.map(p => `<button onclick="nav('${p.id}')" id="nd-${p.id}" class="btn text-start text-secondary w-100 mb-2 d-flex align-items-center gap-3 py-3"><i data-lucide="${p.i}" size="20"></i><span class="hud-text small">${p.t}</span></button>`).join(''));
        safeHtml('nav-m', navs.map(p => `<div onclick="nav('${p.id}')" id="nm-${p.id}" class="nav-item cursor-pointer text-center"><i data-lucide="${p.i}"></i></div>`).join(''));
        
        nav('home');
        setInterval(() => { if(STATE.page!=='rec') render(true); checkNoti(false); }, 5000);
        checkNoti(false);
    }

    function doLogout() {
        localStorage.removeItem('slbd_uid');
        location.reload();
    }

    // --- NAVIGATION ---
    function nav(p) {
        STATE.page = p;
        document.querySelectorAll('[id^="nd-"]').forEach(e => { e.classList.remove('btn-primary','text-black'); e.classList.add('text-secondary'); });
        const nd = document.getElementById(`nd-${p}`);
        if(nd) { nd.classList.add('btn-primary','text-black'); nd.classList.remove('text-secondary'); }
        
        document.querySelectorAll('[id^="nm-"]').forEach(e => e.classList.remove('nav-active'));
        const nm = document.getElementById(`nm-${p}`);
        if(nm) nm.classList.add('nav-active');
        
        const titles = { home: 'COMMAND CENTER', cal: 'TACTICAL SCHEDULE', task: 'ACTIVE OPERATIONS', intel: 'INTELLIGENCE WIRE', rec: 'ARCHIVES' };
        safeText('d-tit', titles[p]);
        render(false);
    }

    // --- RENDER ENGINE ---
    async function render(silent) {
        if(!silent) safeHtml('content-box', '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>');

        try {
            // Fetch All Active Tasks
            const { data: tasks, error } = await sbClient.from('tasks').select('*').order('created_at',{ascending:false});
            if(error) throw error;
            
            let html = '';

            // 1. DASHBOARD + MOMENTUM GRAPH
            if(STATE.page === 'home') {
                // Generate Momentum Bars
                let graphHtml = '';
                TEAM.forEach(u => {
                    const uTasks = tasks.filter(t => (t.tagged_members||[]).includes(u.id));
                    const total = uTasks.length;
                    const done = uTasks.filter(t => t.status==='Done').length;
                    const pct = total === 0 ? 0 : Math.round((done/total)*100);
                    
                    graphHtml += `
                    <div class="graph-col">
                        <div class="graph-bar-bg">
                            <div class="graph-bar-fill" style="height:${pct}%"></div>
                        </div>
                        <div class="graph-val">${pct}%</div>
                        <div class="graph-name">${u.name.split(' ')[0]}</div>
                    </div>`;
                });

                const drives = Object.keys(DRIVE).map(k=>`<div class="col-6 col-md-3"><a href="${DRIVE[k]}" target="_blank" class="text-decoration-none"><div class="glass-panel p-3 text-center hover-glow"><i data-lucide="folder" class="mb-2 text-primary"></i><div class="hud-text small text-white">${k}</div></div></a></div>`).join('');
                const myPending = tasks.filter(t => t.status!=='Done' && (t.tagged_members||[]).includes(STATE.user.id)).slice(0,3);
                
                html = `
                    <div class="glass-panel p-4 mb-4">
                        <h6 class="hud-text text-secondary mb-3">TEAM MOMENTUM (COMPLETION RATE)</h6>
                        <div class="graph-wrap">${graphHtml}</div>
                    </div>
                    <div class="row g-3 mb-4">${drives}</div>
                    <h6 class="hud-text text-secondary mb-3">IMMEDIATE ACTION ITEMS</h6>
                    ${myPending.map(t => `<div class="glass-panel p-3 mb-2 d-flex justify-content-between align-items-center border-start border-4 border-warning"><div><div class="fw-bold small text-white">${t.task_title}</div><div class="text-secondary small" style="font-size:0.7rem">${t.status}</div></div><button onclick="nav('task')" class="btn btn-sm btn-outline-light"><i data-lucide="chevron-right" size="14"></i></button></div>`).join('') || '<div class="text-secondary small fst-italic">All clear, commander.</div>'}
                `;
            }

            // 2. GOOGLE-STYLE CALENDAR
            if(STATE.page === 'cal') {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDayIdx = new Date(year, month, 1).getDay(); // 0=Sun

                let daysHtml = '';
                // Empty slots for start of month
                for(let i=0; i<firstDayIdx; i++) daysHtml += `<div class="cal-day" style="background:rgba(0,0,0,0.5)"></div>`;
                
                // Actual Days
                for(let d=1; d<=daysInMonth; d++) {
                    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const isToday = d === now.getDate();
                    const dayTasks = tasks.filter(t => t.due_date === dateStr);
                    
                    daysHtml += `
                    <div class="cal-day ${isToday?'cal-today':''}" onclick="openCreateDate('${dateStr}')">
                        <div class="cal-date-num">${d}</div>
                        <div>
                            ${dayTasks.map(t => `<div class="cal-task status-${t.status}">${t.task_title}</div>`).join('')}
                        </div>
                    </div>`;
                }

                html = `
                    <div class="cal-wrapper">
                        <div class="d-flex justify-content-between px-3 py-3 align-items-center bg-black bg-opacity-25">
                            <span class="fw-bold text-white fs-5 font-mono">${now.toLocaleString('default',{month:'long'}).toUpperCase()} ${year}</span>
                            <button onclick="openCreate('task')" class="btn btn-sm btn-primary">+ ADD EVENT</button>
                        </div>
                        <div class="cal-header-row">
                            ${['SUN','MON','TUE','WED','THU','FRI','SAT'].map(h=>`<div class="cal-header-cell">${h}</div>`).join('')}
                        </div>
                        <div class="cal-grid">
                            ${daysHtml}
                        </div>
                    </div>
                `;
            }

            // 3. TASKS
            if(STATE.page === 'task') {
                const active = tasks.filter(t => t.status !== 'Done');
                html = `<div class="row g-3">${active.map(t => {
                    let btn = '';
                    if(STATE.user.role==='LEADER') {
                        if(t.status==='ApprovalReq') btn = `<button onclick="setStatus(${t.id},'Pending',${t.creator_id},'${t.task_title}')" class="btn btn-warning w-100 btn-sm mt-3 fw-bold text-dark">AUTHORIZE</button>`;
                        else if(t.status==='Review') btn = `<div class="d-flex gap-2 mt-3"><button onclick="setStatus(${t.id},'Pending',${t.creator_id},'${t.task_title}')" class="btn btn-outline-danger btn-sm flex-fill">REJECT</button><button onclick="setStatus(${t.id},'Done',${t.creator_id},'${t.task_title}')" class="btn btn-success btn-sm flex-fill">APPROVE</button></div>`;
                        else btn = `<button onclick="setStatus(${t.id},'Done',${t.creator_id},'${t.task_title}')" class="btn btn-outline-secondary w-100 btn-sm mt-3">CLOSE TICKET</button>`;
                    } else {
                        if(t.status!=='Done' && t.status!=='Review') btn = `<button onclick="openSubmit(${t.id},'${t.task_title}')" class="btn btn-primary w-100 btn-sm mt-3">SUBMIT REPORT</button>`;
                        else if(t.status==='Review') btn = `<div class="btn btn-dark w-100 btn-sm mt-3 text-secondary border border-secondary border-opacity-25">UNDER REVIEW</div>`;
                    }
                    return `<div class="col-12 col-md-6"><div class="glass-panel p-4 h-100 d-flex flex-column"><div class="d-flex justify-content-between mb-3"><span class="badge bg-dark border border-secondary text-secondary hud-text">${t.status.toUpperCase()}</span><span class="small fw-bold text-primary hud-text">${t.progress||0}%</span></div><h5 class="fw-bold mb-2">${t.task_title}</h5><p class="small text-secondary text-truncate flex-fill">${t.description}</p>${btn}</div></div>`;
                }).join('')}</div>`;
            }

            // 4. THE WIRE (Chat/Intel)
            if(STATE.page === 'intel') {
                 // Using 'decisions' table for chat logic
                 const {data:msgs} = await sbClient.from('decisions').select('*').order('created_at',{ascending:false});
                 html = `<div class="glass-panel p-3" style="min-height: 60vh;">
                    <div class="d-grid mb-3">
                        <button onclick="setMode('intel'); MODALS.modCreate.show()" class="btn btn-outline-primary dashed-border py-3">
                            <i data-lucide="radio" class="me-2"></i>BROADCAST TO WIRE
                        </button>
                    </div>
                    ${msgs.map(m => {
                        // Guess type based on subject content or role (Logic simplification for single table)
                        const isLeader = m.subject.includes('LEADER');
                        return `<div class="wire-msg ${isLeader?'type-leader':'type-intel'}">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="fw-bold text-white small font-mono">${m.subject}</span>
                                <span class="text-secondary" style="font-size:0.6rem">${new Date(m.created_at).toLocaleTimeString()}</span>
                            </div>
                            <div class="text-light small opacity-75">${m.details}</div>
                        </div>`
                    }).join('')}
                 </div>`;
            }

            // 5. ARCHIVES
            if(STATE.page === 'rec') {
                const {data:dones} = await sbClient.from('tasks').select('*').eq('status','Done').order('updated_at',{ascending:false});
                html = `<div class="glass-panel overflow-hidden"><table class="table table-dark table-hover mb-0"><thead><tr><th class="bg-black text-secondary hud-text small">MISSION</th><th class="bg-black text-secondary hud-text small text-end">DATE</th></tr></thead><tbody>${dones.map(t=>`<tr><td class="p-3 fw-bold">${t.task_title}</td><td class="p-3 text-end text-secondary small hud-text">${new Date(t.updated_at).toLocaleDateString()}</td></tr>`).join('')}</tbody></table></div>`;
            }

            safeHtml('content-box', html);

        } catch(e) { console.error(e); if(!silent) safeHtml('content-box', `<div class="alert alert-danger">CONNECTION LOST: ${e.message}</div>`); }
        lucide.createIcons();
    }

    // --- INTERACTION LOGIC ---
    function setMode(m) { 
        STATE.mode = m; 
        ['task','intel'].forEach(k => {
            const el = document.getElementById('bm-'+k);
            if(el) {
                el.classList.toggle('btn-light', k===m);
                el.classList.toggle('text-dark', k===m);
                el.classList.toggle('text-secondary', k!==m);
            }
        });
        const sec = document.getElementById('sec-task-dets');
        if(sec) sec.classList.toggle('d-none', m==='intel');
        
        if(m==='task') safeHtml('div-mems', TEAM.map(u=>`<input type="checkbox" class="btn-check chk-mem" id="btn-check-${u.id}" value="${u.id}"><label class="btn btn-outline-secondary btn-sm rounded-pill hud-text" for="btn-check-${u.id}">${u.name.split(' ')[0]}</label>`).join(''));
    }

    function openCreate(mode) { setMode(mode); MODALS.modCreate.show(); }
    function openCreateDate(date) { 
        setMode('task'); 
        document.getElementById('inp-date').value = date; 
        MODALS.modCreate.show(); 
    }

    async function saveItem() {
        const btn = document.getElementById('btn-save'); btn.innerText = 'PROCESSING...';
        try {
            const t = safeVal('inp-t');
            if(!t) throw new Error("SUBJECT REQUIRED");
            
            if(STATE.mode==='intel') {
                // Save to Decisions table as a log
                await sbClient.from('decisions').insert({
                    subject: `${STATE.user.name} [${STATE.user.role}]`, 
                    details: t + ' - ' + safeVal('inp-d')
                });
                toast('SENT', 'Intel Broadcasted to Wire', 'radio', 'text-success');
            } else {
                const tags = [...document.querySelectorAll('.chk-mem:checked')].map(x=>parseInt(x.value));
                await sbClient.from('tasks').insert({
                    task_title: t, description: safeVal('inp-d'), 
                    due_date: safeVal('inp-date')||null, creator_id: STATE.user.id, 
                    tagged_members: tags, status: STATE.user.role==='LEADER'?'Pending':'ApprovalReq', progress: 0
                });
                tags.forEach(id => sendNoti(id, `New Order: ${t}`));
            }
            MODALS.modCreate.hide(); render(false);
            document.getElementById('inp-t').value=''; document.getElementById('inp-d').value='';
        } catch(e) { toast('ERROR',e.message,'alert-triangle','text-danger'); }
        btn.innerText = 'EXECUTE';
    }

    // --- FILE SUBMISSION ---
    function openSubmit(id, title) {
        STATE.subTid = id; STATE.subTit = title; STATE.subCat = null;
        MODALS.modSubmit.show();
    }
    function selSub(cat) {
        STATE.subCat = cat;
        document.querySelectorAll('[id^="sub-"]').forEach(el => el.classList.remove('border-primary', 'bg-dark'));
        document.getElementById('sub-'+cat).classList.add('border-primary', 'bg-dark');
        if(DRIVE[cat]) window.open(DRIVE[cat], '_blank');
    }
    async function confirmSubmit() {
        if(!STATE.subCat) return toast('HALT', 'Select Drive', 'x', 'text-danger');
        await sbClient.from('tasks').update({status:'Review', updated_at:new Date()}).eq('id',STATE.subTid);
        const note = safeVal('sub-note');
        await sendNoti(1, `Review: ${STATE.subTit} [${STATE.subCat}] ${note}`);
        MODALS.modSubmit.hide(); render(false); toast('SENT', 'Uploaded', 'send', 'text-success');
    }

    // --- UTILITIES ---
    async function setStatus(id,s,uid,tit) { await sbClient.from('tasks').update({status:s, updated_at:new Date()}).eq('id',id); render(true); if(s==='Pending') sendNoti(uid,`Authorized: ${tit}`); }
    async function sendNoti(uid, msg) { await sbClient.from('notifications').insert({user_id:uid, message:msg}); }
    
    async function checkNoti(open) {
        if(!STATE.user) return;
        const {data} = await sbClient.from('notifications').select('*').eq('user_id',STATE.user.id).eq('is_read',false).order('created_at',{ascending:false});
        const count = data?.length || 0;
        const badge = document.getElementById('bad-count');
        if(badge) {
            if(count>0) { badge.innerText = count; badge.classList.remove('d-none'); } 
            else badge.classList.add('d-none');
        }
        if(count > 0 && new Date(data[0].created_at).getTime() > STATE.lastNoti) {
             document.getElementById('sfx-ping').play().catch(()=>{});
             STATE.lastNoti = new Date(data[0].created_at).getTime();
        }
        if(open) {
            const {data:msgs} = await sbClient.from('notifications').select('*').eq('user_id',STATE.user.id).order('created_at',{ascending:false}).limit(10);
            safeHtml('noti-list', msgs.map(n => `<div class="list-group-item bg-dark border-secondary p-3"><div class="fw-bold small text-white hud-text">> ${n.message}</div></div>`).join(''));
            if(count>0) await sbClient.from('notifications').update({is_read:true}).eq('user_id',STATE.user.id);
            MODALS.modNoti.show();
        }
    }

    function toast(t,m,i,c) {
        safeText('t-tit', t); safeText('t-msg', m);
        const ico = document.getElementById('t-ico');
        if(ico) { ico.setAttribute('data-lucide', i); ico.className = c; }
        lucide.createIcons();
        bootstrap.Toast.getOrCreateInstance(document.getElementById('sysToast')).show();
    }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
