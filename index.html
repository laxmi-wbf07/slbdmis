<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLBDMIS - Complete System</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- THEME --- */
        :root {
            --bg: #0F172A;
            --card: #1E293B;
            --hover: #334155;
            --primary: #3B82F6;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --text: #F8FAFC;
            --muted: #94A3B8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', system-ui, sans-serif; }
        
        body { background-color: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .grid { display: grid; }
        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }
        .text-sm { font-size: 0.875rem; }
        .text-muted { color: var(--muted); }
        .p-4 { padding: 1rem; }
        .w-full { width: 100%; }
        
        /* --- COMPONENTS --- */
        .card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .card:hover { border-color: rgba(255,255,255,0.1); }

        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex; align-items: center; gap: 0.5rem; justify-content: center;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-ghost { background: transparent; color: var(--muted); border: 1px solid var(--hover); }
        .btn:hover { filter: brightness(110%); transform: translateY(-1px); }

        input, select, textarea {
            background: var(--hover);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 0.8rem;
            border-radius: 0.5rem;
            width: 100%;
            outline: none;
            margin-bottom: 1rem;
        }

        /* --- LAYOUT --- */
        .sidebar {
            width: 260px; background: var(--card); height: 100vh; position: fixed;
            padding: 1.5rem; display: flex; flex-direction: column;
            border-right: 1px solid rgba(255,255,255,0.05); z-index: 50;
        }
        
        .main-content {
            margin-left: 260px; padding: 2rem; width: calc(100% - 260px);
            min-height: 100vh;
        }

        .nav-item {
            padding: 1rem; margin-bottom: 0.5rem; border-radius: 0.5rem;
            color: var(--muted); cursor: pointer; display: flex; align-items: center; gap: 10px;
        }
        .nav-item.active, .nav-item:hover { background: var(--primary); color: white; }

        .tag-checkbox {
            display: flex; align-items: center; gap: 10px; padding: 10px;
            background: var(--hover); border-radius: 6px; margin-bottom: 6px; cursor: pointer;
            transition: background 0.2s;
        }
        .tag-checkbox:hover { background: rgba(255,255,255,0.1); }
        .tag-checkbox input { width: auto; margin: 0; }

        .loader-overlay {
            position: fixed; inset: 0; background: var(--bg); z-index: 200;
            display: flex; align-items: center; justify-content: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid var(--hover);
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; width: 100%; padding: 1rem; padding-bottom: 80px; }
            .mobile-nav { 
                display: flex; position: fixed; bottom: 0; left: 0; right: 0;
                background: var(--card); padding: 10px; justify-content: space-around;
                border-top: 1px solid rgba(255,255,255,0.1); z-index: 50;
            }
        }

        .avatar-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; }
        .avatar-card { padding: 1.5rem; border-radius: 1rem; cursor: pointer; background: var(--card); border: 2px solid transparent; text-align: center; }
        .avatar-card.selected { border-color: var(--primary); background: rgba(59, 130, 246, 0.1); }
    </style>
</head>
<body>

    <div id="app-loader" class="loader-overlay">
        <div class="spinner"></div>
    </div>

    <div id="login-view" class="flex hidden" style="height: 100vh; align-items: center; justify-content: center; background: radial-gradient(circle, #1E293B 0%, #0F172A 100%);">
        <div class="card p-4" style="width: 90%; max-width: 800px;">
            <div class="text-center" style="margin-bottom: 2rem;">
                <h1 style="font-size: 2.5rem; font-weight: 800;">SLBDMIS</h1>
                <p class="text-muted">Lead-Filter Pro Tracking System</p>
            </div>
            
            <div id="avatar-container" class="avatar-grid"></div>

            <div id="auth-box" class="hidden text-center" style="margin-top: 2rem;">
                <input type="password" id="cid-input" placeholder="Enter CID" style="max-width: 300px; text-align: center;">
                <p id="login-err" style="color: var(--danger); min-height: 20px;"></p>
                <button onclick="login()" class="btn btn-primary" style="width: 100%; max-width: 300px;">Login</button>
            </div>
        </div>
    </div>

    <div id="dashboard-view" class="hidden">
        <nav class="sidebar">
            <div class="flex" style="align-items: center; gap: 10px; margin-bottom: 2rem;">
                <div style="background: var(--primary); padding: 8px; border-radius: 6px;"><i data-lucide="layout-grid"></i></div>
                <div class="font-bold">SLBDMIS <span class="text-muted text-sm">v3.2</span></div>
            </div>
            <div id="sidebar-links"></div>
            <div style="margin-top: auto;" class="nav-item" onclick="handleLogout()"><i data-lucide="log-out"></i> Logout</div>
        </nav>

        <main class="main-content">
            <header class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h2 id="page-title" class="font-bold" style="font-size: 1.5rem;">Overview</h2>
                    <p class="text-muted text-sm">Welcome, <span id="user-display">User</span></p>
                </div>
                <div class="flex" style="gap: 10px;">
                    <button onclick="openCreateModal()" class="btn btn-primary"><i data-lucide="plus"></i> New Item</button>
                    <button onclick="renderPage(STATE.page)" class="btn btn-ghost"><i data-lucide="refresh-cw"></i></button>
                </div>
            </header>
            <div id="content-area"></div>
        </main>

        <nav id="mobile-nav" class="mobile-nav hidden"></nav>
    </div>

    <div id="create-modal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: flex; align-items: center; justify-content: center;">
        <div class="card p-4" style="width: 90%; max-width: 500px;">
            <h3 class="font-bold text-lg mb-4 text-center">Create New</h3>
            
            <div class="flex" style="gap: 10px; margin-bottom: 1rem; justify-content: center;">
                <button onclick="setCreateMode('task')" id="btn-mode-task" class="btn btn-primary">Task</button>
                <button onclick="setCreateMode('decision')" id="btn-mode-decision" class="btn btn-ghost">Decision</button>
                <button onclick="setCreateMode('opp')" id="btn-mode-opp" class="btn btn-ghost">Opportunity</button>
            </div>

            <input id="create-title" placeholder="Title / Subject">
            <textarea id="create-desc" placeholder="Description / Details..." rows="3"></textarea>
            
            <div id="task-fields">
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px;">
                    <select id="create-priority">
                        <option value="Normal">Normal</option>
                        <option value="High">High</option>
                        <option value="Urgent">Urgent</option>
                    </select>
                    <input type="date" id="create-date">
                </div>
            </div>

            <div id="opp-fields" class="hidden">
                <label class="text-sm text-muted mb-2 block">Tag Members:</label>
                <div id="tag-list" style="max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px;"></div>
            </div>

            <div class="flex" style="gap: 10px; margin-top: 1rem;">
                <button onclick="submitCreate()" class="btn btn-success w-full">Submit</button>
                <button onclick="closeModal('create-modal')" class="btn btn-ghost w-full">Cancel</button>
            </div>
        </div>
    </div>

    <div id="approve-modal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: flex; align-items: center; justify-content: center;">
        <div class="card p-4" style="width: 90%; max-width: 400px;">
            <h3 class="font-bold mb-4">Assign Task</h3>
            <input type="hidden" id="approve-id">
            <label class="text-muted text-sm">Assign To:</label>
            <select id="assign-select"></select>
            <button onclick="confirmAssign()" class="btn btn-success w-full" style="margin-top: 1rem;">Confirm Assignment</button>
            <button onclick="closeModal('approve-modal')" class="btn btn-ghost w-full" style="margin-top: 0.5rem;">Cancel</button>
        </div>
    </div>

    <script>
        // CONFIG
        const SB_URL = 'https://bzrkbjjgymdbbwpatfct.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6cmtiampneW1kYmJ3cGF0ZmN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTcyNjcsImV4cCI6MjA4NTg3MzI2N30.Icv1daEp7NophE_ktPl2G1EgDP6awo0tyV14yh3Q4Sw';
        
        // FIXED: Renamed variable to avoid "already declared" error
        const sbClient = window.supabase.createClient(SB_URL, SB_KEY);

        const TEAM = [
            { id: 1, name: "Pema Ugyen", avatar: "üë®‚Äçüíº", cid: "11107008201", role: "LEADER" },
            { id: 2, name: "Jamphel", avatar: "üë®‚Äçüíª", cid: "11302003634", role: "MEMBER" },
            { id: 3, name: "Kuenley", avatar: "üë©‚Äçüíª", cid: "11006001849", role: "MEMBER" },
            { id: 4, name: "Laxmi", avatar: "üë®‚Äçüîß", cid: "11103002151", role: "MEMBER" },
            { id: 5, name: "Ngawang", avatar: "üë®‚Äçüéì", cid: "10801003243", role: "MEMBER" }
        ];

        const STATE = { user: null, page: 'overview', createMode: 'task', selectedAvatar: null };

        // INIT & SESSION CHECK
        window.onload = () => {
            lucide.createIcons();
            const savedId = localStorage.getItem('slbd_uid');
            if (savedId) {
                const user = TEAM.find(u => u.id === parseInt(savedId));
                if (user) { STATE.user = user; initApp(); return; }
            }
            renderLoginView();
        };

        function renderLoginView() {
            document.getElementById('app-loader').classList.add('hidden');
            document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('avatar-container').innerHTML = TEAM.map(u => `
                <div class="avatar-card" onclick="selectAvatar(${u.id}, this)">
                    <div style="font-size: 2.5rem;">${u.avatar}</div>
                    <div class="font-bold text-sm mt-2">${u.name}</div>
                    <div class="text-xs text-muted">${u.role}</div>
                </div>
            `).join('');
        }

        function selectAvatar(id, el) {
            document.querySelectorAll('.avatar-card').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            STATE.selectedAvatar = TEAM.find(u => u.id === id);
            document.getElementById('auth-box').classList.remove('hidden');
            document.getElementById('cid-input').value = '';
            document.getElementById('cid-input').focus();
        }

        function login() {
            if (document.getElementById('cid-input').value === STATE.selectedAvatar.cid) {
                STATE.user = STATE.selectedAvatar;
                localStorage.setItem('slbd_uid', STATE.user.id);
                initApp();
            } else {
                document.getElementById('login-err').innerText = "‚ùå Invalid CID";
            }
        }

        function handleLogout() {
            localStorage.removeItem('slbd_uid');
            location.reload();
        }

        function initApp() {
            document.getElementById('app-loader').classList.add('hidden');
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
            document.getElementById('user-display').innerText = STATE.user.name;
            
            const links = [
                { id: 'overview', icon: 'layout-dashboard', label: 'Overview' },
                { id: 'tasks', icon: 'check-square', label: 'Tasks' },
                { id: 'attendance', icon: 'calendar', label: 'Attendance' },
                { id: 'decisions', icon: 'file-text', label: 'Decisions' },
                { id: 'opportunities', icon: 'zap', label: 'Opportunities' }
            ];
            
            if(STATE.user.role === 'LEADER') links.push({ id: 'team', icon: 'bar-chart', label: 'Team' });

            const renderNav = (target) => {
                document.getElementById(target).innerHTML = links.map(l => `
                    <div class="nav-item" id="nav-${l.id}" onclick="setPage('${l.id}')">
                        <i data-lucide="${l.icon}"></i> <span>${l.label}</span>
                    </div>
                `).join('');
            };

            renderNav('sidebar-links');
            renderNav('mobile-nav');
            setPage('overview');
        }

        function setPage(page) {
            STATE.page = page;
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.querySelectorAll(`#nav-${page}`).forEach(e => e.classList.add('active'));
            document.getElementById('page-title').innerText = page.charAt(0).toUpperCase() + page.slice(1);
            renderPage(page);
        }

        async function renderPage(page) {
            const content = document.getElementById('content-area');
            content.innerHTML = '<div class="text-center p-10 text-muted"><div class="spinner" style="margin: 0 auto;"></div><br>Loading...</div>';
            
            try {
                if(page === 'overview') await renderOverview(content);
                else if(page === 'tasks') await renderTasks(content);
                else if(page === 'attendance') await renderAttendance(content);
                else if(page === 'decisions') await renderDecisions(content);
                else if(page === 'opportunities') await renderOpportunities(content);
                else if(page === 'team') await renderTeam(content);
                lucide.createIcons();
            } catch(e) {
                content.innerHTML = `<div class="text-danger">Error: ${e.message}</div>`;
            }
        }

        // --- FEATURE RENDERERS ---
        async function renderOverview(container) {
            const { data: tasks } = await sbClient.from('tasks').select('*');
            const myTasks = STATE.user.role === 'MEMBER' ? tasks.filter(t => t.assignee_id === STATE.user.id) : tasks;
            const waiting = tasks.filter(t => t.status === 'Waiting').length;
            
            container.innerHTML = `
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div class="card p-4">
                        <div class="text-muted text-sm">Active Tasks</div>
                        <div class="font-bold text-2xl text-primary">${myTasks.filter(t => t.status === 'Ongoing').length}</div>
                    </div>
                    <div class="card p-4">
                        <div class="text-muted text-sm">Pending Approval</div>
                        <div class="font-bold text-2xl text-warning">${waiting}</div>
                    </div>
                    <div class="card p-4">
                        <div class="text-muted text-sm">Completed</div>
                        <div class="font-bold text-2xl text-success">${myTasks.filter(t => t.status === 'Done').length}</div>
                    </div>
                </div>
                <div class="card p-4" style="height: 300px;">
                    <canvas id="mainChart"></canvas>
                </div>
            `;
            
            new Chart(document.getElementById('mainChart'), {
                type: 'bar',
                data: {
                    labels: ['Done', 'Ongoing', 'Waiting'],
                    datasets: [{ label: 'Tasks', data: [
                        tasks.filter(t => t.status === 'Done').length,
                        tasks.filter(t => t.status === 'Ongoing').length,
                        tasks.filter(t => t.status === 'Waiting').length
                    ], backgroundColor: ['#10B981', '#3B82F6', '#F59E0B'] }]
                },
                options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        async function renderTasks(container) {
            let query = sbClient.from('tasks').select('*, users!assignee_id(name)').order('created_at', {ascending: false});
            if(STATE.user.role === 'MEMBER') query = query.or(`assignee_id.eq.${STATE.user.id},creator_id.eq.${STATE.user.id}`);
            const { data: tasks } = await query;

            if(!tasks.length) return container.innerHTML = '<div class="text-center text-muted">No tasks found. Create one!</div>';

            container.innerHTML = tasks.map(t => `
                <div class="card p-4 mb-4">
                    <div class="flex" style="justify-content: space-between; margin-bottom: 0.5rem;">
                        <h4 class="font-bold">${t.task_title}</h4>
                        <div class="flex gap-2">
                            <span class="badge" style="background: rgba(59, 130, 246, 0.2); color: #3B82F6; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem;">${t.priority}</span>
                            <span class="badge" style="background: rgba(255, 255, 255, 0.1); padding: 2px 8px; border-radius: 10px; font-size: 0.7rem;">${t.status}</span>
                        </div>
                    </div>
                    <p class="text-sm text-muted mb-2">${t.description || 'No description'}</p>
                    <div class="text-xs text-muted">Assigned: ${t.users ? t.users.name : 'Unassigned'} ‚Ä¢ Due: ${t.due_date}</div>
                    
                    <div class="flex gap-2 mt-3">
                        ${t.status === 'Ongoing' && (t.assignee_id === STATE.user.id || STATE.user.role === 'LEADER') ? 
                            `<button onclick="updateStatus('${t.id}', 'Done')" class="btn btn-success btn-sm">Mark Done</button>` : ''}
                        ${t.status === 'Waiting' && STATE.user.role === 'LEADER' ? 
                            `<button onclick="openApprove('${t.id}')" class="btn btn-primary btn-sm">Approve</button>` : ''}
                        ${STATE.user.role === 'LEADER' || t.creator_id === STATE.user.id ? 
                            `<button onclick="deleteItem('tasks', '${t.id}')" class="btn btn-danger btn-sm">Delete</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function renderDecisions(container) {
            const { data: items } = await sbClient.from('decisions').select('*, users!proposed_by(name)').order('created_at', {ascending: false});
            if(!items.length) return container.innerHTML = '<div class="text-center text-muted">No decisions proposed yet.</div>';

            container.innerHTML = items.map(d => `
                <div class="card p-4 mb-4">
                    <div class="flex" style="justify-content: space-between;">
                        <h4 class="font-bold">${d.subject}</h4>
                        ${d.is_verified ? '<span class="text-success text-sm font-bold">Verified ‚úÖ</span>' : '<span class="text-warning text-sm">Pending ‚è≥</span>'}
                    </div>
                    <p class="text-sm text-muted mt-2">${d.details}</p>
                    <div class="text-xs text-muted mt-2">Proposed by: ${d.users.name}</div>
                    <div class="flex gap-2 mt-3">
                        ${!d.is_verified && STATE.user.role === 'LEADER' ? 
                            `<button onclick="verifyDecision('${d.id}')" class="btn btn-success btn-sm">Verify</button>` : ''}
                        ${STATE.user.role === 'LEADER' || d.proposed_by === STATE.user.id ? 
                            `<button onclick="deleteItem('decisions', '${d.id}')" class="btn btn-danger btn-sm">Delete</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function renderOpportunities(container) {
            const { data: items } = await sbClient.from('opportunities').select('*, users!posted_by(name)').order('created_at', {ascending: false});
            if(!items.length) return container.innerHTML = '<div class="text-center text-muted">No opportunities yet.</div>';

            container.innerHTML = items.map(o => `
                <div class="card p-4 mb-4">
                    <h4 class="font-bold">${o.title}</h4>
                    <p class="text-sm text-muted mt-1">${o.description || ''}</p>
                    
                    <div class="flex gap-2 mt-3 flex-wrap">
                        <span class="text-xs text-muted">Tagged:</span>
                        ${o.tagged_members && o.tagged_members.length > 0 ? o.tagged_members.map(mid => {
                            const u = TEAM.find(x => x.id === mid);
                            return `<span style="background: rgba(59,130,246,0.2); color: #3B82F6; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem;">@${u ? u.name.split(' ')[0] : 'User'}</span>`;
                        }).join('') : '<span class="text-xs text-muted">None</span>'}
                    </div>

                    <div class="text-xs text-muted mt-2">Posted by ${o.users.name}</div>
                    
                    <div class="flex gap-2 mt-3">
                        ${STATE.user.role === 'LEADER' || o.posted_by === STATE.user.id ? 
                            `<button onclick="deleteItem('opportunities', '${o.id}')" class="btn btn-danger btn-sm">Delete</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function renderAttendance(container) {
            const today = new Date().toISOString().split('T')[0];
            const { data: myAtt } = await sbClient.from('attendance').select('*').eq('user_id', STATE.user.id).eq('date', today).single();
            const { data: history } = await sbClient.from('attendance').select('*, users(name, avatar)').order('date', {ascending: false}).limit(20);

            container.innerHTML = `
                <div class="card p-6 flex" style="justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <div><h3 class="font-bold">Today</h3><div class="text-muted text-sm">${today}</div></div>
                    ${myAtt ? `<span class="btn btn-success">‚úÖ Present</span>` : `<button onclick="markPresent()" class="btn btn-primary">Mark Present</button>`}
                </div>
                <h3 class="font-bold mb-2">Team Log</h3>
                <div class="card p-0" style="overflow: hidden;">
                    ${history.map(h => `
                        <div class="p-3 flex" style="justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <div class="flex" style="align-items: center; gap: 10px;">
                                <span>${h.users.avatar}</span>
                                <div><div class="font-bold text-sm">${h.users.name.split(' ')[0]}</div><div class="text-xs text-muted">${h.date}</div></div>
                            </div>
                            <span class="text-success text-sm">Present</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function renderTeam(container) {
            const { data: users } = await sbClient.from('users').select('*').neq('role', 'LEADER');
            const { data: tasks } = await sbClient.from('tasks').select('*');
            const { data: att } = await sbClient.from('attendance').select('*');

            container.innerHTML = `
                <div class="grid" style="gap: 1rem;">
                    ${users.map(u => {
                        const uTasks = tasks.filter(t => t.assignee_id === u.id);
                        const uAtt = att.filter(a => a.user_id === u.id).length;
                        return `
                            <div class="card p-4 flex" style="align-items: center; justify-content: space-between;">
                                <div class="flex" style="align-items: center; gap: 1rem;">
                                    <div style="font-size: 2rem;">${u.avatar}</div>
                                    <div>
                                        <div class="font-bold">${u.name}</div>
                                        <div class="text-sm text-muted">${uTasks.filter(t => t.status === 'Done').length} Completed Tasks</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-success">${uAtt} Days</div>
                                    <div class="text-xs text-muted">Attendance</div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // --- ACTIONS ---
        function setCreateMode(mode) {
            STATE.createMode = mode;
            // Reset Buttons
            ['task','decision','opp'].forEach(m => document.getElementById(`btn-mode-${m}`).className = 'btn btn-ghost');
            document.getElementById(`btn-mode-${mode}`).className = 'btn btn-primary';
            
            // Toggle Fields
            document.getElementById('task-fields').classList.add('hidden');
            document.getElementById('opp-fields').classList.add('hidden');

            if(mode === 'task') {
                document.getElementById('task-fields').classList.remove('hidden');
            } else if(mode === 'opp') {
                document.getElementById('opp-fields').classList.remove('hidden');
                document.getElementById('tag-list').innerHTML = TEAM.filter(u => u.id !== STATE.user.id).map(u => `
                    <label class="tag-checkbox">
                        <input type="checkbox" value="${u.id}" class="tag-input">
                        <span>${u.avatar} ${u.name.split(' ')[0]}</span>
                    </label>
                `).join('');
            }
        }

        async function submitCreate() {
            const title = document.getElementById('create-title').value;
            const desc = document.getElementById('create-desc').value;
            if(!title) return alert('Title required');

            let error;
            if(STATE.createMode === 'task') {
                const { error: e } = await sbClient.from('tasks').insert({
                    task_title: title, description: desc,
                    priority: document.getElementById('create-priority').value,
                    due_date: document.getElementById('create-date').value,
                    creator_id: STATE.user.id, status: 'Waiting'
                });
                error = e;
            } else if (STATE.createMode === 'decision') {
                const { error: e } = await sbClient.from('decisions').insert({
                    subject: title, details: desc, proposed_by: STATE.user.id
                });
                error = e;
            } else {
                const tags = Array.from(document.querySelectorAll('.tag-input:checked')).map(cb => parseInt(cb.value));
                const { error: e } = await sbClient.from('opportunities').insert({
                    title: title, description: desc,
                    posted_by: STATE.user.id, tagged_members: tags
                });
                error = e;
            }

            if(error) alert(error.message);
            else { closeModal('create-modal'); renderPage(STATE.page); }
        }

        async function confirmAssign() {
            const tid = document.getElementById('approve-id').value;
            const aid = document.getElementById('assign-select').value;
            await sbClient.from('tasks').update({ status: 'Ongoing', assignee_id: aid }).eq('id', tid);
            closeModal('approve-modal'); renderPage('tasks');
        }

        async function markPresent() {
            await sbClient.from('attendance').insert({ user_id: STATE.user.id, date: new Date().toISOString().split('T')[0] });
            renderPage('attendance');
        }

        async function updateStatus(id, status) {
            await sbClient.from('tasks').update({ status: status, completed_at: new Date().toISOString() }).eq('id', id);
            renderPage('tasks');
        }

        async function verifyDecision(id) {
            await sbClient.from('decisions').update({ is_verified: true, verified_by: STATE.user.id }).eq('id', id);
            renderPage('decisions');
        }

        async function deleteItem(table, id) {
            if(!confirm('Delete this item?')) return;
            await sbClient.from(table).delete().eq('id', id);
            renderPage(STATE.page);
        }

        // HELPERS
        function openCreateModal() { 
            document.getElementById('create-modal').classList.remove('hidden'); 
            document.getElementById('create-title').value = '';
            document.getElementById('create-desc').value = '';
            setCreateMode('task'); 
        }
        function openApprove(id) {
            document.getElementById('approve-id').value = id;
            document.getElementById('assign-select').innerHTML = TEAM.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
            document.getElementById('approve-modal').classList.remove('hidden');
        }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    </script>
</body>
</html>
