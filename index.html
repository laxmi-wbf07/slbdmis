<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SLBDMIS | Enterprise v1.0</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”¹</text></svg>">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- CORE THEME VARIABLES --- */
        :root { 
            --primary: #3b82f6;       /* Bright Blue */
            --primary-dark: #2563eb;
            --accent: #10b981;        /* Green */
            --bg: #0f172a;            /* Deep Dark Blue Background */
            --panel: #1e293b;         /* Solid Panel Color */
            --panel-glass: rgba(30, 41, 59, 0.98); /* High Opacity to prevent overlap issues */
            --border: #334155;        /* Borders */
            --text-main: #f8fafc;     /* Bright White Text */
            --text-desc: #e2e8f0;     /* Light Gray for Descriptions (High Contrast) */
            --text-muted: #94a3b8;    /* Muted Text for labels */
            --font-ui: 'Inter', sans-serif;
            --sidebar-width: 260px;
        }

        /* --- GLOBAL RESET --- */
        body { 
            background-color: var(--bg); 
            color: var(--text-main); 
            font-family: var(--font-ui); 
            overflow-x: hidden; 
            -webkit-font-smoothing: antialiased; 
        }
        
        /* Subtle Grid Pattern */
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(var(--border) 1px, transparent 1px), linear-gradient(90deg, var(--border) 1px, transparent 1px);
            background-size: 40px 40px; opacity: 0.05; z-index: -1; pointer-events: none;
        }

        /* --- Z-INDEX LAYERING (Fixes Overlapping) --- */
        /* Level 1: Content (Default)
           Level 2: Sidebar/Headers (1020)
           Level 3: Modals/Backdrops (1050+)
           Level 4: Toasts (3000)
           Level 5: Auth Screen (5000)
        */
        
        .fixed-top, .fixed-bottom { z-index: 1020; }
        .modal { z-index: 2050; }
        .modal-backdrop { z-index: 2040; }
        
        /* --- UI COMPONENTS --- */
        .glass-panel { 
            background: var(--panel-glass); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        /* High Contrast Description Text */
        .task-desc {
            color: var(--text-desc);
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 12px;
            font-weight: 400;
        }

        .mono-label { 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 0.75rem; 
            letter-spacing: 1px; 
            text-transform: uppercase; 
            color: var(--text-muted); 
            margin-bottom: 4px;
            display: block;
        }

        /* Buttons */
        .btn { border-radius: 8px; font-weight: 500; border: none; padding: 10px 20px; transition: all 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline-secondary { border: 1px solid var(--border); color: var(--text-desc); background: rgba(255,255,255,0.02); }
        .btn-outline-secondary:hover { background: var(--border); color: white; }
        .btn-check:checked + .btn-outline-secondary { background: var(--primary); color: white; border-color: var(--primary); }

        /* Inputs */
        .form-control, .form-select {
            background: #020617 !important; 
            border: 1px solid var(--border) !important;
            color: white !important; 
            border-radius: 8px; 
            padding: 12px;
        }
        .form-control:focus { border-color: var(--primary) !important; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25); }
        /* Placeholder Color */
        ::placeholder { color: #64748b !important; opacity: 1; }

        /* --- RESPONSIVE LAYOUT --- */
        .sidebar-container {
            position: fixed; top: 0; left: 0; height: 100vh; width: var(--sidebar-width);
            background: var(--bg); border-right: 1px solid var(--border);
            z-index: 1030; display: none; flex-direction: column; padding: 1.5rem;
        }

        .app-wrapper { width: 100%; min-height: 100vh; padding: 20px; }

        /* Mobile Styles */
        @media (max-width: 767.98px) {
            .app-wrapper { 
                padding-top: 90px;     /* Clear fixed header */
                padding-bottom: 110px; /* Clear bottom nav */
                padding-left: 16px; 
                padding-right: 16px; 
            }
            .mobile-header { display: flex !important; }
            .mobile-nav { display: flex !important; }
            h2 { font-size: 1.5rem; }
        }

        /* Desktop Styles */
        @media (min-width: 768px) {
            .sidebar-container { display: flex; }
            .app-wrapper { 
                padding-left: calc(var(--sidebar-width) + 40px); 
                padding-right: 40px; 
                padding-top: 40px; 
            }
            .mobile-header, .mobile-nav { display: none !important; }
        }

        /* --- WIDGET STYLES --- */
        /* Calendar */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border); border-radius: 8px; border: 1px solid var(--border); overflow: hidden; }
        .cal-day { background: var(--panel); min-height: 80px; padding: 6px; cursor: pointer; transition: 0.2s; }
        .cal-day:hover { background: #2a3855; }
        .cal-today { background: rgba(59, 130, 246, 0.1); box-shadow: inset 0 0 0 1px var(--primary); }
        .cal-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); display: inline-block; margin-right: 4px; }
        .cal-task-item { font-size: 0.65rem; color: #cbd5e1; background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 4px; margin-top: 2px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }

        /* Momentum Graph */
        .bar-container { display: flex; align-items: flex-end; height: 140px; gap: 10px; padding-top: 20px; }
        .bar-group { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .bar-track { width: 100%; height: 100%; background: rgba(255,255,255,0.05); border-radius: 6px; position: relative; overflow: hidden; }
        .bar-fill { position: absolute; bottom: 0; left: 0; width: 100%; background: var(--primary); opacity: 0.9; transition: height 0.8s ease; }

        /* Nav Items */
        .nav-link-custom { display: flex; align-items: center; gap: 12px; padding: 12px 16px; color: var(--text-muted); border-radius: 8px; text-decoration: none; transition: 0.2s; font-weight: 500; }
        .nav-link-custom:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-link-custom.active { background: var(--primary); color: white; }
        
        .nav-mobile-item { color: #64748b; padding: 12px; flex: 1; text-align: center; border-radius: 8px; transition: 0.2s; }
        .nav-mobile-item.active { color: var(--primary); background: rgba(59, 130, 246, 0.1); }
        .nav-mobile-item i { stroke-width: 2.5px; }

        .chat-bubble { background: #2a3855; border-radius: 12px; padding: 14px; margin-bottom: 12px; border-left: 4px solid var(--border); }
        .chat-bubble.leader { border-left-color: var(--primary); background: rgba(59, 130, 246, 0.15); }

    </style>
</head>
<body>

    <div id="view-auth" class="d-none fixed-top w-100 h-100 bg-black d-flex flex-column justify-content-center align-items-center" style="z-index: 5000;">
        <div class="text-center mb-5">
            <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-3 shadow-lg" style="width: 80px; height: 80px;">
                <i data-lucide="shield-check" class="text-white" size="40"></i>
            </div>
            <h1 class="fw-bold text-white tracking-tight">SLBDMIS</h1>
            <p class="text-muted small letter-spacing-2">SECURE LOGIN SYSTEM</p>
        </div>
        
        <div id="auth-list" class="row g-3 px-3" style="max-width: 450px; width: 100%;"></div>
        
        <div id="auth-pin" class="d-none text-center" style="max-width: 320px;">
            <div id="l-av" class="display-3 mb-3"></div>
            <h3 id="l-name" class="text-white mb-4"></h3>
            <input type="password" id="inp-pin" class="form-control text-center fs-3 mb-3 text-white" maxlength="11" placeholder="Enter PIN">
            <button onclick="tryLogin()" class="btn btn-primary w-100 py-3 fw-bold mb-3 fs-5">ACCESS SYSTEM</button>
            <button onclick="resetAuth()" class="btn btn-link text-secondary text-decoration-none">Back to Users</button>
        </div>
    </div>

    <div id="view-app" class="d-none">
        
        <div class="sidebar-container">
            <div class="d-flex align-items-center gap-2 px-2 mb-5 mt-2">
                <div class="bg-primary rounded p-1"><i data-lucide="box" class="text-white" size="20"></i></div>
                <span class="fw-bold text-white tracking-tight fs-5">SLBDMIS</span>
            </div>
            
            <nav class="flex-grow-1 d-flex flex-column gap-1">
                <a onclick="nav('home')" id="nd-home" class="nav-link-custom cursor-pointer"><i data-lucide="layout-dashboard" size="20"></i> Dashboard</a>
                <a onclick="nav('cal')" id="nd-cal" class="nav-link-custom cursor-pointer"><i data-lucide="calendar" size="20"></i> Calendar</a>
                <a onclick="nav('task')" id="nd-task" class="nav-link-custom cursor-pointer"><i data-lucide="check-square" size="20"></i> Tasks</a>
                <a onclick="nav('idea')" id="nd-idea" class="nav-link-custom cursor-pointer"><i data-lucide="lightbulb" size="20"></i> Ideas</a>
                <a onclick="nav('feed')" id="nd-feed" class="nav-link-custom cursor-pointer"><i data-lucide="message-square" size="20"></i> Feed</a>
                <a onclick="nav('drive')" id="nd-drive" class="nav-link-custom cursor-pointer"><i data-lucide="hard-drive" size="20"></i> Drive</a>
            </nav>

            <div class="mt-auto border-top border-secondary border-opacity-25 pt-3 px-2">
                <div class="d-flex align-items-center gap-3">
                    <div id="d-av" class="rounded-circle bg-secondary d-flex justify-content-center align-items-center text-white fw-bold" style="width: 40px; height: 40px; font-size: 1.2rem;"></div>
                    <div class="overflow-hidden">
                        <div id="d-name" class="text-white fw-bold small text-truncate"></div>
                        <div id="d-role" class="text-muted text-xs small"></div>
                    </div>
                    <button onclick="doLogout()" class="btn btn-icon ms-auto text-secondary hover-white" title="Logout"><i data-lucide="log-out" size="18"></i></button>
                </div>
            </div>
        </div>

        <div class="mobile-header fixed-top glass-panel m-2 d-flex align-items-center justify-content-between px-3" style="height: 64px;">
            <div class="fw-bold text-white d-flex align-items-center gap-2 fs-5">
                <i data-lucide="box" size="20" class="text-primary"></i> SLBDMIS
            </div>
            <div class="d-flex align-items-center gap-3">
                <div id="m-av" class="small fs-4"></div>
                <button onclick="doLogout()" class="btn btn-sm text-secondary p-0"><i data-lucide="log-out" size="20"></i></button>
            </div>
        </div>

        <div class="app-wrapper">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 id="page-title" class="fw-bold text-white m-0">Dashboard</h2>
                <button onclick="openCreate()" class="btn btn-primary d-flex align-items-center gap-2 shadow-sm">
                    <i data-lucide="plus" size="20"></i> <span class="d-none d-sm-inline">New Item</span>
                </button>
            </div>

            <div id="app-content"></div>
        </div>

        <div class="mobile-nav fixed-bottom m-3 p-1 glass-panel d-flex justify-content-between">
            <div onclick="nav('home')" id="nm-home" class="nav-mobile-item"><i data-lucide="layout-dashboard" size="22"></i></div>
            <div onclick="nav('cal')" id="nm-cal" class="nav-mobile-item"><i data-lucide="calendar" size="22"></i></div>
            <div onclick="nav('task')" id="nm-task" class="nav-mobile-item"><i data-lucide="check-square" size="22"></i></div>
            <div onclick="nav('idea')" id="nm-idea" class="nav-mobile-item"><i data-lucide="lightbulb" size="22"></i></div>
            <div onclick="nav('feed')" id="nm-feed" class="nav-mobile-item"><i data-lucide="message-square" size="22"></i></div>
            <div onclick="nav('drive')" id="nm-drive" class="nav-mobile-item"><i data-lucide="hard-drive" size="22"></i></div>
        </div>
    </div>

    <div class="modal fade" id="modCreate" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass-panel border-0">
                <div class="modal-header border-bottom border-secondary border-opacity-25">
                    <h5 class="fw-bold text-white mb-0">Create New</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="btn-group w-100 mb-4" role="group">
                        <input type="radio" class="btn-check" name="ctype" id="ct-task" value="task" checked onchange="toggleForm('task')">
                        <label class="btn btn-outline-secondary" for="ct-task">Task</label>

                        <input type="radio" class="btn-check" name="ctype" id="ct-idea" value="idea" onchange="toggleForm('idea')">
                        <label class="btn btn-outline-secondary" for="ct-idea">Idea</label>
                        
                        <input type="radio" class="btn-check" name="ctype" id="ct-msg" value="feed" onchange="toggleForm('feed')">
                        <label class="btn btn-outline-secondary" for="ct-msg">Post</label>
                    </div>

                    <label class="mono-label">Title / Subject</label>
                    <input type="text" id="inp-title" class="form-control mb-3 fw-bold fs-5" placeholder="Enter title...">
                    
                    <label class="mono-label">Description</label>
                    <textarea id="inp-desc" class="form-control mb-3" rows="3" placeholder="Add details..."></textarea>
                    
                    <div id="form-task-opts">
                        <div class="row g-3 mb-3">
                            <div class="col-6">
                                <label class="mono-label">Due Date</label>
                                <input type="date" id="inp-date" class="form-control">
                            </div>
                            <div class="col-6">
                                <label class="mono-label">Priority</label>
                                <select id="inp-prio" class="form-select">
                                    <option value="Normal">Normal</option>
                                    <option value="High">High</option>
                                </select>
                            </div>
                        </div>
                        <label class="mono-label mb-2 d-block">Assign Members</label>
                        <div id="div-mems" class="d-flex flex-wrap gap-2 mb-4"></div>
                    </div>

                    <button onclick="saveItem()" class="btn btn-primary w-100 py-3 fw-bold">Create Item</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modSubmit" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass-panel border-0">
                <div class="modal-header border-bottom border-secondary border-opacity-25">
                    <h5 class="fw-bold text-white mb-0">Submit File</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4 text-center">
                    <p class="text-desc mb-4">Click a folder below to open Google Drive, then confirm your upload.</p>
                    <div class="row g-3 mb-4">
                        <div class="col-6"><button onclick="openDriveLink('Admin')" class="btn btn-outline-secondary w-100 p-3 h-100"><i data-lucide="shield" class="mb-2 text-primary"></i><br>Admin</button></div>
                        <div class="col-6"><button onclick="openDriveLink('Machine')" class="btn btn-outline-secondary w-100 p-3 h-100"><i data-lucide="cpu" class="mb-2 text-primary"></i><br>Machine</button></div>
                        <div class="col-6"><button onclick="openDriveLink('Pics')" class="btn btn-outline-secondary w-100 p-3 h-100"><i data-lucide="image" class="mb-2 text-primary"></i><br>Media</button></div>
                        <div class="col-6"><button onclick="openDriveLink('PPT')" class="btn btn-outline-secondary w-100 p-3 h-100"><i data-lucide="presentation" class="mb-2 text-primary"></i><br>Decks</button></div>
                    </div>
                    <label class="mono-label text-start d-block">Submission Note</label>
                    <textarea id="sub-note" class="form-control mb-3" placeholder="Describe what you uploaded..."></textarea>
                    <button onclick="confirmSubmit()" class="btn btn-success w-100 py-3 fw-bold">Confirm Upload</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 4000">
        <div id="sysToast" class="toast align-items-center text-white bg-primary border-0 shadow-lg" role="alert">
            <div class="d-flex">
                <div class="toast-body fw-bold px-4 py-3" id="toast-msg">Action Successful</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SB_URL = 'https://bzrkbjjgymdbbwpatfct.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6cmtiampneW1kYmJ3cGF0ZmN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTcyNjcsImV4cCI6MjA4NTg3MzI2N30.Icv1daEp7NophE_ktPl2G1EgDP6awo0tyV14yh3Q4Sw';
        const sbClient = window.supabase.createClient(SB_URL, SB_KEY);
        
        const TEAM = [
            { id: 1, name: "Pema Ugyen", av: "ðŸ‘¨â€ðŸ’¼", pin: "11107008201", role: "LEADER" },
            { id: 2, name: "Jamphel",    av: "ðŸ‘¨â€ðŸ’»", pin: "11302003634", role: "MEMBER" },
            { id: 3, name: "Laxmi",      av: "ðŸ‘¨â€ðŸ”¬", pin: "11103002151", role: "MEMBER" },
            { id: 4, name: "Ngawang",    av: "ðŸ‘¨",   pin: "10801003243", role: "MEMBER" }
        ];

        const DRIVE_LINKS = {
            'Admin': 'https://drive.google.com/drive/folders/1VskzY_IgfF6lagiEdaF5-yy6Te_u-MMG?usp=sharing',
            'Machine': 'https://drive.google.com/drive/folders/1FivXbl7Qo5qnKV2Kn6DXxdtVUS4nB5CF?usp=sharing',
            'Pics': 'https://drive.google.com/drive/folders/11Q6gWSLqU4H88DrmWA_Fmbkx8dsNs0Ka?usp=sharing',
            'PPT': 'https://drive.google.com/drive/folders/1IBpIa7nH43g1UVMYkFOwLA6iEFVvuv7y?usp=sharing'
        };

        let STATE = { user: null, page: 'home', createMode: 'task', activeTaskForSub: null, selectedDrive: null };
        let MODAL_CREATE, MODAL_SUBMIT;

        // --- INIT ---
        window.onload = function() {
            lucide.createIcons();
            
            // Init Bootstrap Modals
            MODAL_CREATE = new bootstrap.Modal(document.getElementById('modCreate'));
            MODAL_SUBMIT = new bootstrap.Modal(document.getElementById('modSubmit'));

            // Check Auth
            const storedUid = localStorage.getItem('slbd_uid');
            if(storedUid) {
                const u = TEAM.find(x => x.id == storedUid);
                if(u) login(u); else initAuth();
            } else {
                initAuth();
            }

            // Realtime Sync
            sbClient.channel('public:any').on('postgres_changes', { event: '*', schema: 'public' }, () => {
                if(STATE.user) render();
            }).subscribe();
        };

        // --- AUTH ---
        function initAuth() {
            document.getElementById('view-auth').classList.remove('d-none');
            const list = document.getElementById('auth-list');
            list.innerHTML = TEAM.map(u => `
                <div class="col-6">
                    <div onclick="preLogin(${u.id})" class="glass-panel p-4 text-center cursor-pointer h-100 hover-panel">
                        <div class="fs-1 mb-2">${u.av}</div>
                        <div class="fw-bold text-white">${u.name.split(' ')[0]}</div>
                    </div>
                </div>
            `).join('');
        }

        function preLogin(id) {
            STATE.selUser = TEAM.find(u => u.id === id);
            document.getElementById('auth-list').classList.add('d-none');
            document.getElementById('auth-pin').classList.remove('d-none');
            document.getElementById('l-av').innerText = STATE.selUser.av;
            document.getElementById('l-name').innerText = STATE.selUser.name;
            document.getElementById('inp-pin').value = '';
            setTimeout(() => document.getElementById('inp-pin').focus(), 100);
        }

        function resetAuth() {
            document.getElementById('auth-pin').classList.add('d-none');
            document.getElementById('auth-list').classList.remove('d-none');
        }

        function tryLogin() {
            if(document.getElementById('inp-pin').value === STATE.selUser.pin) {
                localStorage.setItem('slbd_uid', STATE.selUser.id);
                document.getElementById('view-auth').classList.add('d-none');
                login(STATE.selUser);
            } else {
                alert('Invalid PIN');
            }
        }

        function login(u) {
            STATE.user = u;
            document.getElementById('view-app').classList.remove('d-none');
            document.getElementById('d-name').innerText = u.name;
            document.getElementById('d-role').innerText = u.role;
            document.getElementById('d-av').innerText = u.av;
            document.getElementById('m-av').innerText = u.av;
            nav('home');
        }

        function doLogout() {
            localStorage.removeItem('slbd_uid');
            location.reload();
        }

        // --- NAV ---
        function nav(page) {
            STATE.page = page;
            document.querySelectorAll('.nav-link-custom, .nav-mobile-item').forEach(el => el.classList.remove('active'));
            if(document.getElementById('nd-' + page)) document.getElementById('nd-' + page).classList.add('active');
            if(document.getElementById('nm-' + page)) document.getElementById('nm-' + page).classList.add('active');
            
            const titles = { 'home':'Dashboard', 'cal':'Calendar', 'task':'Tasks', 'idea':'Ideas', 'feed':'Feed', 'drive':'Drive' };
            document.getElementById('page-title').innerText = titles[page];
            render();
        }

        // --- RENDER ---
        async function render() {
            const container = document.getElementById('app-content');
            if(!container.innerHTML) container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';

            try {
                const { data: tasks } = await sbClient.from('tasks').select('*').order('created_at', {ascending: false});
                const { data: feed } = await sbClient.from('decisions').select('*').order('created_at', {ascending: false});
                
                let html = '';

                // 1. DASHBOARD
                if(STATE.page === 'home') {
                    let graphHtml = '';
                    TEAM.forEach(member => {
                        const memberTasks = tasks.filter(t => (t.tagged_members||[]).includes(member.id) && t.status !== 'Idea');
                        let totalProg = 0;
                        if(memberTasks.length > 0) totalProg = memberTasks.reduce((acc, curr) => acc + (curr.progress || 0), 0) / memberTasks.length;
                        graphHtml += `
                            <div class="bar-group">
                                <div class="bar-track"><div class="bar-fill" style="height: ${Math.round(totalProg)}%"></div></div>
                                <div class="mono-label" style="font-size:0.6rem">${member.name.split(' ')[0]}</div>
                                <div class="fw-bold small">${Math.round(totalProg)}%</div>
                            </div>`;
                    });

                    const myTasks = tasks.filter(t => t.status !== 'Done' && t.status !== 'Idea' && (t.tagged_members||[]).includes(STATE.user.id)).slice(0, 6);
                    html = `
                        <div class="row g-4">
                            <div class="col-12 col-xl-6">
                                <div class="glass-panel p-4 h-100">
                                    <h6 class="mono-label mb-3">Team Performance</h6>
                                    <div class="bar-container">${graphHtml}</div>
                                </div>
                            </div>
                            <div class="col-12 col-xl-6">
                                <div class="glass-panel p-4 h-100">
                                    <h6 class="mono-label mb-3">Your Queue</h6>
                                    ${myTasks.length === 0 ? '<div class="text-muted text-center py-4">All clear.</div>' : 
                                      myTasks.map(t => `
                                        <div class="d-flex align-items-center justify-content-between p-3 mb-2 rounded bg-dark border border-secondary border-opacity-25">
                                            <div class="text-truncate me-2">
                                                <div class="fw-bold text-white small">${t.task_title}</div>
                                                <div class="text-xs badge bg-secondary bg-opacity-25 mt-1">${t.status}</div>
                                            </div>
                                            <div class="text-primary fw-bold small">${t.progress}%</div>
                                        </div>`).join('')}
                                </div>
                            </div>
                        </div>`;
                }

                // 2. CALENDAR
                if(STATE.page === 'cal') {
                    const now = new Date();
                    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
                    let days = '';
                    for(let i=0; i<firstDay; i++) days += `<div class="cal-day bg-transparent"></div>`;
                    for(let d=1; d<=daysInMonth; d++) {
                        const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                        const dayTasks = tasks.filter(t => t.due_date === dateStr && t.status !== 'Idea');
                        const isToday = d === now.getDate();
                        days += `
                            <div class="cal-day ${isToday ? 'cal-today' : ''}" onclick="openCreateWithDate('${dateStr}')">
                                <span class="small fw-bold ${isToday ? 'text-primary' : 'text-secondary'}">${d}</span>
                                <div class="mt-1">${dayTasks.map(t => `<div class="cal-task-item"><span class="cal-dot"></span>${t.task_title}</div>`).join('')}</div>
                            </div>`;
                    }
                    html = `
                        <div class="glass-panel p-2">
                            <div class="p-3 text-center fw-bold text-white border-bottom border-secondary border-opacity-25 mb-1">${now.toLocaleString('default',{month:'long'})} ${now.getFullYear()}</div>
                            <div class="cal-grid">
                                ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(h => `<div class="p-2 text-center mono-label bg-dark">${h}</div>`).join('')}
                                ${days}
                            </div>
                        </div>`;
                }

                // 3. TASKS
                if(STATE.page === 'task') {
                    const activeTasks = tasks.filter(t => t.status !== 'Idea' && t.status !== 'Done');
                    html = `<div class="row g-3">
                        ${activeTasks.length === 0 ? '<div class="col-12 text-center text-muted py-5">All tasks completed.</div>' : ''}
                        ${activeTasks.map(t => {
                            const isMyTask = (t.tagged_members||[]).includes(STATE.user.id);
                            let actionBtns = '';
                            if(STATE.user.role === 'LEADER' && t.status === 'ApprovalReq') {
                                actionBtns = `<button onclick="updateStatus(${t.id}, 'Pending')" class="btn btn-primary btn-sm w-100 mt-2">Approve Task</button>`;
                            } else if (t.status === 'Review') {
                                actionBtns = STATE.user.role === 'LEADER' 
                                    ? `<div class="d-flex gap-2 mt-2"><button onclick="updateStatus(${t.id}, 'Done')" class="btn btn-success btn-sm flex-fill">Accept</button><button onclick="updateStatus(${t.id}, 'Pending')" class="btn btn-outline-danger btn-sm flex-fill">Reject</button></div>`
                                    : `<div class="alert alert-info py-2 px-2 mt-2 small mb-0 text-center"><i data-lucide="clock" size="14"></i> Under Review</div>`;
                            } else {
                                actionBtns = `<button onclick="openSubmit(${t.id}, '${t.task_title}')" class="btn btn-outline-secondary btn-sm w-100 mt-2">Submit File</button>`;
                            }
                            
                            // High Contrast Slider
                            const slider = isMyTask ? `
                                <div class="mt-3 pt-3 border-top border-secondary border-opacity-25">
                                    <div class="d-flex justify-content-between mb-2"><label class="mono-label">My Progress</label><span class="fw-bold text-primary" id="prog-txt-${t.id}">${t.progress}%</span></div>
                                    <input type="range" class="form-range" min="0" max="100" value="${t.progress}" oninput="document.getElementById('prog-txt-${t.id}').innerText = this.value + '%'" onchange="updateProgress(${t.id}, this.value)">
                                </div>` : `<div class="mt-3 pt-3 border-top border-secondary border-opacity-25"><div class="d-flex justify-content-between mb-1"><span class="mono-label">Progress</span><span class="small fw-bold text-white">${t.progress}%</span></div><div class="progress h-1 mt-1 bg-dark"><div class="progress-bar" style="width:${t.progress}%"></div></div></div>`;

                            return `
                                <div class="col-12 col-md-6 col-xl-4">
                                    <div class="glass-panel p-4 h-100 d-flex flex-column">
                                        <div class="d-flex justify-content-between align-items-start mb-2"><span class="badge bg-secondary text-white">${t.status}</span>${t.priority === 'High' ? '<span class="text-danger small fw-bold">HIGH</span>' : ''}</div>
                                        <h5 class="fw-bold mb-2 text-white">${t.task_title}</h5>
                                        <p class="task-desc mb-auto">${t.description || 'No description provided.'}</p>
                                        ${slider}
                                        ${actionBtns}
                                    </div>
                                </div>`;
                        }).join('')}
                    </div>`;
                }

                // 4. IDEAS
                if(STATE.page === 'idea') {
                    const ideas = tasks.filter(t => t.status === 'Idea');
                    html = `
                        <div class="text-center mb-4">
                            <button onclick="openCreate('idea')" class="btn btn-outline-secondary py-3 px-5 border-dashed"><i data-lucide="plus-circle" class="me-2"></i> Add New Idea</button>
                        </div>
                        <div class="row g-3">
                            ${ideas.map(t => `
                                <div class="col-12 col-md-6">
                                    <div class="glass-panel p-4 border-start border-4 border-info d-flex justify-content-between align-items-start">
                                        <div>
                                            <h5 class="fw-bold mb-2">${t.task_title}</h5>
                                            <p class="task-desc mb-0">${t.description}</p>
                                        </div>
                                        <button onclick="updateStatus(${t.id}, 'Pending')" class="btn btn-sm btn-primary ms-3"><i data-lucide="arrow-up-right" size="18"></i></button>
                                    </div>
                                </div>`).join('')}
                        </div>`;
                }

                // 5. FEED
                if(STATE.page === 'feed') {
                    html = `
                        <div class="glass-panel p-3 mb-3 d-flex flex-column-reverse" style="height:65vh; overflow-y:auto">
                            ${feed.map(f => `
                                <div class="chat-bubble ${f.subject.includes('LEADER') ? 'leader' : ''}">
                                    <div class="d-flex justify-content-between mb-1"><span class="fw-bold text-white small">${f.subject}</span><span class="text-muted text-xs">${new Date(f.created_at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></div>
                                    <div class="text-desc small">${f.details}</div>
                                </div>`).join('')}
                        </div>
                        <button onclick="openCreate('feed')" class="btn btn-primary w-100 py-3"><i data-lucide="send" class="me-2" size="18"></i>Post Message</button>`;
                }

                // 6. DRIVE
                if(STATE.page === 'drive') {
                    const doneTasks = tasks.filter(t => t.status === 'Done').sort((a,b) => new Date(b.updated_at) - new Date(a.updated_at));
                    const driveCards = Object.keys(DRIVE_LINKS).map(k => `
                        <div class="col-6 col-sm-4 col-md-3">
                            <div onclick="openDriveLink('${k}')" class="glass-panel p-4 text-center h-100 hover-panel cursor-pointer">
                                <i data-lucide="folder" class="text-primary mb-2" size="36"></i><div class="text-white fw-bold fs-5">${k}</div>
                            </div>
                        </div>`).join('');
                    html = `
                        <div class="row g-3 mb-5">${driveCards}</div>
                        <h6 class="mono-label mb-3">Completed Archive</h6>
                        <div class="glass-panel overflow-hidden">
                            <table class="table table-dark table-hover mb-0 small">
                                <thead><tr><th class="bg-transparent text-secondary p-3">Task</th><th class="bg-transparent text-end text-secondary p-3">Completed</th></tr></thead>
                                <tbody>${doneTasks.map(t => `<tr><td class="p-3 bg-transparent text-white">${t.task_title}</td><td class="p-3 text-end text-muted bg-transparent">${new Date(t.updated_at).toLocaleDateString()}</td></tr>`).join('')}</tbody>
                            </table>
                        </div>`;
                }
                container.innerHTML = html;
                lucide.createIcons();
            } catch (e) { console.error(e); }
        }

        // --- ACTIONS ---
        function openCreate(type) {
            if(type) {
                document.getElementById('ct-'+ (type==='feed'?'msg':type)).checked = true;
                toggleForm(type === 'feed' ? 'feed' : type);
            }
            const memDiv = document.getElementById('div-mems');
            memDiv.innerHTML = TEAM.map(u => `<input type="checkbox" class="btn-check" id="chk-${u.id}" value="${u.id}"><label class="btn btn-outline-secondary btn-sm" for="chk-${u.id}">${u.name.split(' ')[0]}</label>`).join('');
            document.getElementById('inp-date').valueAsDate = new Date();
            MODAL_CREATE.show();
        }

        function openCreateWithDate(date) {
            openCreate('task');
            setTimeout(() => { document.getElementById('inp-date').value = date; }, 200);
        }

        function toggleForm(type) {
            STATE.createMode = type;
            const taskOpts = document.getElementById('form-task-opts');
            if (type === 'task') taskOpts.classList.remove('d-none'); else taskOpts.classList.add('d-none');
        }

        async function saveItem() {
            const title = document.getElementById('inp-title').value;
            const desc = document.getElementById('inp-desc').value;
            if(!title) return alert('Title is required');

            if(STATE.createMode === 'feed') {
                await sbClient.from('decisions').insert({ subject: `${STATE.user.name} [${STATE.user.role}]`, details: `${title} - ${desc}` });
            } else {
                const status = STATE.createMode === 'idea' ? 'Idea' : (STATE.user.role === 'LEADER' ? 'Pending' : 'ApprovalReq');
                const mems = [...document.querySelectorAll('#div-mems input:checked')].map(c => parseInt(c.value));
                await sbClient.from('tasks').insert({
                    task_title: title, description: desc, status: status, creator_id: STATE.user.id,
                    tagged_members: mems, due_date: document.getElementById('inp-date').value || null,
                    priority: document.getElementById('inp-prio').value, progress: 0
                });
            }
            MODAL_CREATE.hide();
            document.getElementById('inp-title').value = '';
            document.getElementById('inp-desc').value = '';
            showToast('Created Successfully');
        }

        async function updateProgress(id, val) { await sbClient.from('tasks').update({ progress: parseInt(val), updated_at: new Date() }).eq('id', id); }
        async function updateStatus(id, status) { await sbClient.from('tasks').update({ status: status, updated_at: new Date() }).eq('id', id); showToast(`Status updated to ${status}`); }

        function openSubmit(id, title) { STATE.activeTaskForSub = { id, title }; MODAL_SUBMIT.show(); }
        function openDriveLink(type) { STATE.selectedDrive = type; window.open(DRIVE_LINKS[type], '_blank'); }
        
        async function confirmSubmit() {
            if(!STATE.selectedDrive) return alert('Select a drive folder first');
            const note = document.getElementById('sub-note').value;
            await sbClient.from('tasks').update({ status: 'Review', updated_at: new Date() }).eq('id', STATE.activeTaskForSub.id);
            await sbClient.from('decisions').insert({ subject: `FILE: ${STATE.activeTaskForSub.title}`, details: `Uploaded to ${STATE.selectedDrive}. ${note}` });
            MODAL_SUBMIT.hide();
            showToast('Submitted Successfully');
        }

        function showToast(msg) {
            document.getElementById('toast-msg').innerText = msg;
            const toast = new bootstrap.Toast(document.getElementById('sysToast'));
            toast.show();
        }
    </script>
</body>
</html>
