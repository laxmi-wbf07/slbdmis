<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SLBDMIS - Polished</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- THEME & UI POLISH --- */
        :root {
            --bg: #0F172A;
            --card: #1E293B;
            --hover: #334155;
            --primary: #3B82F6;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --text: #F8FAFC;
            --muted: #94A3B8;
            --border: rgba(255,255,255,0.08);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background-color: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- COMPONENTS --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .grid { display: grid; }
        .p-4 { padding: 1rem; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-muted { color: var(--muted); }

        .card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }

        .btn {
            padding: 0.7rem 1.2rem;
            border-radius: 0.6rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex; align-items: center; gap: 0.5rem; justify-content: center;
            transition: all 0.2s; font-size: 0.9rem;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-ghost { background: transparent; color: var(--muted); border: 1px solid var(--hover); }
        .btn:active { transform: scale(0.96); }

        input, select, textarea {
            background: var(--hover);
            border: 1px solid var(--border);
            color: white;
            padding: 0.9rem;
            border-radius: 0.6rem;
            width: 100%;
            outline: none;
            margin-bottom: 1rem;
            font-size: 16px; /* Prevents iOS zoom */
        }

        /* --- BADGES (High Visibility) --- */
        .badge { padding: 3px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: bold; white-space: nowrap; }
        .badge-Urgent { background: rgba(239, 68, 68, 0.2); color: #FCA5A5; border: 1px solid rgba(239, 68, 68, 0.3); }
        .badge-High { background: rgba(245, 158, 11, 0.2); color: #FDBA74; border: 1px solid rgba(245, 158, 11, 0.3); }
        .badge-Normal { background: rgba(59, 130, 246, 0.2); color: #93C5FD; border: 1px solid rgba(59, 130, 246, 0.3); }
        
        /* --- COLLAPSIBLE DETAILS --- */
        details summary { cursor: pointer; list-style: none; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px; font-weight: 600; font-size: 0.9rem; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        details summary::after { content: '‚ñº'; font-size: 0.7rem; transition: 0.2s; }
        details[open] summary::after { transform: rotate(180deg); }

        /* --- LAYOUT --- */
        .sidebar {
            width: 260px; background: var(--card); height: 100vh; position: fixed;
            padding: 1.5rem; display: flex; flex-direction: column;
            border-right: 1px solid var(--border); z-index: 50;
        }
        
        .main-content {
            margin-left: 260px; padding: 2rem; width: calc(100% - 260px);
            height: 100vh; overflow-y: auto; 
            padding-bottom: calc(90px + var(--safe-bottom)); 
        }

        .nav-item {
            padding: 1rem; margin-bottom: 0.5rem; border-radius: 0.8rem;
            color: var(--muted); cursor: pointer; display: flex; align-items: center; gap: 12px;
            font-weight: 500; transition: background 0.2s;
        }
        .nav-item.active { background: var(--primary); color: white; }
        .nav-item:hover:not(.active) { background: var(--hover); }

        /* --- MOBILE --- */
        .mobile-nav {
            display: none;
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(30, 41, 59, 0.98);
            backdrop-filter: blur(15px);
            padding: 10px 10px;
            padding-bottom: calc(10px + var(--safe-bottom));
            justify-content: space-around;
            border-top: 1px solid var(--border);
            z-index: 100;
            box-shadow: 0 -4px 30px rgba(0,0,0,0.4);
        }
        
        .mobile-nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: var(--muted); font-size: 0.65rem; gap: 4px;
            padding: 6px 10px; border-radius: 8px; flex: 1;
        }
        .mobile-nav-item.active { color: var(--primary); background: rgba(59, 130, 246, 0.1); }
        .mobile-nav-item.active svg { stroke: var(--primary); stroke-width: 2.5px; }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; width: 100%; padding: 1rem; padding-top: 1rem; }
            .mobile-nav { display: flex; }
            .avatar-grid { grid-template-columns: repeat(2, 1fr) !important; }
            #avatar-container .avatar-card:nth-last-child(1):nth-child(odd) { grid-column: span 2; }
            #logout-btn-mobile { display: flex !important; }
        }

        /* --- TOAST --- */
        #toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--success); color: white; padding: 12px 24px;
            border-radius: 50px; font-weight: 600; z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #toast.show { opacity: 1; top: 30px; }

        /* --- TAGS & LOGIN --- */
        .tag-row {
            display: flex; align-items: center; gap: 12px; padding: 12px;
            background: var(--hover); border-radius: 8px; margin-bottom: 8px; cursor: pointer;
        }
        .tag-row input { width: 22px; height: 22px; margin: 0; accent-color: var(--primary); }

        .loader-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 200; display: flex; align-items: center; justify-content: center; }
        .spinner { width: 45px; height: 45px; border: 4px solid var(--hover); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .avatar-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; }
        .avatar-card { padding: 1.5rem; border-radius: 1rem; cursor: pointer; background: var(--card); border: 2px solid transparent; text-align: center; }
        .avatar-card.selected { border-color: var(--primary); background: rgba(59, 130, 246, 0.1); transform: scale(1.02); }
    </style>
</head>
<body>

    <div id="toast">Action Complete</div>

    <div id="app-loader" class="loader-overlay"><div class="spinner"></div></div>

    <div id="login-view" class="flex hidden" style="height: 100vh; align-items: center; justify-content: center; background: radial-gradient(circle at center, #1E293B 0%, #0F172A 100%); overflow-y: auto;">
        <div class="card p-4" style="width: 90%; max-width: 500px; margin: auto;">
            <div class="text-center" style="margin-bottom: 2rem;">
                <h1 style="font-size: 2.2rem; font-weight: 900; margin-bottom: 5px;">SLBDMIS</h1>
                <p class="text-muted text-sm">Lead-Filter Pro System</p>
            </div>
            <div id="avatar-container" class="avatar-grid"></div>
            <div id="auth-box" class="hidden text-center" style="margin-top: 2rem; animation: fadeIn 0.3s;">
                <input type="password" id="cid-input" placeholder="Enter CID" style="text-align: center; letter-spacing: 3px; font-weight: bold;">
                <p id="login-err" style="color: var(--danger); min-height: 20px; font-size: 0.9rem; margin-bottom: 10px;"></p>
                <button onclick="login()" class="btn btn-primary" style="width: 100%; padding: 1rem;">Login</button>
            </div>
        </div>
    </div>

    <div id="dashboard-view" class="hidden">
        <nav class="sidebar">
            <div class="flex" style="align-items: center; gap: 10px; margin-bottom: 2rem;">
                <div style="background: var(--primary); padding: 8px; border-radius: 8px;"><i data-lucide="layout-grid" color="white"></i></div>
                <div><div class="font-bold">SLBDMIS</div><div class="text-xs text-muted">Final Polish</div></div>
            </div>
            <div id="sidebar-links"></div>
            <div style="margin-top: auto;" class="nav-item" onclick="handleLogout()"><i data-lucide="log-out"></i> Logout</div>
        </nav>

        <main class="main-content">
            <header class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div>
                    <h2 id="page-title" class="font-bold" style="font-size: 1.5rem;">Overview</h2>
                    <p class="text-muted text-sm">Hi, <span id="user-display">User</span> <span style="color:var(--success);">‚óè</span></p>
                </div>
                <div class="flex" style="gap: 8px; align-items: center;">
                    <button onclick="openCreateModal()" class="btn btn-primary"><i data-lucide="plus"></i> <span style="display:none; @media(min-width:600px){display:inline;}">New</span></button>
                    <button id="logout-btn-mobile" onclick="handleLogout()" class="btn btn-danger" style="display:none; padding: 0.7rem;"><i data-lucide="log-out"></i></button>
                </div>
            </header>
            <div id="content-area"></div>
        </main>

        <nav id="mobile-nav" class="mobile-nav"></nav>
    </div>

    <div id="create-modal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 200; display: flex; align-items: flex-end; justify-content: center; padding-bottom: calc(20px + var(--safe-bottom)); @media(min-width:768px){align-items:center; padding-bottom:0;}">
        <div class="card p-4" style="width: 95%; max-width: 500px; max-height: 85vh; overflow-y: auto; background: var(--card);">
            <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 class="font-bold text-lg">Create New</h3>
                <button onclick="closeModal('create-modal')" class="btn btn-ghost" style="padding: 5px;"><i data-lucide="x"></i></button>
            </div>
            
            <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 1rem;">
                <button onclick="setCreateMode('task')" id="btn-mode-task" class="btn btn-primary text-xs">Task</button>
                <button onclick="setCreateMode('decision')" id="btn-mode-decision" class="btn btn-ghost text-xs">Decision</button>
                <button onclick="setCreateMode('opp')" id="btn-mode-opp" class="btn btn-ghost text-xs">Not Yet</button>
            </div>

            <input id="create-title" placeholder="Title / Subject">
            <textarea id="create-desc" placeholder="Details..." rows="3"></textarea>
            
            <div id="task-fields">
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label class="text-xs text-muted mb-1 block">Priority</label>
                        <select id="create-priority">
                            <option value="Normal">Normal</option>
                            <option value="High">High</option>
                            <option value="Urgent">Urgent</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-muted mb-1 block">Category</label>
                        <select id="create-category">
                            <option value="General">General</option>
                            <option value="Dev">Development</option>
                            <option value="Design">Design</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                </div>
                <label class="text-xs text-muted mb-1 block">Due Date</label>
                <input type="date" id="create-date">
            </div>

            <div style="margin-top: 10px;">
                <label class="text-xs text-muted mb-2 block font-bold" id="tag-label">TAG / ASSIGN:</label>
                <div id="tag-list" style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 5px;"></div>
            </div>

            <button onclick="submitCreate()" class="btn btn-success w-full" style="margin-top: 1.5rem; padding: 1rem;">Submit</button>
        </div>
    </div>

    <div id="approve-modal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 200; display: flex; align-items: center; justify-content: center;">
        <div class="card p-4" style="width: 90%; max-width: 400px;">
            <h3 class="font-bold mb-4">Assign Task</h3>
            <input type="hidden" id="approve-id">
            <label class="text-muted text-sm">Assign To:</label>
            <select id="assign-select"></select>
            <button onclick="confirmAssign()" class="btn btn-success w-full" style="margin-top: 1rem;">Confirm Assignment</button>
            <button onclick="closeModal('approve-modal')" class="btn btn-ghost w-full" style="margin-top: 0.5rem;">Cancel</button>
        </div>
    </div>

    <script>
        const SB_URL = 'https://bzrkbjjgymdbbwpatfct.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6cmtiampneW1kYmJ3cGF0ZmN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyOTcyNjcsImV4cCI6MjA4NTg3MzI2N30.Icv1daEp7NophE_ktPl2G1EgDP6awo0tyV14yh3Q4Sw';
        const sbClient = window.supabase.createClient(SB_URL, SB_KEY);

        const TEAM = [
            { id: 1, name: "Pema Ugyen", avatar: "üë®‚Äçüíº", cid: "11107008201", role: "LEADER" },
            { id: 2, name: "Jamphel", avatar: "üë®‚Äçüíª", cid: "11302003634", role: "MEMBER" },
            { id: 3, name: "Kuenley", avatar: "üë©‚Äçüíª", cid: "11006001849", role: "MEMBER" },
            { id: 4, name: "Laxmi", avatar: "üë®‚Äçüî¨", cid: "11103002151", role: "MEMBER" },
            { id: 5, name: "Ngawang", avatar: "üë©", cid: "10801003243", role: "MEMBER" }
        ];

        const STATE = { user: null, page: 'overview', createMode: 'task', selectedAvatar: null };
        let refreshInterval;

        window.onload = () => {
            lucide.createIcons();
            const savedId = localStorage.getItem('slbd_uid');
            if (savedId) {
                const user = TEAM.find(u => u.id === parseInt(savedId));
                if (user) { STATE.user = user; initApp(); return; }
            }
            renderLoginView();
        };

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        function startAutoSync() {
            if(refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(() => { if(STATE.user) renderPage(STATE.page, true); }, 8000); 
        }

        function renderLoginView() {
            document.getElementById('app-loader').classList.add('hidden');
            document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('avatar-container').innerHTML = TEAM.map(u => `
                <div class="avatar-card" onclick="selectAvatar(${u.id}, this)">
                    <div style="font-size: 3rem;">${u.avatar}</div>
                    <div class="font-bold text-sm mt-3">${u.name.split(' ')[0]}</div>
                    <div class="text-xs text-muted">${u.role}</div>
                </div>
            `).join('');
        }

        function selectAvatar(id, el) {
            document.querySelectorAll('.avatar-card').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            STATE.selectedAvatar = TEAM.find(u => u.id === id);
            document.getElementById('auth-box').classList.remove('hidden');
            document.getElementById('cid-input').value = '';
            document.getElementById('cid-input').focus();
        }

        function login() {
            if (document.getElementById('cid-input').value === STATE.selectedAvatar.cid) {
                STATE.user = STATE.selectedAvatar;
                localStorage.setItem('slbd_uid', STATE.user.id);
                initApp();
            } else {
                document.getElementById('login-err').innerText = "‚ùå Invalid CID";
            }
        }

        function handleLogout() {
            if(confirm('Logout?')) {
                localStorage.removeItem('slbd_uid');
                clearInterval(refreshInterval);
                location.reload();
            }
        }

        function initApp() {
            document.getElementById('app-loader').classList.add('hidden');
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
            document.getElementById('user-display').innerText = STATE.user.name.split(' ')[0];
            
            const links = [
                { id: 'overview', icon: 'layout-dashboard', label: 'Overview' },
                { id: 'tasks', icon: 'check-square', label: 'Tasks' },
                { id: 'attendance', icon: 'calendar', label: 'Attendance' },
                { id: 'decisions', icon: 'file-text', label: 'Decisions' },
                { id: 'collab', icon: 'users', label: 'Not Yet' }
            ];
            
            if(STATE.user.role === 'LEADER') links.push({ id: 'team', icon: 'crown', label: 'God Mode' });

            const renderNav = (target) => {
                document.getElementById(target).innerHTML = links.map(l => `
                    <div class="${target === 'mobile-nav' ? 'mobile-nav-item' : 'nav-item'}" id="${target === 'mobile-nav' ? 'm-' : ''}nav-${l.id}" onclick="setPage('${l.id}')">
                        <i data-lucide="${l.icon}" size="${target === 'mobile-nav' ? 24 : 20}"></i> 
                        <span>${l.label}</span>
                    </div>
                `).join('');
            };

            renderNav('sidebar-links');
            renderNav('mobile-nav');
            setPage('overview');
            startAutoSync();
        }

        function setPage(page) {
            STATE.page = page;
            document.querySelectorAll('.nav-item, .mobile-nav-item').forEach(e => e.classList.remove('active'));
            document.querySelectorAll(`#nav-${page}, #m-nav-${page}`).forEach(e => e.classList.add('active'));
            document.getElementById('page-title').innerText = page === 'team' ? 'Team God Mode' : (page === 'collab' ? 'Not Yet' : page.charAt(0).toUpperCase() + page.slice(1));
            renderPage(page, false);
        }

        async function renderPage(page, silent) {
            const content = document.getElementById('content-area');
            if(!silent) content.innerHTML = '<div class="text-center p-10 text-muted"><div class="spinner" style="margin: 0 auto;"></div><br>Loading...</div>';
            
            try {
                if(page === 'overview') await renderOverview(content);
                else if(page === 'tasks') await renderTasks(content);
                else if(page === 'attendance') await renderAttendance(content);
                else if(page === 'decisions') await renderDecisions(content);
                else if(page === 'collab') await renderCollab(content);
                else if(page === 'team') await renderTeam(content);
                if(!silent) lucide.createIcons();
            } catch(e) {
                if(!silent) content.innerHTML = `<div class="text-danger text-center">Error: ${e.message}</div>`;
            }
        }

        // --- VIEWS ---
        
        async function renderOverview(container) {
            // Weekly Calculation Logic
            const todayDate = new Date();
            const startOfWeek = new Date(todayDate.setDate(todayDate.getDate() - todayDate.getDay()));
            
            // Fetch All
            const { data: tasks } = await sbClient.from('tasks').select('*');
            const { data: attendance } = await sbClient.from('attendance').select('*');
            
            // Chart Data (This Week Only)
            const labels = TEAM.map(u => u.name.split(' ')[0]);
            const weekTasks = tasks.filter(t => new Date(t.created_at) >= startOfWeek);
            const dataDone = TEAM.map(u => weekTasks.filter(t => t.assignee_id === u.id && t.status === 'Done').length);
            const dataOngoing = TEAM.map(u => weekTasks.filter(t => t.assignee_id === u.id && t.status === 'Ongoing').length);

            container.innerHTML = `
                <div class="card p-4 mb-4" style="height: 280px;">
                    <h4 class="font-bold mb-2 text-sm text-muted">Weekly Performance</h4>
                    <canvas id="overviewChart"></canvas>
                </div>
                
                <h3 class="font-bold mb-3">Today's Focus</h3>
                <div class="grid" style="gap:10px;">
                    ${tasks.filter(t => t.status === 'Ongoing' && (STATE.user.role === 'LEADER' || t.assignee_id === STATE.user.id)).map(t => `
                        <div class="card p-3">
                            <div class="font-bold text-sm">${t.task_title}</div>
                            <div class="flex gap-2 mt-1">
                                <span class="badge badge-${t.priority}">${t.priority}</span>
                                <span class="text-xs text-muted">Due: ${t.due_date || 'N/A'}</span>
                            </div>
                        </div>
                    `).join('') || '<div class="text-muted text-center text-sm">No active focus tasks.</div>'}
                </div>
            `;

            new Chart(document.getElementById('overviewChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Done', data: dataDone, backgroundColor: '#10B981' },
                        { label: 'Ongoing', data: dataOngoing, backgroundColor: '#3B82F6' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
            });
        }

        async function renderTasks(container) {
            let query = sbClient.from('tasks').select('*, users!assignee_id(name)').order('created_at', {ascending: false});
            if(STATE.user.role === 'MEMBER') query = query.or(`assignee_id.eq.${STATE.user.id},creator_id.eq.${STATE.user.id}`);
            const { data: tasks } = await query;

            // Grouping
            const today = new Date().toISOString().split('T')[0];
            const focusTasks = tasks.filter(t => t.due_date === today || t.status === 'Ongoing');
            const otherTasks = tasks.filter(t => !focusTasks.includes(t));

            const renderCard = (t) => `
                <div class="card p-4 mb-3">
                    <div class="flex" style="justify-content: space-between; margin-bottom: 0.5rem;">
                        <h4 class="font-bold">${t.task_title}</h4>
                        <div class="flex gap-2">
                            <span class="badge badge-${t.priority}">${t.priority}</span>
                            <span class="badge" style="background:rgba(255,255,255,0.1);">${t.status}</span>
                        </div>
                    </div>
                    <p class="text-sm text-muted mb-2">${t.description || ''}</p>
                    ${renderTags(t.tagged_members)}
                    <div class="text-xs text-muted mt-2">Due: ${t.due_date || '-'}</div>
                    <div class="flex gap-2 mt-3">
                        ${t.status === 'Ongoing' ? `<button onclick="updateStatus('${t.id}', 'Done')" class="btn btn-success btn-sm">Done</button>` : ''}
                        ${t.status === 'Waiting' && STATE.user.role === 'LEADER' ? `<button onclick="openApprove('${t.id}')" class="btn btn-primary btn-sm">Approve</button>` : ''}
                        ${STATE.user.role === 'LEADER' ? `<button onclick="deleteItem('tasks', '${t.id}')" class="btn btn-danger btn-sm"><i data-lucide="trash-2" size="14"></i></button>` : ''}
                    </div>
                </div>
            `;

            container.innerHTML = `
                <input type="text" placeholder="Search tasks..." onkeyup="filterList(this)" style="margin-bottom:1rem;">
                <h4 class="font-bold mb-2 text-primary">üî• Focus (Today & Active)</h4>
                ${focusTasks.length ? focusTasks.map(renderCard).join('') : '<div class="text-muted text-sm mb-4">Nothing urgent.</div>'}
                
                <details>
                    <summary>üìÇ Backlog / Future (${otherTasks.length})</summary>
                    <div class="mt-2">${otherTasks.map(renderCard).join('')}</div>
                </details>
            `;
        }

        async function renderDecisions(container) {
            const { data: items } = await sbClient.from('decisions').select('*, users!proposed_by(name)').order('created_at', {ascending: false});
            container.innerHTML = `
                <input type="text" placeholder="Search decisions..." onkeyup="filterList(this)" style="margin-bottom:1rem;">
                ${items.map(d => `
                <div class="card p-4 mb-3 filter-item">
                    <div class="flex" style="justify-content: space-between;">
                        <h4 class="font-bold">${d.subject}</h4>
                        ${d.is_verified ? '<span class="text-success text-xs font-bold">Verified ‚úÖ</span>' : '<span class="text-warning text-xs">Pending</span>'}
                    </div>
                    <p class="text-sm text-muted mt-1">${d.details}</p>
                    ${renderTags(d.tagged_members)}
                    <div class="text-xs text-muted mt-2">By: ${d.users.name.split(' ')[0]}</div>
                    <div class="flex gap-2 mt-2">
                        ${!d.is_verified && STATE.user.role === 'LEADER' ? `<button onclick="verifyDecision('${d.id}')" class="btn btn-success btn-sm">Verify</button>` : ''}
                        ${STATE.user.role === 'LEADER' ? `<button onclick="deleteItem('decisions', '${d.id}')" class="btn btn-danger btn-sm"><i data-lucide="trash-2" size="14"></i></button>` : ''}
                    </div>
                </div>`).join('')}
            `;
        }

        async function renderCollab(container) { // "Not Yet"
            const { data: items } = await sbClient.from('opportunities').select('*, users!posted_by(name)').order('created_at', {ascending: false});
            container.innerHTML = `
                <input type="text" placeholder="Search opportunities..." onkeyup="filterList(this)" style="margin-bottom:1rem;">
                ${items.map(o => `
                <div class="card p-4 mb-3 filter-item">
                    <h4 class="font-bold">${o.title}</h4>
                    <p class="text-sm text-muted mt-1">${o.description || ''}</p>
                    ${renderTags(o.tagged_members)}
                    <div class="text-xs text-muted mt-2">By: ${o.users.name.split(' ')[0]}</div>
                    ${STATE.user.role === 'LEADER' ? `<button onclick="deleteItem('opportunities', '${o.id}')" class="btn btn-danger btn-sm mt-2"><i data-lucide="trash-2" size="14"></i></button>` : ''}
                </div>`).join('')}
            `;
        }

        async function renderAttendance(container) {
            const today = new Date().toISOString().split('T')[0];
            const { data: myAtt } = await sbClient.from('attendance').select('*').eq('user_id', STATE.user.id).eq('date', today).single();
            const { data: history } = await sbClient.from('attendance').select('*, users(name, avatar)').order('date', {ascending: false}).limit(30);

            container.innerHTML = `
                <div class="card p-4 flex mb-4" style="justify-content: space-between; align-items: center; border: 1px solid var(--primary);">
                    <div><div class="font-bold">Today</div><div class="text-xs text-muted">${today}</div></div>
                    ${myAtt ? `<span class="btn btn-success" style="pointer-events: none;">‚úÖ Present</span>` : `<button onclick="markPresent()" class="btn btn-primary">Mark Present</button>`}
                </div>
                
                <details>
                    <summary>üìú History Log</summary>
                    <div class="card p-0" style="overflow: hidden; max-height: 300px; overflow-y: auto;">
                        ${history.map(h => `
                            <div class="p-3 flex" style="justify-content: space-between; border-bottom: 1px solid var(--border);">
                                <div class="flex items-center gap-2">
                                    <span>${h.users.avatar}</span>
                                    <div><div class="text-sm font-bold">${h.users.name.split(' ')[0]}</div><div class="text-xs text-muted">${h.date}</div></div>
                                </div>
                                <span class="text-success text-xs font-bold">Present</span>
                            </div>
                        `).join('')}
                    </div>
                </details>
            `;
        }

        async function renderTeam(container) { // God Mode
            // Show ONLY tasks as requested in "god mode only show task"
            const { data: users } = await sbClient.from('users').select('*').neq('role', 'LEADER');
            const { data: tasks } = await sbClient.from('tasks').select('*');

            container.innerHTML = `<div class="grid" style="gap: 1rem;">
                ${users.map(u => {
                    const uTasks = tasks.filter(t => t.assignee_id === u.id);
                    return `
                        <div class="card p-4">
                            <div class="flex items-center gap-3 mb-3 pb-3 border-b border-white/10">
                                <div class="text-2xl">${u.avatar}</div>
                                <div class="font-bold">${u.name}</div>
                            </div>
                            <div class="text-xs font-bold text-muted mb-2">ASSIGNED TASKS:</div>
                            ${uTasks.length ? uTasks.map(t => `
                                <div class="flex justify-between items-center mb-1 p-2 rounded bg-white/5">
                                    <span class="text-sm">${t.task_title}</span>
                                    <span class="badge badge-${t.status === 'Ongoing' ? 'Urgent' : 'Normal'}">${t.status}</span>
                                </div>
                            `).join('') : '<div class="text-xs italic text-muted">No tasks assigned</div>'}
                        </div>
                    `;
                }).join('')}
            </div>`;
        }

        // --- UTILS ---
        function renderTags(ids) {
            if(!ids || ids.length === 0) return '';
            return `<div class="flex gap-1 mt-2 flex-wrap">
                ${ids.map(id => {
                    const u = TEAM.find(x => x.id === id);
                    return u ? `<span class="text-xs" style="background:rgba(59,130,246,0.2); color:#93C5FD; padding:2px 6px; border-radius:4px;">@${u.name.split(' ')[0]}</span>` : '';
                }).join('')}
            </div>`;
        }

        function filterList(input) {
            const filter = input.value.toUpperCase();
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                const txt = card.innerText || card.textContent;
                card.style.display = txt.toUpperCase().indexOf(filter) > -1 ? "" : "none";
            });
        }

        // --- ACTIONS ---
        function setCreateMode(mode) {
            STATE.createMode = mode;
            ['task','decision','opp'].forEach(m => document.getElementById(`btn-mode-${m}`).className = 'btn btn-ghost text-xs');
            document.getElementById(`btn-mode-${mode}`).className = 'btn btn-primary text-xs';
            document.getElementById('task-fields').classList.toggle('hidden', mode !== 'task');
            document.getElementById('tag-label').innerText = mode === 'task' ? 'ASSIGN TO / TAG:' : 'TAG MEMBERS:';
            
            document.getElementById('tag-list').innerHTML = TEAM.filter(u => u.id !== STATE.user.id).map(u => `
                <label class="tag-row">
                    <input type="checkbox" value="${u.id}" class="tag-input">
                    <span style="font-size:1.5rem">${u.avatar}</span> 
                    <span class="text-sm">${u.name.split(' ')[0]}</span>
                </label>
            `).join('');
        }

        async function submitCreate() {
            const title = document.getElementById('create-title').value;
            const desc = document.getElementById('create-desc').value;
            if(!title) return showToast('‚ùå Title required');

            const tags = Array.from(document.querySelectorAll('.tag-input:checked')).map(cb => parseInt(cb.value));
            const isLeader = STATE.user.role === 'LEADER';
            
            let error;
            if(STATE.createMode === 'task') {
                // Leader Logic
                const mainAssignee = (tags.length > 0) ? tags[0] : null; 
                const status = (isLeader && mainAssignee) ? 'Ongoing' : 'Waiting';
                const priority = document.getElementById('create-priority').value;
                const cat = document.getElementById('create-category').value; // Using project_name as category column

                const { error: e } = await sbClient.from('tasks').insert({
                    task_title: title, description: desc,
                    priority: priority, project_name: cat,
                    due_date: document.getElementById('create-date').value,
                    creator_id: STATE.user.id, status: status, 
                    assignee_id: mainAssignee, tagged_members: tags
                });
                error = e;
            } else if (STATE.createMode === 'decision') {
                const isVerified = isLeader;
                const verifiedBy = isLeader ? STATE.user.id : null;
                const { error: e } = await sbClient.from('decisions').insert({
                    subject: title, details: desc, proposed_by: STATE.user.id, tagged_members: tags,
                    is_verified: isVerified, verified_by: verifiedBy
                });
                error = e;
            } else {
                const { error: e } = await sbClient.from('opportunities').insert({
                    title: title, description: desc,
                    posted_by: STATE.user.id, tagged_members: tags
                });
                error = e;
            }

            if(error) showToast('‚ùå Error: ' + error.message);
            else { closeModal('create-modal'); renderPage(STATE.page, true); showToast('‚úÖ Created!'); }
        }

        async function confirmAssign() {
            const tid = document.getElementById('approve-id').value;
            const aid = document.getElementById('assign-select').value;
            await sbClient.from('tasks').update({ status: 'Ongoing', assignee_id: aid }).eq('id', tid);
            closeModal('approve-modal'); renderPage('tasks', true);
            showToast('‚úÖ Assigned');
        }

        async function markPresent() {
            await sbClient.from('attendance').insert({ user_id: STATE.user.id, date: new Date().toISOString().split('T')[0] });
            renderPage('attendance', true);
            showToast('‚úÖ Checked In');
        }

        async function updateStatus(id, status) {
            await sbClient.from('tasks').update({ status: status, completed_at: new Date().toISOString() }).eq('id', id);
            renderPage('tasks', true);
            showToast('‚úÖ Updated');
        }

        async function verifyDecision(id) {
            await sbClient.from('decisions').update({ is_verified: true, verified_by: STATE.user.id }).eq('id', id);
            renderPage('decisions', true);
            showToast('‚úÖ Verified');
        }

        async function deleteItem(table, id) {
            if(!confirm('Delete?')) return;
            await sbClient.from(table).delete().eq('id', id);
            renderPage(STATE.page, true);
            showToast('üóëÔ∏è Deleted');
        }

        function openCreateModal() { 
            document.getElementById('create-modal').classList.remove('hidden'); 
            document.getElementById('create-title').value = '';
            document.getElementById('create-desc').value = '';
            setCreateMode('task'); 
        }
        function openApprove(id) {
            document.getElementById('approve-id').value = id;
            document.getElementById('assign-select').innerHTML = TEAM.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
            document.getElementById('approve-modal').classList.remove('hidden');
        }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    </script>
</body>
</html>
